<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPIs Seminuevos - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .animated-icon {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px; /* Added for horizontal scrollbar */
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.5);
            border-radius: 3px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto; 
        }
        
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 10px; /* Reduced padding */
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        th {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 20; /* Increased z-index for fixed header */
        }
        
        /* Estilos para la primera columna (KPI) fija */
        #tableBody td:first-child,
        #tableHeader th:first-child,
        #singleTableBody td:first-child,
        #singleTableHeader th:first-child {
            position: sticky;
            left: 0;
            background: rgba(15, 23, 42, 0.9); /* Dark background for visibility */
            z-index: 15; /* Ensure it's above normal cells but below sticky header */
            border-right: 1px solid rgba(255, 255, 255, 0.2); /* Stronger border for separation */
        }

        #tableHeader th:first-child,
        #singleTableHeader th:first-child {
             /* When both are sticky, the top-left corner needs higher z-index */
            z-index: 25; 
        }

        td {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem; /* text-xs equivalent */
        }
        
        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .highest-value {
            background: rgba(34, 197, 94, 0.2) !important;
            color: #22c55e !important;
            font-weight: 600;
            border: 1px solid rgba(34, 197, 94, 0.3) !important;
        }

        /* Clases para la tendencia */
        .tendencia-roja {
            color: #ef4444 !important; /* Rojo */
            font-weight: 600;
        }

        .tendencia-amarilla {
            color: #f59e0b !important; /* Naranja/Amarillo */
            font-weight: 600;
        }

        .tendencia-verde {
            color: #22c55e !important; /* Verde */
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="glass-effect border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://api.grupodaytona.com/files/images/full-xzLxpZqXUE-1728519042236.png" alt="Grupo Daytona" class="w-10 h-10 rounded-lg object-contain bg-white/10 p-1">
                    <div>
                        <h1 class="text-xl font-bold text-white">Grupo Daytona</h1>
                        <p class="text-sm text-gray-300">Dashboard KPIs Seminuevos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden md:flex items-center space-x-2 text-gray-300">
                        <i class="fas fa-clock text-sm"></i>
                        <span class="text-sm" id="currentTime"></span>
                    </div>
                    
                    <a href="https://flozanol.github.io/daytona-autos-nuevos-kpis/" 
                       target="_blank"
                       class="hidden md:flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg text-white text-sm font-medium hover:from-blue-600 hover:to-purple-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-exchange-alt text-sm"></i>
                        <span>Dashboard Autos Nuevos</span>
                        <i class="fas fa-external-link-alt text-xs"></i>
                    </a>
                    
                    <button onclick="window.open('https://flozanol.github.io/daytona-autos-nuevos-kpis/', '_blank')"
                            class="md:hidden flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg text-white hover:from-blue-600 hover:to-purple-600 transition-all duration-300 shadow-lg">
                        <i class="fas fa-exchange-alt text-sm"></i>
                    </button>
                    
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="text-center mb-12">
            <div class="flex items-center justify-center mb-4">
                <div class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full text-white text-sm font-semibold mr-4">
                    <i class="fas fa-car mr-2"></i>
                    AUTOS SEMINUEVOS
                </div>
                <div class="text-gray-400 text-sm">
                    <a href="https://flozanol.github.io/daytona-autos-nuevos-kpis/" 
                       target="_blank" 
                       class="hover:text-blue-400 transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-1"></i>
                        Ver Dashboard Autos Nuevos
                    </a>
                </div>
            </div>
            <h2 class="text-5xl font-bold gradient-text mb-4">
                Dashboard KPIs Seminuevos Daytona
            </h2>
            <p class="text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed">
                An√°lisis en tiempo real de indicadores clave de rendimiento para autos seminuevos en todas las agencias
            </p>
        </div>

        <div class="flex justify-center space-x-6 mb-12">
            <button onclick="loadDemo()" class="btn-primary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-play mr-3"></i>
                Cargar Demo
            </button>
            <button onclick="connectToAPI()" class="btn-secondary px-8 py-4 rounded-xl text-white font-semibold text-lg shadow-2xl">
                <i class="fas fa-link mr-3 animated-icon"></i>
                Conectar API
            </button>
        </div>

        <div id="status" class="hidden mb-8">
            <div class="glass-effect rounded-xl p-4 border-l-4">
                <div class="flex items-center">
                    <i id="statusIcon" class="text-2xl mr-3"></i>
                    <p id="statusText" class="text-lg font-medium text-white"></p>
                </div>
            </div>
        </div>

        <div id="results" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-chart-bar text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalKPIs">0</h3>
                    <p class="text-gray-300 font-medium">Total KPIs</p>
                </div>
                
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-building text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalAgencies">10</h3>
                    <p class="text-gray-300 font-medium">Agencias Activas</p>
                </div>
                
                <div class="stat-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-calendar text-white text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-2" id="totalPeriods">0</h3>
                    <p class="text-gray-300 font-medium">Per√≠odos Seleccionados</p>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-8 mb-8 card-hover">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-store text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">Agencias Conectadas</h3>
                        <p class="text-gray-300">Estado de conexi√≥n de las agencias</p>
                    </div>
                </div>
                <div id="agenciesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            
            <div class="glass-effect rounded-2xl p-8 mb-8 card-hover">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center mr-4">
                        <i class="fas fa-sliders-h text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-white">Configuraci√≥n del An√°lisis</h3>
                        <p class="text-gray-300">Personaliza tu comparaci√≥n</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-building mr-2 text-blue-400"></i>
                                <span id="agencyCount">Agencias (0/10)</span>
                            </label>
                            <div class="space-x-2">
                                <button onclick="selectAllAgencies()" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all">
                                    Todas
                                </button>
                                <button onclick="deselectAllAgencies()" class="px-3 py-1 bg-red-500/20 text-red-400 rounded-lg text-sm hover:bg-red-500/30 transition-all">
                                    Ninguna
                                </button>
                            </div>
                        </div>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="agencyCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-400"></i>
                            <span id="monthCount">Meses (0)</span>
                        </label>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="monthCheckboxes" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 mt-8">
                    <button onclick="updateAnalysis()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualizar An√°lisis
                    </button>
                    <button onclick="refreshData()" class="px-6 py-3 bg-blue-500/20 text-blue-400 rounded-xl font-semibold hover:bg-blue-500/30 transition-all">
                        <i class="fas fa-refresh mr-2"></i>
                        Refrescar Datos
                    </button>
                </div>
            </div>
            
            <div class="glass-effect rounded-2xl p-8 card-hover mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-table text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">An√°lisis Detallado de KPIs</h3>
                            <p class="text-gray-300">Vista completa de todos los indicadores por agencia</p>
                        </div>
                    </div>
                    <button onclick="exportMainTableToExcel()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Exportar a Excel
                    </button>
                </div>
                
                <div class="overflow-x-auto overflow-y-auto max-h-96 bg-white/5 border border-white/10 rounded-xl scrollbar-thin"> 
                    <table class="min-w-full text-xs"> 
                        <thead>
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>

                <div class="mt-8 pt-8 border-t border-white/10" id="pieChartContainer">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-red-500 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-chart-pie text-white text-lg"></i>
                        </div>
                        <h4 class="text-xl font-bold text-white">Distribuci√≥n de Unidades Facturadas por Agencia</h4>
                    </div>
                    <canvas id="unidadesFacturadasPieChart" class="max-h-96"></canvas>
                    <p class="text-gray-400 text-sm mt-2 text-center">Muestra la proporci√≥n de Unidades Facturadas por cada agencia seleccionada en el per√≠odo promedio.</p>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-8 card-hover mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-chart-pie text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">An√°lisis Individual por Agencia</h3>
                            <p class="text-gray-300">Comparaci√≥n mensual de una agencia espec√≠fica</p>
                        </div>
                    </div>
                    <button onclick="exportSingleTableToExcel()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30 transition-all flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Exportar a Excel
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-building mr-2 text-orange-400"></i>
                            Seleccionar Agencia
                        </label>
                        <select id="singleAgencySelect" onchange="updateSingleAgencyMonths()" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">Selecciona una agencia...</option>
                        </select>
                    </div>

                    <div class="space-y-4">
                        <label class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-400"></i>
                            <span id="singleMonthCount">Meses (0)</span>
                        </label>
                        <div class="max-h-64 overflow-y-auto bg-white/5 border border-white/10 rounded-xl p-4 scrollbar-thin">
                            <div id="singleMonthCheckboxes" class="space-y-2">
                                <p class="text-gray-400 text-sm">Primero selecciona una agencia</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mb-8">
                    <button onclick="generateSingleAgencyTable()" class="btn-primary px-8 py-3 rounded-xl text-white font-semibold text-lg">
                        <i class="fas fa-chart-bar mr-3"></i>
                        Generar An√°lisis Individual
                    </button>
                </div>

                <div id="singleAgencyTableContainer" class="hidden">
                    <div class="overflow-auto max-h-96 bg-white/5 border border-white/10 rounded-xl scrollbar-thin">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr id="singleTableHeader"></tr>
                            </thead>
                            <tbody id="singleTableBody" class="divide-y divide-white/10"></tbody>
                        </table>
                    </div>

                    <div class="mt-8 pt-8 border-t border-white/10" id="lineChartContainer">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-white text-lg"></i>
                            </div>
                            <h4 class="text-xl font-bold text-white">Unidades Facturadas Mensual - <span id="selectedAgencyForLineChart"></span></h4>
                        </div>
                        <canvas id="unidadesFacturadasLineChart" class="max-h-96"></canvas>
                        <p class="text-gray-400 text-sm mt-2 text-center">Muestra la tendencia mensual de Unidades Facturadas para la agencia seleccionada.</p>
                    </div>
                </div>
            </div>

        <footer class="mt-16 text-center">
            <div class="glass-effect rounded-2xl p-6">
                <div class="flex items-center justify-center space-x-6 text-gray-300">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-shield-alt text-green-400"></i>
                        <span>Datos Seguros</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-sync text-blue-400"></i>
                        <span>Tiempo Real</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-chart-line text-red-400"></i>
                        <span>Analytics Avanzados</span>
                    </div>
                </div>
                <p class="text-gray-400 text-sm mt-4">
                    ¬© 2025 Grupo Daytona - Dashboard KPIs Seminuevos
                </p>
            </div>
        </footer>
    </div>

<script>
// Variables globales
let loadedData = [];
let selectedAgencies = [];
let selectedMonths = [];
let allKPIs = [];
let allMonths = [];
let singleSelectedAgency = '';
let singleSelectedMonths = [];

// API Configuration - CONFIGURADO CON TU SPREADSHEET_ID
const API_KEY = "TU_API_KEY_AQUI"; // REEMPLAZA CON TU API KEY REAL
const SPREADSHEET_ID = "TU_SPREADSHEET_ID_AQUI"; // REEMPLAZA CON EL ID DE TU GOOGLE SHEET DE SEMINUEVOS

// Variables para los gr√°ficos
let unidadesFacturadasPieChart;
let unidadesFacturadasLineChart;
const KPI_UNIDADES_FACTURADAS = 'Unidades Facturadas'; // Nombre exacto del KPI para los gr√°ficos

// Definir el orden cronol√≥gico de los meses
const chronologicalMonthOrder = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

console.log('üöÄ Dashboard Seminuevos iniciado');

// Funci√≥n para formatear n√∫meros con comas
function formatNumber(value) {
    if (value === null || value === undefined || value === 'N/A') {
        return 'N/A';
    }
    
    // Convertir a n√∫mero si es string
    const num = typeof value === 'string' ? parseFloat(value) : value;
    
    if (isNaN(num)) {
        return 'N/A';
    }
    
    // Formatear con comas como separador de miles
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

// Funci√≥n para encontrar el valor m√°s alto en una fila (excluyendo N/A)
function findHighestValue(values) {
    const numericValues = values
        .filter(val => val !== 'N/A' && !isNaN(val) && val !== null && val !== undefined)
        .map(val => typeof val === 'string' ? parseFloat(val) : val);
    if (numericValues.length === 0) return null;
    return Math.max(...numericValues);
}

// Actualizar reloj
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const clockElement = document.getElementById('currentTime');
    if (clockElement) {
        clockElement.textContent = timeString;
    }
}
setInterval(updateClock, 1000);
updateClock();

// FUNCI√ìN PRINCIPAL: Cargar Demo
function loadDemo() {
    console.log('üéØ Cargando demo de seminuevos...');
    showStatus('loading', 'Cargando datos de demostraci√≥n...');
    
    // KPIs espec√≠ficos para seminuevos (aseg√∫rate de incluir 'Unidades Facturadas')
    const kpis = [
        'Unidades Facturadas', 'Ventas Seminuevos', 'Leads Seminuevos', 'Test Drive Seminuevos', 'Conversi√≥n % Seminuevos', 
        'Financiamientos Seminuevos', 'Seguros Seminuevos', 'Cotizaciones Seminuevos', 'Seguimientos Seminuevos', 
        'Llamadas Seminuevos', 'Satisfacci√≥n Seminuevos', 'Tiempo Inventario', 'Post-Venta Seminuevos', 
        'Garant√≠as Seminuevos', 'Accesorios Seminuevos', 'Cross-Selling Seminuevos', 'Up-Selling Seminuevos', 
        'Referidos Seminuevos', 'ROI Marketing Seminuevos', 'Costo Lead Seminuevos', 'Valor Cliente Seminuevos',
        'Inventario Seminuevos', 'Tr√°fico Digital Seminuevos', 'Tr√°fico Showroom Seminuevos', 
        'Ventas Netas Seminuevos', 'Ganancia Bruta Seminuevos', 'Margen % Seminuevos', 'Costo de Adquisici√≥n', 
        'Rotaci√≥n Inventario', 'Recompras Seminuevos', 'NPS Seminuevos'
    ];
    // Agencias de seminuevos
    const agencies = [
        { name: 'Honda Seminuevos', base: 180 },
        { name: 'KIA Seminuevos', base: 160 },
        { name: 'MG Seminuevos', base: 140 },
        { name: 'GWM Seminuevos', base: 120 },
        { name: 'Acura Seminuevos', base: 100 },
        { name: 'Multimarca Del Valle', base: 90 },
        { name: 'Multimarca Interlomas', base: 80 },
        { name: 'Multimarca Cuajimalpa', base: 70 },
        { name: 'Multimarca Iztapalapa', base: 60 },
        { name: 'Premium Seminuevos', base: 50 }
    ];
    // Usar la lista de meses cronol√≥gica definida globalmente
    const months = chronologicalMonthOrder; 

    // Generar datos
    const data = agencies.map(agency => {
        const agencyKPIs = kpis.map(kpiName => {
            const kpi = { name: kpiName };
            months.forEach(month => {
                const variation = (Math.random() - 0.5) * 0.4;
                kpi[month] = Math.max(1, Math.round(agency.base * (1 + variation)));
            });
            // Asegurarse de que "Unidades Facturadas" tenga datos con variaci√≥n para el gr√°fico
            if (kpiName === KPI_UNIDADES_FACTURADAS) {
                months.forEach(month => {
                    const baseValue = agency.base / 2; // Unidades facturadas suelen ser menos que otras m√©tricas
                    kpi[month] = Math.max(5, Math.round(baseValue * (1 + (Math.random() - 0.5) * 0.8))); // Mayor variaci√≥n para demo
                });
            }
            return kpi;
        });

        return {
            agency: agency.name,
            kpis: agencyKPIs,
            // Asegurarse de que los meses est√©n en orden cronol√≥gico para cada agencia
            months: months 
        };
    });
    console.log('‚úÖ Datos demo generados:', data.length, 'agencias');
    
    // Guardar en sessionStorage para persistencia
    sessionStorage.setItem('daytonaDashboardDataSeminuevos', JSON.stringify(data));
    
    // Guardar y mostrar
    loadedData = data;
    displayResults(data);
    showStatus('success', `Demo cargada: ${data.length} agencias, ${kpis.length} KPIs`);
}

// FUNCI√ìN PRINCIPAL: Conectar API REAL
async function connectToAPI() {
    console.log('üöÄ Conectando con Google Sheets...');
    showStatus('loading', 'Conectando con Google Sheets API...');
    
    try {
        // Verificar configuraci√≥n
        if (!SPREADSHEET_ID || SPREADSHEET_ID === "TU_SPREADSHEET_ID_AQUI") {
            throw new Error('‚ö†Ô∏è SPREADSHEET_ID no configurado correctamente');
        }
        if (!API_KEY || API_KEY === "TU_API_KEY_AQUI") {
            throw new Error('‚ö†Ô∏è API_KEY no configurado correctamente');
        }
        
        console.log('üîó Usando Google Sheet ID:', SPREADSHEET_ID);
        // Obtener metadata del spreadsheet
        const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`;
        console.log('üì° Consultando metadata:', metadataUrl);
        const metadataResponse = await fetch(metadataUrl);
        
        if (!metadataResponse.ok) {
            const errorText = await metadataResponse.text();
            console.error('‚ùå Error respuesta metadata:', errorText);
            throw new Error(`Error API: ${metadataResponse.status} - ${metadataResponse.statusText}\n\nVerifica:\n1. SPREADSHEET_ID correcto\n2. Google Sheet p√∫blico\n3. API_KEY v√°lida`);
        }
        
        const metadata = await metadataResponse.json();
        const sheets = metadata.sheets || [];
        const sheetNames = sheets.map(sheet => sheet.properties.title);
        
        console.log('üìä Hojas encontradas:', sheetNames);
        // Agencias esperadas para seminuevos
        const expectedAgencies = [
            'Honda Seminuevos', 'KIA Seminuevos', 'MG Seminuevos', 'GWM Seminuevos', 'Acura Seminuevos',
            'Multimarca Del Valle', 'Multimarca Interlomas', 'Multimarca Cuajimalpa', 'Multimarca Iztapalapa',
            'Premium Seminuevos'
        ];
        
        // Buscar hojas v√°lidas (m√°s flexible)
        const validSheets = sheetNames.filter(name => {
            const nameLower = name.toLowerCase();
            return expectedAgencies.some(agency => {
                const agencyLower = agency.toLowerCase();
                return nameLower === agencyLower || 
                           nameLower.includes(agencyLower.split(' ')[0]) || // Match 'Honda' in 'Honda Seminuevos'
                           agencyLower.includes(nameLower); // Match 'Seminuevos' in 'Honda Seminuevos' from sheet 'Seminuevos'
            });
        });
        
        // Si no encuentra las exactas, usar todas las hojas que no est√©n vac√≠as
        if (validSheets.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron hojas espec√≠ficas, usando todas las hojas disponibles no vac√≠as');
            validSheets.push(...sheetNames.filter(name => name && name.trim() !== ''));
        }
        
        console.log('‚úÖ Hojas v√°lidas seleccionadas:', validSheets);
        if (validSheets.length === 0) {
            throw new Error(`No se encontraron hojas v√°lidas.\nHojas disponibles: ${sheetNames.join(', ')}\nEsperadas: ${expectedAgencies.join(', ')}`);
        }
        
        // Procesar cada hoja
        const loadedAgencies = [];
        const errors = [];
        const successes = [];
        
        for (const sheetName of validSheets) {
            try {
                console.log(`üìã Procesando hoja: ${sheetName}`);
                const range = `${sheetName}!A:Z`;
                const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
                
                console.log(`üì° Consultando datos: ${dataUrl}`);
                
                const dataResponse = await fetch(dataUrl);
                if (!dataResponse.ok) {
                    const errorText = await dataResponse.text();
                    console.error(`‚ùå Error en hoja ${sheetName}:`, errorText);
                    errors.push(`${sheetName}: Error ${dataResponse.status}`);
                    continue;
                }
                
                const sheetData = await dataResponse.json();
                if (!sheetData.values || sheetData.values.length < 2) {
                    errors.push(`${sheetName}: Sin datos suficientes (${sheetData.values?.length || 0} filas)`);
                    continue;
                }
                
                console.log(`üìä Datos obtenidos para ${sheetName}:`, sheetData.values.length, 'filas');
                // Procesar datos reales
                const processedData = processRealSheetData(sheetData.values, sheetName);
                if (processedData && processedData.kpis.length > 0) {
                    loadedAgencies.push(processedData);
                    successes.push(`‚úÖ ${sheetName}: ${processedData.kpis.length} KPIs cargados`);
                    console.log(`‚úÖ ${sheetName} procesada exitosamente`);
                } else {
                    errors.push(`${sheetName}: Error procesando KPIs (datos vac√≠os)`);
                    console.log(`‚ùå ${sheetName} fall√≥ en procesamiento`);
                }
                
            } catch (error) {
                console.error(`‚ùå Error procesando ${sheetName}:`, error);
                errors.push(`${sheetName}: ${error.message}`);
            }
        }
        
        // Mostrar resultados detallados
        console.log('üìä Resumen de carga:');
        console.log('‚úÖ Exitosas:', successes);
        console.log('‚ùå Errores:', errors);
        
        if (loadedAgencies.length > 0) {
            loadedData = loadedAgencies;
            sessionStorage.setItem('daytonaDashboardDataSeminuevos', JSON.stringify(loadedData)); // Guardar en sesi√≥n
            displayResults(loadedAgencies);
            showStatus('success', `Datos REALES cargados: ${loadedAgencies.length} agencias desde Google Sheets`);
            // Mostrar detalles en alert
            const alertMessage = `üéâ ¬°CONEXI√ìN API EXITOSA!\n\nüìä Agencias de Seminuevos cargadas:\n${successes.join('\n')}\n\n‚úÖ ${loadedAgencies.length} agencias conectadas con datos REALES`;
            if (errors.length > 0) {
                alertMessage += `\n\n‚ö†Ô∏è Algunas hojas tuvieron errores:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...' : ''}`;
            }
            
            alert(alertMessage);
        } else {
            throw new Error(`No se pudieron cargar datos reales.\n\nErrores encontrados:\n${errors.join('\n')}\n\nVerifica:\n1. Formato de datos en las hojas\n2. Nombres de columnas\n3. Datos num√©ricos v√°lidos`);
        }
        
    } catch (error) {
        console.error('‚ùå Error completo en API:', error);
        showStatus('error', `Error API: ${error.message}`);
        
        // Mensaje de error m√°s √∫til
        let errorMessage = `‚ùå Error conectando con Google Sheets:\n${error.message}`;
        if (error.message.includes('SPREADSHEET_ID')) {
            errorMessage += '\n\nüí° Tip: Abre tu Google Sheet y copia el ID de la URL';
        } else if (error.message.includes('403') || error.message.includes('404')) {
            errorMessage += '\n\nüí° Tip: Aseg√∫rate de que el Google Sheet sea p√∫blico y la API Key v√°lida';
        }
        
        errorMessage += '\n\n¬øQuieres cargar datos de demostraci√≥n en su lugar?';
        const loadDemoConfirm = confirm(errorMessage);
        if (loadDemoConfirm) {
            loadDemo();
        }
    }
}

// Funci√≥n para procesar datos reales del Google Sheets
function processRealSheetData(values, agencyName) {
    try {
        if (!values || values.length < 2) {
            throw new Error('Datos insuficientes en la hoja');
        }
        
        console.log(`üìä Procesando ${agencyName}:`, values.length, 'filas');
        const headers = values[0];
        const rows = values.slice(1);
        
        console.log(`üîç Headers encontrados:`, headers);
        // Buscar columna de KPI (m√°s flexible)
        let kpiColumnIndex = -1;
        for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            if (header && typeof header === 'string') {
                const headerLower = header.toLowerCase().trim();
                if (headerLower.includes('kpi') || headerLower.includes('indicador') || headerLower.includes('metrica') || headerLower.includes('nombre') || headerLower.includes('concepto') || headerLower === 'a' || i === 0) { 
                    kpiColumnIndex = i;
                    break;
                }
            }
        }
        // Si no encuentra, usar la primera columna
        if (kpiColumnIndex === -1) {
            kpiColumnIndex = 0;
            console.log('‚ö†Ô∏è Usando primera columna como KPI');
        }
        console.log(`üìã Columna KPI encontrada en √≠ndice: ${kpiColumnIndex}`);
        
        // Buscar columnas de meses (m√°s flexible)
        const monthColumns = [];
        const monthNamesLower = chronologicalMonthOrder.map(m => m.toLowerCase());
        const monthShort = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];

        headers.forEach((header, index) => {
            if (header && typeof header === 'string' && index !== kpiColumnIndex) {
                const headerLower = header.toLowerCase().trim();
                let monthMatch = null;

                // Buscar mes completo o abreviado
                for (let i = 0; i < chronologicalMonthOrder.length; i++) {
                    const fullMonthLower = chronologicalMonthOrder[i].toLowerCase();
                    const shortMonthLower = monthShort[i];
                    if (headerLower.includes(fullMonthLower) || headerLower.includes(shortMonthLower)) {
                        monthMatch = chronologicalMonthOrder[i];
                        break;
                    }
                }
                
                if (monthMatch) {
                    monthColumns.push({ index: index, month: monthMatch, originalHeader: header });
                } else if (!isNaN(parseFloat(header)) && isFinite(header)) { // Si es un n√∫mero (ej. "1", "2")
                    const monthIndex = parseInt(header) - 1;
                    if (monthIndex >= 0 && monthIndex < chronologicalMonthOrder.length) {
                        monthColumns.push({ index: index, month: chronologicalMonthOrder[monthIndex], originalHeader: header });
                    }
                }
            }
        });

        // Si no encuentra meses v√°lidos, usar todas las columnas despu√©s de la primera como "meses gen√©ricos"
        if (monthColumns.length === 0) {
            console.log('‚ö†Ô∏è No se encontraron meses espec√≠ficos, usando todas las columnas num√©ricas');
            for (let i = kpiColumnIndex + 1; i < headers.length; i++) {
                if (headers[i]) {
                    monthColumns.push({ index: i, month: headers[i].toString().trim() || `Columna_${i}`, originalHeader: headers[i] });
                }
            }
        }
        
        // Asegurarse de que monthColumns est√©n ordenadas cronol√≥gicamente
        monthColumns.sort((a, b) => {
            const indexA = chronologicalMonthOrder.indexOf(a.month);
            const indexB = chronologicalMonthOrder.indexOf(b.month);
            if (indexA === -1 || indexB === -1) {
                // Si no es un mes cronol√≥gico, mantener el orden original o ordenar alfab√©ticamente si son "Columna_X"
                return a.month.localeCompare(b.month);
            }
            return indexA - indexB;
        });

        console.log(`üìÖ Columnas de meses encontradas y ordenadas:`, monthColumns.map(col => col.month));
        if (monthColumns.length === 0) {
            throw new Error('No se encontraron columnas de datos');
        }
        
        // Funci√≥n para convertir valores
        function parseValue(value) {
            if (value === null || value === undefined || value === '') {
                return 0;
            }
            if (typeof value === 'number') {
                return isNaN(value) ? 0 : value;
            }
            if (typeof value === 'string') {
                let cleanValue = value.toString()
                    .replace(/[\s,\$‚Ç¨¬£¬•‚Çπ]/g, '')
                    .replace(/[()]/g, '')
                    .trim();
                if (cleanValue === '' || cleanValue === '-') {
                    return 0;
                }
                const numValue = parseFloat(cleanValue);
                return isNaN(numValue) ? 0 : numValue;
            }
            return 0;
        }

        // Procesar KPIs
        const kpis = [];
        const availableMonths = monthColumns.map(col => col.month);
        console.log(`üîÑ Procesando ${rows.length} filas de datos...`);
        rows.forEach((row, rowIndex) => {
            if (!row || row.length === 0) return;
            const kpiName = row[kpiColumnIndex];
            if (kpiName && kpiName.toString().trim()) {
                const kpi = { name: kpiName.toString().trim() };
                monthColumns.forEach(monthCol => {
                    const rawValue = row[monthCol.index];
                    const parsedValue = parseValue(rawValue);
                    kpi[monthCol.month] = parsedValue;
                });
                kpis.push(kpi);
            }
        });
        console.log(`‚úÖ ${agencyName} procesada: ${kpis.length} KPIs`);
        return { agency: agencyName, kpis: kpis, months: availableMonths };
    } catch (error) {
        console.error(`‚ùå Error procesando ${agencyName}:`, error);
        return null;
    }
}

// Funci√≥n para mostrar estado (adaptada del c√≥digo original de seminuevos)
function showStatus(type, message) {
    const statusDiv = document.getElementById('status');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');

    const configs = {
        loading: { bg: 'border-blue-500', icon: 'fas fa-spinner fa-spin text-blue-500' },
        success: { bg: 'border-green-500', icon: 'fas fa-check-circle text-green-500' },
        error: { bg: 'border-red-500', icon: 'fas fa-exclamation-triangle text-red-500' }
    };

    const config = configs[type];
    if (config) {
        statusDiv.className = `mb-8 glass-effect rounded-xl p-4 border-l-4 ${config.bg}`;
        statusIcon.className = config.icon;
        statusText.textContent = message;
        statusDiv.classList.remove('hidden');
    }
}

// Funci√≥n para mostrar resultados
function displayResults(data) {
    console.log('üìä Mostrando resultados para', data.length, 'agencias');
    document.getElementById('results').classList.remove('hidden');

    allKPIs = [];
    allMonths = [];
    const agenciesLoaded = [];

    data.forEach(agencyData => {
        agenciesLoaded.push(agencyData.agency);
        agencyData.kpis.forEach(kpi => {
            if (!allKPIs.includes(kpi.name)) {
                allKPIs.push(kpi.name);
            }
        });
        agencyData.months.forEach(month => {
            if (!allMonths.includes(month)) {
                allMonths.push(month);
            }
        });
    });

    // Ordenar allMonths cronol√≥gicamente
    allMonths.sort((a, b) => {
        const indexA = chronologicalMonthOrder.indexOf(a);
        const indexB = chronologicalMonthOrder.indexOf(b);
        if (indexA === -1 || indexB === -1) { 
            return a.localeCompare(b);
        }
        return indexA - indexB;
    });
    // Ordenar todos los KPIs alfab√©ticamente
    allKPIs.sort();

    // Populate agency selector for single agency analysis
    const singleAgencySelect = document.getElementById('singleAgencySelect');
    singleAgencySelect.innerHTML = '<option value="">Selecciona una agencia...</option>';
    agenciesLoaded.sort().forEach(agencyName => { 
        const option = document.createElement('option');
        option.value = agencyName;
        option.textContent = agencyName;
        singleAgencySelect.appendChild(option);
    });

    populateCheckboxes('agencyCheckboxes', agenciesLoaded.sort(), selectedAgencies, 'agency');
    populateCheckboxes('monthCheckboxes', allMonths, selectedMonths, 'month');

    updateAgencyCount();
    updateMonthCount();
    updateTotalKPIs();
}

// Populate checkboxes function
function populateCheckboxes(containerId, items, selectedArray, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = ''; 

    items.forEach(item => { 
        const id = `${type}-${item.replace(/\s/g, '-')}`;
        const isChecked = selectedArray.includes(item);
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'flex items-center';
        checkboxDiv.innerHTML = `
            <input type="checkbox" id="${id}" value="${item}" class="form-checkbox h-5 w-5 text-purple-600 bg-white/10 border-white/20 rounded focus:ring-purple-500" ${isChecked ? 'checked' : ''}>
            <label for="${id}" class="ml-3 text-white text-md cursor-pointer">${item}</label>
        `;
        checkboxDiv.querySelector('input').addEventListener('change', (event) => {
            if (event.target.checked) {
                if (!selectedArray.includes(item)) {
                    selectedArray.push(item);
                }
            } else {
                const index = selectedArray.indexOf(item);
                if (index > -1) {
                    selectedArray.splice(index, 1);
                }
            }
            if (type === 'agency') {
                updateAgencyCount();
            } else if (type === 'month') {
                updateMonthCount();
            } else if (type === 'singleMonth') { 
                document.getElementById('singleMonthCount').textContent = `Meses (${singleSelectedMonths.length})`;
            }
        });
        container.appendChild(checkboxDiv);
    });
}

// Select/Deselect All Agencies
function selectAllAgencies() {
    selectedAgencies = [...loadedData.map(d => d.agency)];
    const sortedAgencies = loadedData.map(d => d.agency).sort(); 
    populateCheckboxes('agencyCheckboxes', sortedAgencies, selectedAgencies, 'agency');
    updateAgencyCount();
}

function deselectAllAgencies() {
    selectedAgencies = [];
    const sortedAgencies = loadedData.map(d => d.agency).sort();
    populateCheckboxes('agencyCheckboxes', sortedAgencies, selectedAgencies, 'agency');
    updateAgencyCount();
}

// Update counts
function updateAgencyCount() {
    document.getElementById('agencyCount').textContent = `Agencias (${selectedAgencies.length}/${loadedData.length})`;
}

function updateMonthCount() {
    document.getElementById('monthCount').textContent = `Meses (${selectedMonths.length})`;
}

function updateTotalKPIs() {
    document.getElementById('totalKPIs').textContent = allKPIs.length;
}

function updatePeriodsCount() {
    document.getElementById('totalPeriods').textContent = selectedMonths.length;
}

// Function to generate random colors for charts
function generateColors(numColors) {
    const colors = [];
    for (let i = 0; i < numColors; i++) {
        const hue = (i * 137.508) % 360; 
        colors.push(`hsla(${hue}, 70%, 60%, 0.7)`); 
    }
    return colors;
}

// Refresh Data function
function refreshData() {
    console.log('üîÑ Refrescando datos...');
    sessionStorage.removeItem('daytonaDashboardDataSeminuevos'); // Clear session storage
    connectToAPI(); // Attempt to connect to API again
}

// Update Main Analysis Table AND Pie Chart
function updateAnalysis() {
    if (selectedAgencies.length === 0 || selectedMonths.length === 0) {
        showStatus('error', 'Selecciona al menos una agencia y un mes para el an√°lisis.');
        document.getElementById('pieChartContainer').classList.add('hidden');
        return;
    }

    showStatus('loading', 'Actualizando an√°lisis principal por agencia...');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');

    // Clear table
    tableHeader.innerHTML = '';
    tableBody.innerHTML = '';

    selectedAgencies.sort();
    selectedMonths.sort((a, b) => {
        return chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b);
    });

    // Create header row dynamically based on selected months
    let headers = ['KPI', ...selectedAgencies, 'Promedio General'];
    if (selectedMonths.length >= 2) {
        headers.push('Tendencia General');
    }
    
    headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        if (headerText === 'Promedio General') { 
            th.classList.add('bg-blue-800/50');
        }
        tableHeader.appendChild(th);
    });

    // Datos para el gr√°fico de pastel
    const pieChartLabels = [];
    const pieChartData = [];

    // Populate table body
    allKPIs.forEach(kpiName => {
        const tr = document.createElement('tr');
        const kpiCell = document.createElement('td');
        kpiCell.textContent = kpiName;
        kpiCell.classList.add('font-medium', 'text-left');
        tr.appendChild(kpiCell);

        const rowAgencyValues = []; 
        
        let firstMonthOverallValue = 0;
        let lastMonthOverallValue = 0;
        let firstMonthOverallCount = 0;
        let lastMonthOverallCount = 0;

        const firstSelectedMonth = selectedMonths[0];
        const lastSelectedMonth = selectedMonths[selectedMonths.length - 1];

        selectedAgencies.forEach(agencyName => {
            const agencyData = loadedData.find(a => a.agency === agencyName);
            let agencyKpiSumForSelectedMonths = 0;
            let agencyKpiCountForSelectedMonths = 0;

            if (agencyData) {
                const kpiData = agencyData.kpis.find(k => k.name === kpiName);
                if (kpiData) {
                    selectedMonths.forEach(month => {
                        const value = kpiData[month];
                        if (typeof value === 'number' && !isNaN(value)) {
                            agencyKpiSumForSelectedMonths += value;
                            agencyKpiCountForSelectedMonths++;

                            if (month === firstSelectedMonth) {
                                firstMonthOverallValue += value;
                                firstMonthOverallCount++;
                            }
                            if (month === lastSelectedMonth) {
                                lastMonthOverallValue += value;
                                lastMonthOverallCount++;
                            }
                        }
                    });
                }
            }
            
            const agencyKpiAvg = agencyKpiCountForSelectedMonths > 0 ? 
                                 agencyKpiSumForSelectedMonths / agencyKpiCountForSelectedMonths : 'N/A';
            
            const td = document.createElement('td');
            td.textContent = formatNumber(agencyKpiAvg);
            
            if (typeof agencyKpiAvg === 'number' && !isNaN(agencyKpiAvg)) {
                rowAgencyValues.push({ value: agencyKpiAvg, element: td });
                if (kpiName === KPI_UNIDADES_FACTURADAS) {
                    pieChartLabels.push(agencyName);
                    pieChartData.push(agencyKpiAvg);
                }
            } else {
                rowAgencyValues.push({ value: 'N/A', element: td }); 
            }
            tr.appendChild(td);
        });

        const numericValuesInRow = rowAgencyValues
            .filter(item => typeof item.value === 'number')
            .map(item => item.value);
        
        if (numericValuesInRow.length > 0) {
            const highestInRow = Math.max(...numericValuesInRow);
            rowAgencyValues.forEach(item => {
                if (item.value === highestInRow) {
                    item.element.classList.add('highest-value');
                }
            });
        }

        const totalNumericValuesInRow = numericValuesInRow.reduce((sum, val) => sum + val, 0);
        const promedioGeneral = numericValuesInRow.length > 0 ? 
                               totalNumericValuesInRow / numericValuesInRow.length : 'N/A';
        const promedioGeneralCell = document.createElement('td');
        promedioGeneralCell.textContent = formatNumber(promedioGeneral);
        promedioGeneralCell.classList.add('bg-blue-800/50'); 
        tr.appendChild(promedioGeneralCell);

        if (selectedMonths.length >= 2) {
            const tendenciaCell = document.createElement('td');
            const firstMonthAvg = firstMonthOverallCount > 0 ? firstMonthOverallValue / firstMonthOverallCount : 'N/A';
            const lastMonthAvg = lastMonthOverallCount > 0 ? lastMonthOverallValue / lastMonthOverallCount : 'N/A';

            if (typeof firstMonthAvg === 'number' && typeof lastMonthAvg === 'number' && firstMonthAvg !== 0) {
                const percentageChange = ((lastMonthAvg - firstMonthAvg) / firstMonthAvg) * 100;
                tendenciaCell.textContent = `${formatNumber(percentageChange)}%`;

                if (percentageChange < 0) {
                    tendenciaCell.classList.add('tendencia-roja');
                } else if (percentageChange >= 0 && percentageChange <= 5) {
                    tendenciaCell.classList.add('tendencia-amarilla');
                } else { 
                    tendenciaCell.classList.add('tendencia-verde');
                }
            } else {
                tendenciaCell.textContent = 'N/A';
            }
            tr.appendChild(tendenciaCell);
        }

        tableBody.appendChild(tr);
    });
    updatePeriodsCount();
    showStatus('success', 'An√°lisis principal actualizado correctamente.');

    // NUEVO: Render Pie Chart
    renderUnidadesFacturadasPieChart(pieChartLabels, pieChartData);
}

// Render Pie Chart
function renderUnidadesFacturadasPieChart(labels, data) {
    const ctx = document.getElementById('unidadesFacturadasPieChart').getContext('2d');

    if (unidadesFacturadasPieChart) {
        unidadesFacturadasPieChart.destroy();
    }

    const totalData = data.reduce((sum, val) => sum + val, 0);
    if (labels.length === 0 || totalData === 0) {
        document.getElementById('pieChartContainer').classList.add('hidden');
        return;
    } else {
        document.getElementById('pieChartContainer').classList.remove('hidden');
    }

    const backgroundColors = generateColors(labels.length); 

    unidadesFacturadasPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'white',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += formatNumber(context.parsed) + ' Unidades';
                            }
                            return label;
                        },
                        afterLabel: function(context) {
                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                            const percentage = (context.parsed / total * 100).toFixed(2);
                            return `(${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Single Agency Analysis AND Line Chart
function updateSingleAgencyMonths() {
    singleSelectedAgency = document.getElementById('singleAgencySelect').value;
    singleSelectedMonths = []; 

    const singleMonthCheckboxesContainer = document.getElementById('singleMonthCheckboxes');
    singleMonthCheckboxesContainer.innerHTML = ''; 

    document.getElementById('lineChartContainer').classList.add('hidden');
    document.getElementById('singleAgencyTableContainer').classList.add('hidden');

    if (!singleSelectedAgency) {
        singleMonthCheckboxesContainer.innerHTML = '<p class="text-gray-400 text-sm">Primero selecciona una agencia</p>';
        document.getElementById('singleMonthCount').textContent = 'Meses (0)';
        return;
    }

    const agencyData = loadedData.find(a => a.agency === singleSelectedAgency);
    if (agencyData) {
        const sortedAgencyMonths = [...agencyData.months].sort((a, b) => {
            const indexA = chronologicalMonthOrder.indexOf(a);
            const indexB = chronologicalMonthOrder.indexOf(b);
            if (indexA === -1 || indexB === -1) {
                 return a.localeCompare(b);
            }
            return indexA - indexB;
        });
        populateCheckboxes('singleMonthCheckboxes', sortedAgencyMonths, singleSelectedMonths, 'singleMonth');
    }
    document.getElementById('singleMonthCount').textContent = `Meses (${singleSelectedMonths.length})`;
}

function generateSingleAgencyTable() {
    if (!singleSelectedAgency || singleSelectedMonths.length === 0) {
        showStatus('error', 'Selecciona una agencia y al menos un mes para el an√°lisis individual.');
        document.getElementById('lineChartContainer').classList.add('hidden');
        document.getElementById('singleAgencyTableContainer').classList.add('hidden');
        return;
    }

    showStatus('loading', `Generando an√°lisis para ${singleSelectedAgency}...`);
    const singleTableHeader = document.getElementById('singleTableHeader');
    const singleTableBody = document.getElementById('singleTableBody');
    const singleAgencyTableContainer = document.getElementById('singleAgencyTableContainer');

    singleTableHeader.innerHTML = '';
    singleTableBody.innerHTML = '';
    singleAgencyTableContainer.classList.remove('hidden');

    const agencyData = loadedData.find(a => a.agency === singleSelectedAgency);
    if (!agencyData) {
        showStatus('error', `No se encontraron datos para la agencia ${singleSelectedAgency}.`);
        document.getElementById('lineChartContainer').classList.add('hidden');
        return;
    }

    singleSelectedMonths.sort((a, b) => {
        return chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b);
    });

    const headers = ['KPI', ...singleSelectedMonths, 'Promedio', 'Tendencia']; 
    headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        if (headerText === 'Promedio') {
            th.classList.add('bg-blue-800/50');
        }
        singleTableHeader.appendChild(th);
    });

    // Datos para el gr√°fico de l√≠neas
    const lineChartLabels = [];
    const lineChartData = [];
    const kpiUnidadesFacturadasData = agencyData.kpis.find(kpi => kpi.name === KPI_UNIDADES_FACTURADAS);
    
    if (kpiUnidadesFacturadasData) {
        singleSelectedMonths.forEach(month => {
            lineChartLabels.push(month);
            lineChartData.push(kpiUnidadesFacturadasData[month] || 0); 
        });
    }

    // Populate table body
    agencyData.kpis.forEach(kpi => {
        const tr = document.createElement('tr');
        const kpiCell = document.createElement('td');
        kpiCell.textContent = kpi.name;
        kpiCell.classList.add('font-medium', 'text-left');
        tr.appendChild(kpiCell);

        const monthlyValueCells = []; 
        const currentMonthValues = []; 

        singleSelectedMonths.forEach(month => {
            const value = kpi[month];
            const td = document.createElement('td');
            td.textContent = formatNumber(value);
            monthlyValueCells.push({ value: value, element: td }); 

            if (typeof value === 'number' && !isNaN(value)) {
                currentMonthValues.push(value); 
            }
            tr.appendChild(td);
        });

        if (currentMonthValues.length > 0) {
            const highestInMonthlyRow = Math.max(...currentMonthValues);
            monthlyValueCells.forEach(item => {
                if (typeof item.value === 'number' && item.value === highestInMonthlyRow) {
                    item.element.classList.add('highest-value'); 
                }
            });
        }

        const sum = currentMonthValues.reduce((acc, val) => acc + val, 0);
        const promedio = currentMonthValues.length > 0 ? sum / currentMonthValues.length : 'N/A';
        const promedioCell = document.createElement('td');
        promedioCell.textContent = formatNumber(promedio);
        promedioCell.classList.add('bg-blue-800/50'); 
        tr.appendChild(promedioCell);

        const tendenciaCell = document.createElement('td');
        if (currentMonthValues.length >= 2) {
            const lastValue = currentMonthValues[currentMonthValues.length - 1];
            const secondLastValue = currentMonthValues[currentMonthValues.length - 2];

            if (typeof lastValue === 'number' && typeof secondLastValue === 'number' && secondLastValue !== 0) {
                const percentageChange = ((lastValue - secondLastValue) / secondLastValue) * 100;
                tendenciaCell.textContent = `${formatNumber(percentageChange)}%`;

                if (percentageChange < 0) {
                    tendenciaCell.classList.add('tendencia-roja');
                } else if (percentageChange >= 0 && percentageChange <= 5) {
                    tendenciaCell.classList.add('tendencia-amarilla');
                } else { 
                    tendenciaCell.classList.add('tendencia-verde');
                }
            } else {
                tendenciaCell.textContent = 'N/A';
            }
        } else {
            tendenciaCell.textContent = 'N/A';
        }
        tr.appendChild(tendenciaCell);

        singleTableBody.appendChild(tr);
    });

    showStatus('success', `An√°lisis individual para ${singleSelectedAgency} generado.`);

    // NUEVO: Render Line Chart
    document.getElementById('selectedAgencyForLineChart').textContent = singleSelectedAgency;
    renderUnidadesFacturadasLineChart(lineChartLabels, lineChartData);
}

// Render Line Chart
function renderUnidadesFacturadasLineChart(labels, data) {
    const ctx = document.getElementById('unidadesFacturadasLineChart').getContext('2d');

    if (unidadesFacturadasLineChart) {
        unidadesFacturadasLineChart.destroy();
    }

    const totalData = data.reduce((sum, val) => sum + val, 0);
    if (labels.length === 0 || totalData === 0) {
        document.getElementById('lineChartContainer').classList.add('hidden');
        return;
    } else {
        document.getElementById('lineChartContainer').classList.remove('hidden');
    }

    unidadesFacturadasLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Unidades Facturadas',
                data: data,
                borderColor: 'rgba(59, 130, 246, 0.8)', 
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'white',
                pointBorderColor: 'rgba(59, 130, 246, 1)',
                pointHoverBackgroundColor: 'rgba(255,255,255,1)',
                pointHoverBorderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${formatNumber(context.parsed.y)} Unidades`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mes',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Unidades',
                        color: 'white'
                    },
                    ticks: {
                        color: 'white',
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Export to Excel for Main Table
function exportMainTableToExcel() {
    if (selectedAgencies.length === 0 || selectedMonths.length === 0) {
        alert('No hay datos para exportar. Por favor, selecciona agencias y meses.');
        return;
    }

    try {
        selectedAgencies.sort();
        selectedMonths.sort((a, b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b));

        let headers = ['KPI', ...selectedAgencies, 'Promedio General'];
        if (selectedMonths.length >= 2) {
            headers.push('Tendencia General');
        }
        const data = [headers];

        allKPIs.forEach(kpiName => { 
            const row = [kpiName];
            const rowAgencyValues = []; 
            
            let firstMonthOverallValue = 0;
            let lastMonthOverallValue = 0;
            let firstMonthOverallCount = 0;
            let lastMonthOverallCount = 0;

            const firstSelectedMonth = selectedMonths[0];
            const lastSelectedMonth = selectedMonths[selectedMonths.length - 1];

            selectedAgencies.forEach(agencyName => {
                const agencyData = loadedData.find(a => a.agency === agencyName);
                let agencyKpiSumForSelectedMonths = 0;
                let agencyKpiCountForSelectedMonths = 0;

                if (agencyData) {
                    const kpiData = agencyData.kpis.find(k => k.name === kpiName);
                    if (kpiData) {
                        selectedMonths.forEach(month => {
                            const value = kpiData[month];
                            if (typeof value === 'number' && !isNaN(value)) {
                                agencyKpiSumForSelectedMonths += value;
                                agencyKpiCountForSelectedMonths++;

                                if (month === firstSelectedMonth) {
                                    firstMonthOverallValue += value;
                                    firstMonthOverallCount++;
                                }
                                if (month === lastSelectedMonth) {
                                    lastMonthOverallValue += value;
                                    lastMonthOverallCount++;
                                }
                            }
                        });
                    }
                }
                const agencyKpiAvg = agencyKpiCountForSelectedMonths > 0 ? 
                                     agencyKpiSumForSelectedMonths / agencyKpiCountForSelectedMonths : 'N/A';
                row.push(agencyKpiAvg === 'N/A' ? 'N/A' : parseFloat(agencyKpiAvg.toFixed(2)));
                if (typeof agencyKpiAvg === 'number') {
                    rowAgencyValues.push(agencyKpiAvg);
                }
            });

            const totalNumericValuesInRow = rowAgencyValues.reduce((sum, val) => sum + val, 0); 
            const promedioGeneral = rowAgencyValues.length > 0 ? 
                                   totalNumericValuesInRow / rowAgencyValues.length : 'N/A';
            row.push(promedioGeneral === 'N/A' ? 'N/A' : parseFloat(promedioGeneral.toFixed(2)));

            if (selectedMonths.length >= 2) {
                let tendenciaText = 'N/A';
                const firstMonthAvg = firstMonthOverallCount > 0 ? firstMonthOverallValue / firstMonthOverallCount : 'N/A';
                const lastMonthAvg = lastMonthOverallCount > 0 ? lastMonthOverallValue / lastMonthOverallCount : 'N/A';

                if (typeof firstMonthAvg === 'number' && typeof lastMonthAvg === 'number' && firstMonthAvg !== 0) {
                    const percentageChange = ((lastMonthAvg - firstMonthAvg) / firstMonthAvg) * 100;
                    tendenciaText = `${percentageChange.toFixed(2)}%`;
                }
                row.push(tendenciaText);
            }
            data.push(row);
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "KPIs_Agencias_Seminuevos");

        const filename = `KPIs_Autos_Seminuevos_Agencias_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, filename);

        showStatus('success', 'Archivo Excel exportado correctamente.');

    } catch (error) {
        console.error('Error exportando Excel:', error);
        alert('Error al exportar archivo Excel');
    }
}

// Export to Excel for Single Agency Table
function exportSingleTableToExcel() {
    if (!singleSelectedAgency || singleSelectedMonths.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    try {
        const agency = loadedData.find(a => a.agency === singleSelectedAgency);
        
        singleSelectedMonths.sort((a, b) => chronologicalMonthOrder.indexOf(a) - chronologicalMonthOrder.indexOf(b));

        const headers = ['KPI', ...singleSelectedMonths, 'Promedio', 'Tendencia'];
        const data = [headers];
        
        agency.kpis.forEach(kpi => {
            const row = [kpi.name];
            const currentMonthNumericValuesForCalc = []; 

            singleSelectedMonths.forEach(month => {
                const value = kpi[month];
                if (typeof value === 'number' && !isNaN(value)) {
                    currentMonthNumericValuesForCalc.push(value);
                }
                row.push(value !== 'N/A' ? parseFloat(value) : 'N/A'); 
            });

            const sum = currentMonthNumericValuesForCalc.reduce((acc, val) => acc + val, 0);
            const promedio = currentMonthNumericValuesForCalc.length > 0 ? sum / currentMonthNumericValuesForCalc.length : 'N/A';
            row.push(promedio === 'N/A' ? 'N/A' : parseFloat(promedio.toFixed(2)));

            let tendenciaText = 'N/A';
            if (currentMonthNumericValuesForCalc.length >= 2) {
                const lastValue = currentMonthNumericValuesForCalc[currentMonthNumericValuesForCalc.length - 1];
                const secondLastValue = currentMonthNumericValuesForCalc[currentMonthNumericValuesForCalc.length - 2];

                if (typeof lastValue === 'number' && typeof secondLastValue === 'number' && secondLastValue !== 0) {
                    const percentageChange = ((lastValue - secondLastValue) / secondLastValue) * 100;
                    tendenciaText = `${percentageChange.toFixed(2)}%`;
                }
            }
            row.push(tendenciaText);

            data.push(row);
        });
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        XLSX.utils.book_append_sheet(wb, ws, singleSelectedAgency);
        
        const filename = `${singleSelectedAgency}_KPIs_Seminuevos_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        showStatus('success', 'Archivo Excel exportado correctamente.');
        
    } catch (error) {
        console.error('Error exportando Excel:', error);
        alert('Error al exportar archivo Excel');
    }
}

// Inicializaci√≥n del dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéâ Dashboard KPIs Seminuevos Daytona cargado correctamente');
    
    // Cargar datos de sesi√≥n si existen (como fallback inmediato)
    const savedData = sessionStorage.getItem('daytonaDashboardDataSeminuevos');
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            console.log('üì± Datos encontrados en sesi√≥n, mostrando...');
            loadedData = data; // Asegurar que loadedData se setea desde la sesi√≥n
            displayResults(data);
            showStatus('success', `Datos cargados desde sesi√≥n: ${data.length} agencias`);
        } catch (error) {
            console.log('‚ùå Error cargando sesi√≥n:', error);
            sessionStorage.removeItem('daytonaDashboardDataSeminuevos'); // Limpiar sesi√≥n corrupta
            connectToAPI(); // Intentar cargar desde la API
        }
    } else {
        // Intentar conexi√≥n autom√°tica a la API si no hay datos en sesi√≥n
        console.log('üöÄ Iniciando conexi√≥n autom√°tica a Google Sheets...');
        connectToAPI();
    }
});
</script>
</body>
</html>
