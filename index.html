<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Seminuevos - Grupo Daytona</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzFGMjkzNyIvPgo8cGF0aCBkPSJNOCAxNkgyNE04IDE2QzggMTMuNzkwOSA5Ljc5MDg2IDEyIDEyIDEySDIwQzIyLjIwOTEgMTIgMjQgMTMuNzkwOSAyNCAxNlMyMi4yMDkxIDIwIDIwIDIwSDEyQzkuNzkwODYgMjAgOCAxOC4yMDkxIDggMTZaIiBzdHJva2U9IiNGRjY1MDAiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4K">
    <meta name="description" content="Dashboard interactivo de KPIs para agencias de seminuevos de Grupo Daytona">
    <meta name="author" content="Grupo Daytona">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, LineChart, Line, ResponsiveContainer } = Recharts;
        const { Upload, BarChart3, TrendingUp, Calendar, Building2, FileSpreadsheet, Download, Plus, X, AlertCircle, Link, RefreshCw } = LucideReact;

        const KPIAnalyzer = () => {
          const [agencies, setAgencies] = useState([]);
          const [selectedAgencies, setSelectedAgencies] = useState([]);
          const [selectedMonths, setSelectedMonths] = useState([]);
          const [loading, setLoading] = useState(false);
          const [allKPIs, setAllKPIs] = useState([]);
          const [allMonths, setAllMonths] = useState([]);
          const [googleSheetsUrl, setGoogleSheetsUrl] = useState('');
          const [connectionStatus, setConnectionStatus] = useState('');

          const extractSpreadsheetId = (url) => {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
          };

          const fetchGoogleSheet = async (spreadsheetId, sheetName) => {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0&sheet=${encodeURIComponent(sheetName)}`;
            
            try {
              const response = await fetch(csvUrl, {
                method: 'GET',
                headers: {
                  'Accept': 'text/csv'
                }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const csvText = await response.text();
              
              if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<html')) {
                throw new Error(`La hoja "${sheetName}" no existe o no es accesible`);
              }
              
              return csvText;
            } catch (error) {
              console.error(`Error cargando ${sheetName}:`, error);
              throw new Error(`No se pudo cargar la hoja "${sheetName}": ${error.message}`);
            }
          };

          const processParsedData = (data, agencyName) => {
            if (!data || data.length === 0) {
              throw new Error(`La hoja "${agencyName}" estÃ¡ vacÃ­a`);
            }

            const headers = Object.keys(data[0]);
            const kpiColumn = headers.find(h => 
              h.toLowerCase().includes('kpi') || 
              h.toLowerCase().includes('indicador') ||
              h.toLowerCase().includes('metrica') ||
              h.toLowerCase().includes('metric')
            );
            
            if (!kpiColumn) {
              throw new Error(`No se encontrÃ³ una columna de KPIs en "${agencyName}". Columnas disponibles: ${headers.join(', ')}`);
            }

            const monthColumns = headers.filter(header => {
              const monthRegex = /(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|\d{1,2}\/\d{4}|\d{4}-\d{2})/i;
              return monthRegex.test(header) || /^(Q[1-4]|T[1-4])/.test(header);
            });

            if (monthColumns.length === 0) {
              throw new Error(`No se encontraron columnas de meses en "${agencyName}". AsegÃºrate de tener columnas con nombres de meses.`);
            }

            const monthlyData = {};
            const kpis = [];

            data.forEach(row => {
              const kpiName = row[kpiColumn];
              if (kpiName && kpiName.toString().trim() !== '' && kpiName.toString().trim() !== 'undefined') {
                kpis.push(kpiName.toString().trim());
                monthlyData[kpiName] = {};
                
                monthColumns.forEach(month => {
                  const value = row[month];
                  monthlyData[kpiName][month] = value ? parseFloat(value.toString().replace(/[,%$]/g, '')) || 0 : 0;
                });
              }
            });

            return {
              name: agencyName,
              kpis,
              months: monthColumns,
              monthlyData,
              fileName: agencyName
            };
          };

          const connectToGoogleSheets = async () => {
            if (!googleSheetsUrl.trim()) {
              alert('Por favor ingresa la URL del Google Sheets');
              return;
            }

            const spreadsheetId = extractSpreadsheetId(googleSheetsUrl);
            if (!spreadsheetId) {
              alert('âŒ URL invÃ¡lida. AsegÃºrate de usar una URL vÃ¡lida de Google Sheets\\n\\nâœ… Ejemplo: https://docs.google.com/spreadsheets/d/TU_ID_AQUI/edit');
              return;
            }

            setLoading(true);
            setConnectionStatus('loading');
            
            try {
              const expectedAgencies = [
                'GWM Iztapalapa', 'GWM Morelos', 'Honda Cuajimalpa', 'Honda Interlomas', 
                'KIA Interlomas', 'KIA Iztapalapa', 'MG Cuajimalpa', 'MG Interlomas', 'MG Iztapalapa'
              ];

              const loadedAgencies = [];
              const allKPIsSet = new Set();
              const allMonthsSet = new Set();
              const errors = [];
              const successes = [];

              for (const agencyName of expectedAgencies) {
                try {
                  console.log(`ðŸ”— Intentando cargar: ${agencyName}`);
                  const csvData = await fetchGoogleSheet(spreadsheetId, agencyName);
                  
                  if (csvData && csvData.trim().length > 0) {
                    const parsedData = Papa.parse(csvData, {
                      header: true,
                      skipEmptyLines: true,
                      transformHeader: (header) => header.trim(),
                      delimiter: ','
                    });

                    console.log(`ðŸ“Š Datos parseados para ${agencyName}:`, parsedData.data?.length, 'filas');

                    if (parsedData.data && parsedData.data.length > 0) {
                      const processedData = processParsedData(parsedData.data, agencyName);
                      loadedAgencies.push(processedData);
                      
                      processedData.kpis.forEach(kpi => allKPIsSet.add(kpi));
                      processedData.months.forEach(month => allMonthsSet.add(month));
                      
                      successes.push(`âœ… ${agencyName}: ${processedData.kpis.length} KPIs, ${processedData.months.length} meses`);
                    } else {
                      errors.push(`âŒ ${agencyName}: Hoja vacÃ­a o sin datos vÃ¡lidos`);
                    }
                  } else {
                    errors.push(`âŒ ${agencyName}: No se obtuvieron datos`);
                  }
                } catch (error) {
                  console.error(`âŒ Error con ${agencyName}:`, error);
                  errors.push(`âŒ ${agencyName}: ${error.message}`);
                }
              }

              if (loadedAgencies.length === 0) {
                throw new Error(`âŒ No se pudo cargar ninguna hoja.\\n\\nâš ï¸ Errores encontrados:\\n${errors.join('\\n')}\\n\\nðŸ”§ Verifica que:\\n\\n1ï¸âƒ£ El documento sea PÃšBLICO (Compartir â†’ Cualquier persona con enlace â†’ Visor)\\n2ï¸âƒ£ Las hojas tengan los nombres exactos de las agencias\\n3ï¸âƒ£ Cada hoja tenga datos con columnas KPI y meses\\n\\nðŸ’¡ Nombres esperados: ${expectedAgencies.join(', ')}`);
              }

              setAgencies(loadedAgencies);
              const kpiArray = Array.from(allKPIsSet);
              const monthArray = Array.from(allMonthsSet);
              setAllKPIs(kpiArray);
              setAllMonths(monthArray);
              
              setSelectedAgencies(loadedAgencies.map(a => a.name));
              setSelectedMonths(monthArray.slice(0, 6));
              
              setConnectionStatus('success');
              
              const summary = `ðŸŽ‰ Â¡CONEXIÃ“N EXITOSA!\\n\\nðŸ“Š Resumen:\\n${successes.join('\\n')}\\n\\nðŸ“ˆ Total: ${loadedAgencies.length} agencias cargadas\\nðŸ“‹ ${kpiArray.length} KPIs Ãºnicos encontrados\\nðŸ“… ${monthArray.length} perÃ­odos detectados`;
              
              if (errors.length > 0) {
                alert(`${summary}\\n\\nâš ï¸ Advertencias:\\n${errors.join('\\n')}`);
              } else {
                alert(summary);
              }

            } catch (error) {
              console.error('ðŸ’¥ Error conectando a Google Sheets:', error);
              setConnectionStatus('error');
              alert(`âŒ Error al conectar con Google Sheets:\\n\\n${error.message}\\n\\nðŸ”§ SoluciÃ³n rÃ¡pida:\\n\\n1ï¸âƒ£ Ve a tu Google Sheets\\n2ï¸âƒ£ Clic en "Compartir" (botÃ³n azul arriba a la derecha)\\n3ï¸âƒ£ Cambiar a "Cualquier persona con el enlace"\\n4ï¸âƒ£ Permisos: "Visor"\\n5ï¸âƒ£ Copiar enlace y pegarlo aquÃ­\\n\\nðŸ’¡ El enlace debe verse asÃ­:\\nhttps://docs.google.com/spreadsheets/d/TU_ID/edit`);
            }
            
            setLoading(false);
          };

          const handlePasteData = (pastedData) => {
            if (pastedData.trim().length > 100) {
              console.log('Datos detectados, listos para procesar');
            }
          };

          const processPastedData = (agencyName) => {
            const textarea = document.querySelector('textarea');
            const pastedData = textarea.value;
            
            if (!pastedData.trim() || !agencyName.trim()) {
              alert('Por favor ingresa tanto los datos como el nombre de la agencia');
              return;
            }

            try {
              const lines = pastedData.trim().split('\\n');
              const csvData = lines.map(line => line.split('\\t')).map(row => row.join(','));
              const csvString = csvData.join('\\n');
              
              const parsedData = Papa.parse(csvString, {
                header: true,
                skipEmptyLines: true,
                transformHeader: (header) => header.trim()
              });

              if (parsedData.data && parsedData.data.length > 0) {
                const processedData = processParsedData(parsedData.data, agencyName);
                
                setAgencies(prev => {
                  const updated = [...prev.filter(a => a.name !== agencyName), processedData];
                  return updated;
                });
                
                const allKPIsSet = new Set(allKPIs);
                const allMonthsSet = new Set(allMonths);
                processedData.kpis.forEach(kpi => allKPIsSet.add(kpi));
                processedData.months.forEach(month => allMonthsSet.add(month));
                setAllKPIs(Array.from(allKPIsSet));
                setAllMonths(Array.from(allMonthsSet));
                
                textarea.value = '';
                document.querySelector('input[placeholder="Nombre de la agencia"]').value = '';
                
                alert(`âœ… Agencia "${agencyName}" agregada exitosamente!\\n${processedData.kpis.length} KPIs detectados`);
              } else {
                throw new Error('No se pudieron procesar los datos pegados');
              }
            } catch (error) {
              alert(`âŒ Error procesando datos: ${error.message}\\n\\nAsegÃºrate de copiar los datos con encabezados desde Google Sheets`);
            }
          };

          const handleFileUpload = useCallback(async (files) => {
            if (!files || files.length === 0) return;

            setLoading(true);
            const newAgencies = [];
            const allKPIsSet = new Set();
            const allMonthsSet = new Set();

            try {
              for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const agencyName = file.name.split('.')[0];
                
                try {
                  let csvData;
                  if (fileExtension === 'csv') {
                    csvData = await new Promise((resolve) => {
                      const reader = new FileReader();
                      reader.onload = (e) => resolve(e.target.result);
                      reader.readAsText(file);
                    });
                  }
                  
                  const parsedData = Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim()
                  });

                  if (parsedData.data && parsedData.data.length > 0) {
                    const processedData = processParsedData(parsedData.data, agencyName);
                    newAgencies.push(processedData);
                    
                    processedData.kpis.forEach(kpi => allKPIsSet.add(kpi));
                    processedData.months.forEach(month => allMonthsSet.add(month));
                  }
                } catch (error) {
                  console.error(`Error procesando ${file.name}:`, error);
                  alert(`Error procesando ${file.name}: ${error.message}`);
                }
              }

              if (newAgencies.length > 0) {
                setAgencies(newAgencies);
                const kpiArray = Array.from(allKPIsSet);
                const monthArray = Array.from(allMonthsSet);
                setAllKPIs(kpiArray);
                setAllMonths(monthArray);
                
                setSelectedAgencies(newAgencies.slice(0, 9).map(a => a.name));
                setSelectedMonths(monthArray.slice(0, 6));
              }
            } catch (error) {
              console.error('Error general:', error);
              alert('Error procesando archivos');
            }
            setLoading(false);
          }, []);

          const removeAgency = (agencyName) => {
            const updatedAgencies = agencies.filter(a => a.name !== agencyName);
            setAgencies(updatedAgencies);
            setSelectedAgencies(selectedAgencies.filter(name => name !== agencyName));
            
            const allKPIsSet = new Set();
            const allMonthsSet = new Set();
            updatedAgencies.forEach(agency => {
              agency.kpis.forEach(kpi => allKPIsSet.add(kpi));
              agency.months.forEach(month => allMonthsSet.add(month));
            });
            setAllKPIs(Array.from(allKPIsSet));
            setAllMonths(Array.from(allMonthsSet));
          };

          const generateAllKPIsData = () => {
            if (agencies.length === 0) return [];
            
            const allData = [];
            selectedAgencies.forEach(agencyName => {
              const agency = agencies.find(a => a.name === agencyName);
              selectedMonths.forEach(month => {
                allKPIs.forEach(kpi => {
                  const value = agency?.monthlyData[kpi]?.[month] || 0;
                  allData.push({
                    agency: agencyName,
                    month,
                    kpi,
                    value
                  });
                });
              });
            });
            return allData;
          };

          const allKPIsData = generateAllKPIsData();

          const colors = [
            '#DC2626', '#EA580C', '#D97706', '#CA8A04', '#65A30D', 
            '#059669', '#0891B2', '#2563EB', '#7C3AED'
          ];

          return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black p-6" },
            React.createElement('div', { className: "max-w-7xl mx-auto" },
              React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-2xl shadow-2xl border border-gray-200 p-8 mb-8" },
                React.createElement('div', { className: "text-center mb-8" },
                  React.createElement('h1', { className: "text-4xl font-bold text-gray-900 mb-4 flex items-center justify-center gap-3" },
                    React.createElement(BarChart3, { className: "text-red-500", size: 40 }),
                    "KPIs Seminuevos - Grupo Daytona"
                  ),
                  React.createElement('p', { className: "text-gray-700 text-lg" }, "Conecta tu Google Sheets y genera comparativas automÃ¡ticas de tus agencias automotrices")
                ),

                // Google Sheets Direct CSV Export
                React.createElement('div', { className: "mb-8" },
                  React.createElement('div', { className: "bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-4" },
                    React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                      React.createElement(Link, { className: "text-green-600", size: 20 }),
                      React.createElement('h3', { className: "font-semibold text-gray-800" }, "Conectar Google Sheets (RECOMENDADO)")
                    ),
                    React.createElement('div', { className: "text-sm text-gray-700 space-y-2 mb-4" },
                      React.createElement('p', null, 
                        React.createElement('strong', null, "ðŸ“‹ Paso 1:"), " Haz tu Google Sheets PÃšBLICO para lectura"
                      ),
                      React.createElement('p', null, 
                        React.createElement('strong', null, "ðŸ”— Paso 2:"), " Compartir â†’ Cualquier persona con el enlace â†’ Visor"
                      ),
                      React.createElement('p', null, 
                        React.createElement('strong', null, "ðŸ“ Paso 3:"), " Copia la URL de tu Google Sheets y pÃ©gala aquÃ­:"
                      ),
                      React.createElement('p', { className: "text-xs text-green-600 font-mono" }, "Ejemplo: https://docs.google.com/spreadsheets/d/TU_ID_AQUI/edit")
                    ),
                    
                    React.createElement('div', { className: "flex gap-2" },
                      React.createElement('input', {
                        type: "text",
                        placeholder: "https://docs.google.com/spreadsheets/d/TU_SPREADSHEET_ID/edit",
                        value: googleSheetsUrl,
                        onChange: (e) => setGoogleSheetsUrl(e.target.value),
                        className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                      }),
                      React.createElement('button', {
                        onClick: connectToGoogleSheets,
                        disabled: loading,
                        className: "px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg"
                      },
                        loading ? 
                          React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement(RefreshCw, { className: "animate-spin", size: 16 }),
                            "Conectando..."
                          ) :
                          React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement(Link, { size: 16 }),
                            "Conectar Google Sheets"
                          )
                      )
                    ),

                    connectionStatus === 'success' && React.createElement('div', { className: "mt-3 p-2 bg-green-100 border border-green-300 rounded text-green-800 text-sm flex items-center gap-2" },
                      React.createElement('div', { className: "w-2 h-2 bg-green-500 rounded-full" }),
                      `Conectado exitosamente - ${agencies.length} agencias cargadas`
                    ),

                    connectionStatus === 'error' && React.createElement('div', { className: "mt-3 p-2 bg-red-100 border border-red-300 rounded text-red-800 text-sm flex items-center gap-2" },
                      React.createElement(AlertCircle, { size: 16 }),
                      "Error de conexiÃ³n - Verifica que el documento sea pÃºblico"
                    )
                  ),

                  // File upload section
                  React.createElement('div', { className: "mb-8" },
                    React.createElement('label', { className: "flex flex-col items-center justify-center w-full h-32 border-2 border-red-300 border-dashed rounded-xl cursor-pointer bg-gradient-to-r from-orange-50 to-red-50 hover:from-orange-100 hover:to-red-100 transition-colors" },
                      React.createElement('div', { className: "flex flex-col items-center justify-center pt-5 pb-6" },
                        React.createElement(Upload, { className: "w-10 h-10 mb-3 text-red-500" }),
                        React.createElement('p', { className: "mb-2 text-sm text-red-600" },
                          React.createElement('span', { className: "font-semibold" }, "Clic para subir"), " archivos CSV de agencias"
                        ),
                        React.createElement('p', { className: "text-xs text-red-500" }, "CSV - MÃºltiples archivos permitidos")
                      ),
                      React.createElement('input', {
                        type: "file",
                        className: "hidden",
                        accept: ".csv",
                        multiple: true,
                        onChange: (e) => handleFileUpload(e.target.files)
                      })
                    )
                  )
                ),

                // Resto del componente - agencias cargadas, tablas, grÃ¡ficos, etc.
                agencies.length > 0 && React.createElement('div', { className: "space-y-8" },
                  // Summary de agencias cargadas
                  React.createElement('div', { className: "mb-8" },
                    React.createElement('h3', { className: "text-lg font-semibold mb-4 flex items-center gap-2" },
                      React.createElement(Building2, { className: "text-red-500", size: 20 }),
                      `Agencias Cargadas (${agencies.length}/9)`
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                      agencies.map((agency, index) => 
                        React.createElement('div', { 
                          key: agency.name, 
                          className: "bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-4 relative border-l-4 shadow-md",
                          style: { borderLeftColor: colors[index % colors.length] }
                        },
                          React.createElement('button', {
                            onClick: () => removeAgency(agency.name),
                            className: "absolute top-2 right-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full p-1",
                            title: "Eliminar agencia"
                          },
                            React.createElement(X, { size: 16 })
                          ),
                          React.createElement('div', { className: "flex items-center mb-2" },
                            React.createElement('div', { 
                              className: "w-3 h-3 rounded-full mr-2",
                              style: { backgroundColor: colors[index % colors.length] }
                            }),
                            React.createElement('h4', { className: "font-semibold text-gray-800 pr-6" }, agency.name)
                          ),
                          React.createElement('p', { className: "text-sm text-gray-600" }, `${agency.kpis.length} KPIs`),
                          React.createElement('p', { className: "text-sm text-gray-600" }, `${agency.months.length} meses`)
                        )
                      )
                    )
                  ),

                  loading && React.createElement('div', { className: "text-center py-8" },
                    React.createElement('div', { className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-600" }),
                    React.createElement('p', { className: "mt-2 text-gray-600" }, "Procesando datos...")
                  ),

                  // Controles de configuraciÃ³n
                  React.createElement('div', { className: "bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 border border-gray-200" },
                    React.createElement('h3', { className: "text-xl font-semibold mb-4 flex items-center gap-2" },
                      React.createElement(FileSpreadsheet, { className: "text-red-500", size: 24 }),
                      "ConfiguraciÃ³n de AnÃ¡lisis"
                    ),
                    
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                      React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                          React.createElement(Building2, { size: 16, className: "inline mr-1" }),
                          `Agencias (${selectedAgencies.length}/9)`
                        ),
                        React.createElement('div', { className: "max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white shadow-inner" },
                          React.createElement('div', { className: "mb-2 pb-2 border-b border-gray-200" },
                            React.createElement('button', {
                              onClick: () => setSelectedAgencies(agencies.map(a => a.name)),
                              className: "text-xs text-red-600 hover:text-red-800 mr-2 font-medium"
                            }, "Seleccionar todas"),
                            React.createElement('button', {
                              onClick: () => setSelectedAgencies([]),
                              className: "text-xs text-gray-600 hover:text-gray-800 font-medium"
                            }, "Deseleccionar todas")
                          ),
                          agencies.map((agency, index) => 
                            React.createElement('label', { 
                              key: agency.name, 
                              className: "flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-2 rounded" 
                            },
                              React.createElement('input', {
                                type: "checkbox",
                                checked: selectedAgencies.includes(agency.name),
                                onChange: (e) => {
                                  if (e.target.checked) {
                                    if (selectedAgencies.length < 9) {
                                      setSelectedAgencies([...selectedAgencies, agency.name]);
                                    } else {
                                      alert('MÃ¡ximo 9 agencias pueden ser seleccionadas para comparaciÃ³n');
                                    }
                                  } else {
                                    setSelectedAgencies(selectedAgencies.filter(a => a !== agency.name));
                                  }
                                },
                                className: "rounded text-red-600 focus:ring-red-500"
                              }),
                              React.createElement('div', { 
                                className: "w-3 h-3 rounded-full",
                                style: { backgroundColor: colors[index % colors.length] }
                              }),
                              React.createElement('span', { className: "flex-1" }, agency.name)
                            )
                          )
                        )
                      ),

                      React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                          React.createElement(Calendar, { size: 16, className: "inline mr-1" }),
                          `Meses (${selectedMonths.length})`
                        ),
                        React.createElement('div', { className: "max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white" },
                          allMonths.map(month => 
                            React.createElement('label', { 
                              key: month, 
                              className: "flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-1 rounded" 
                            },
                              React.createElement('input', {
                                type: "checkbox",
                                checked: selectedMonths.includes(month),
                                onChange: (e) => {
                                  if (e.target.checked) {
                                    setSelectedMonths([...selectedMonths, month]);
                                  } else {
                                    setSelectedMonths(selectedMonths.filter(m => m !== month));
                                  }
                                },
                                className: "rounded text-red-600 focus:ring-red-500"
                              }),
                              React.createElement('span', { className: "flex-1" }, month)
                            )
                          )
                        )
                      )
                    )
                  ),

                  // Summary Table - All KPIs
                  allKPIsData.length > 0 && React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                    React.createElement('div', { className: "flex items-center justify-between mb-4" },
                      React.createElement('h3', { className: "text-xl font-semibold flex items-center gap-2" },
                        React.createElement(FileSpreadsheet, { className: "text-red-500", size: 24 }),
                        "Comparativa de KPIs por Agencia"
                      ),
                      React.createElement('div', { className: "text-sm text-gray-600" },
                        `${selectedAgencies.length} de ${agencies.length} agencias | ${selectedMonths.length} meses | ${allKPIs.length} KPIs`
                      )
                    ),
                    React.createElement('div', { className: "overflow-auto max-h-screen" },
                      React.createElement('style', { dangerouslySetInnerHTML: { __html: '.shadow-r { box-shadow: 2px 0 4px rgba(0,0,0,0.1); }' } }),
                      React.createElement('table', { className: "min-w-full divide-y divide-gray-200" },
                        React.createElement('thead', { className: "bg-gray-50" },
                          React.createElement('tr', null,
                            React.createElement('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 top-0 bg-gray-50 z-20 shadow-r" }, "KPI"),
                            React.createElement('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-32 top-0 bg-gray-50 z-20 shadow-r" }, "Mes"),
                            selectedAgencies.map((agency, index) => 
                              React.createElement('th', { 
                                key: agency, 
                                className: "px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10",
                                style: { backgroundColor: colors[index % colors.length] + '20' }
                              }, agency)
                            )
                          )
                        ),
                        React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                          allKPIs.map(kpi => 
                            selectedMonths.map((month, monthIndex) => 
                              React.createElement('tr', { 
                                key: `${kpi}-${month}`, 
                                className: monthIndex % 2 === 0 ? 'bg-white' : 'bg-amber-50' 
                              },
                                React.createElement('td', { className: "px-4 py-4 text-sm font-medium text-gray-800 sticky left-0 bg-inherit z-10 min-w-32 shadow-r" }, kpi),
                                React.createElement('td', { className: "px-4 py-4 text-sm text-gray-800 font-medium sticky left-32 bg-inherit z-10 min-w-24 shadow-r" }, month),
                                selectedAgencies.map((agencyName, agencyIndex) => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const value = agency?.monthlyData[kpi]?.[month] || 0;
                                  const isHighest = selectedAgencies.length > 1 && value > 0 && 
                                    value === Math.max(...selectedAgencies.map(an => {
                                      const ag = agencies.find(a => a.name === an);
                                      return ag?.monthlyData[kpi]?.[month] || 0;
                                    }));
                                  
                                  return React.createElement('td', { 
                                    key: agencyName, 
                                    className: `px-4 py-4 text-center text-sm font-semibold ${isHighest ? 'bg-green-100 text-green-800' : 'text-gray-900'}` 
                                  }, value.toLocaleString());
                                })
                              )
                            )
                          )
                        )
                      )
                    ),
                    
                    // Summary Stats
                    React.createElement('div', { className: "mt-6 grid grid-cols-1 md:grid-cols-3 gap-4" },
                      React.createElement('div', { className: "bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border border-red-200" },
                        React.createElement('h4', { className: "font-medium text-red-800 mb-2" }, "Total de KPIs"),
                        React.createElement('p', { className: "text-2xl font-bold text-red-600" }, allKPIs.length)
                      ),
                      React.createElement('div', { className: "bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200" },
                        React.createElement('h4', { className: "font-medium text-amber-800 mb-2" }, "Agencias Analizadas"),
                        React.createElement('p', { className: "text-2xl font-bold text-amber-600" }, selectedAgencies.length)
                      ),
                      React.createElement('div', { className: "bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200" },
                        React.createElement('h4', { className: "font-medium text-orange-800 mb-2" }, "PerÃ­odos Analizados"),
                        React.createElement('p', { className: "text-2xl font-bold text-orange-600" }, selectedMonths.length)
                      )
                    )
                  ),

                  // Charts Section
                  allKPIsData.length > 0 && React.createElement('div', { className: "space-y-8" },
                    // KPI Comparison by Agency
                    React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                      React.createElement('h3', { className: "text-xl font-semibold mb-6 flex items-center gap-2" },
                        React.createElement(TrendingUp, { className: "text-red-500", size: 24 }),
                        "Comparativa de KPIs por Agencia"
                      ),
                      React.createElement('div', { className: "h-96" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(BarChart, { 
                            data: (() => {
                              const chartData = [];
                              allKPIs.slice(0, 6).forEach(kpi => {
                                const kpiData = { kpi: kpi.substring(0, 25) + (kpi.length > 25 ? '...' : '') };
                                selectedAgencies.forEach(agencyName => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const totalValue = selectedMonths.reduce((sum, month) => {
                                    return sum + (agency?.monthlyData[kpi]?.[month] || 0);
                                  }, 0);
                                  kpiData[agencyName] = totalValue;
                                });
                                chartData.push(kpiData);
                              });
                              return chartData;
                            })(),
                            margin: { top: 20, right: 30, left: 20, bottom: 80 }
                          },
                            React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                            React.createElement(XAxis, { dataKey: "kpi", angle: -45, textAnchor: "end", height: 100 }),
                            React.createElement(YAxis),
                            React.createElement(Tooltip),
                            React.createElement(Legend),
                            selectedAgencies.map((agency, index) => 
                              React.createElement(Bar, { 
                                key: agency, 
                                dataKey: agency,
                                name: agency,
                                fill: colors[index % colors.length]
                              })
                            )
                          )
                        )
                      )
                    ),

                    // Monthly Trends
                    React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                      React.createElement('h3', { className: "text-xl font-semibold mb-6 flex items-center gap-2" },
                        React.createElement(TrendingUp, { className: "text-red-500", size: 24 }),
                        "Tendencias Mensuales por Agencia"
                      ),
                      React.createElement('div', { className: "h-96" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(LineChart, { 
                            data: (() => {
                              const chartData = [];
                              selectedMonths.forEach(month => {
                                const monthData = { month };
                                selectedAgencies.forEach(agencyName => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const monthTotal = allKPIs.reduce((sum, kpi) => {
                                    return sum + (agency?.monthlyData[kpi]?.[month] || 0);
                                  }, 0);
                                  monthData[agencyName] = monthTotal;
                                });
                                chartData.push(monthData);
                              });
                              return chartData;
                            })()
                          },
                            React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                            React.createElement(XAxis, { dataKey: "month" }),
                            React.createElement(YAxis),
                            React.createElement(Tooltip),
                            React.createElement(Legend),
                            selectedAgencies.map((agency, index) => 
                              React.createElement(Line, { 
                                key: agency,
                                type: "monotone", 
                                dataKey: agency, 
                                stroke: colors[index % colors.length],
                                strokeWidth: 3,
                                dot: { r: 6 }
                              })
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(KPIAnalyzer));
    </script>
</body>
</html>