// ============ FUNCIONES DE EXPORTACI√ìN ============
        
        function exportToExcel() {
            try {
                showConnectionStatus('üìä Generando archivo Excel...', 'warning');
                
                // Crear datos para Excel
                const data = prepareExportData();
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                
                // Hoja principal con datos comparativos
                const ws1 = XLSX.utils.aoa_to_sheet([
                    ['Dashboard Agencia Automotriz - Comparativo Mensual'],
                    ['Generado:', new Date().toLocaleDateString('es-MX')],
                    [], // L√≠nea vac√≠a
                    ['M√©trica', 'Ene 2025', 'Feb 2025', 'Mar 2025', 'Abr 2025', 'May 2025', 'Jun 2025', 'Promedio', 'Tendencia', '% vs Promedio'],
                    ...data.tableData
                ]);
                
                // Hoja de KPIs actuales
                const ws2 = XLSX.utils.aoa_to_sheet([
                    ['KPIs Actuales - ' + new Date().toLocaleDateString('es-MX')],
                    [],
                    ['√Årea', 'KPI', 'Valor Actual'],
                    ...data.currentKPIs
                ]);
                
                // Agregar hojas al workbook
                XLSX.utils.book_append_sheet(wb, ws1, 'Comparativo Mensual');
                XLSX.utils.book_append_sheet(wb, ws2, 'KPIs Actuales');
                
                // Generar y descargar archivo
                const fileName = `Dashboard_Agencia_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showConnectionStatus('‚úÖ Archivo Excel descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                showConnectionStatus('‚ùå Error generando Excel', 'error');
            }
        }

        function exportToPDF() {
            showConnectionStatus('üìÑ Generando PDF...', 'warning');
            
            try {
                // Configurar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                // T√≠tulo
                doc.setFontSize(20);
                doc.setTextColor(44, 62, 80);
                doc.text('Dashboard Agencia Automotriz', 20, 25);
                
                doc.setFontSize(12);
                doc.setTextColor(127, 140, 141);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-MX')}`, 20, 35);
                
                // Preparar datos de tabla
                const data = prepareExportData();
                const tableHeaders = ['M√©trica', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Promedio', 'Tendencia'];
                
                // Generar tabla con autoTable
                doc.autoTable({
                    head: [tableHeaders],
                    body: data.tableData.map(row => row.slice(0, 9)), // Excluir % vs Promedio para que quepa
                    startY: 50,
                    theme: 'grid',
                    headStyles: { fillColor: [102, 126, 234], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    styles: { fontSize: 8, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 50, fontStyle: 'bold' },
                        7: { cellWidth: 25, fontStyle: 'bold' }
                    }
                });
                
                // Agregar KPIs actuales en nueva p√°gina
                doc.addPage();
                doc.setFontSize(16);
                doc.setTextColor(44, 62, 80);
                doc.text('KPIs Actuales', 20, 25);
                
                doc.autoTable({
                    head: [['√Årea', 'KPI', 'Valor Actual']],
                    body: data.currentKPIs,
                    startY: 35,
                    theme: 'grid',
                    headStyles: { fillColor: [102, 126, 234] },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    styles: { fontSize: 10 }
                });
                
                // Descargar PDF
                const fileName = `Dashboard_Agencia_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showConnectionStatus('‚úÖ PDF descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando a PDF:', error);
                showConnectionStatus('‚ùå Error generando PDF - Instalando librer√≠as...', 'warning');
                loadPDFLibraries().then(() => {
                    showConnectionStatus('‚úÖ Librer√≠as cargadas. Intenta exportar de nuevo.', 'success');
                });
            }
        }

        function exportToCSV() {
            try {
                showConnectionStatus('üìã Generando CSV...', 'warning');
                
                const data = prepareExportData();
                
                // Crear contenido CSV
                let csvContent = 'Dashboard Agencia Automotriz - Comparativo Mensual\n';
                csvContent += `Generado: ${new Date().toLocaleDateString('es-MX')}\n\n`;
                
                // Headers
                csvContent += 'M√©trica,Ene 2025,Feb 2025,Mar 2025,Abr 2025,May 2025,Jun 2025,Promedio,Tendencia,% vs Promedio\n';
                
                // Datos
                data.tableData.forEach(row => {
                    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                // Agregar KPIs actuales
                csvContent += '\n\nKPIs Actuales\n';
                csvContent += '√Årea,KPI,Valor Actual\n';
                data.currentKPIs.forEach(row => {
                    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                // Crear y descargar archivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const fileName = `Dashboard_Agencia_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
                
                showConnectionStatus('‚úÖ CSV descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error exportando a CSV:', error);
                showConnectionStatus('‚ùå Error generando CSV', 'error');
            }
        }

        function prepareExportData() {
            // Preparar datos de tabla comparativa
            const tableData = MONTHLY_COMPARISON_DATA.metrics.map(metric => {
                const average = metric.data.reduce((a, b) => a + b, 0) / metric.data.length;
                const trend = calculateTrend(metric.data);
                const currentValue = metric.data[metric.data.length - 1];
                const varianceFromAvg = ((currentValue - average) / average) * 100;
                
                return [
                    metric.name,
                    ...metric.data.map(val => formatValue(val, metric.format)),
                    formatValue(average, metric.format),
                    `${trend > 0 ? '+' : ''}${trend.toFixed(1)}%`,
                    `${varianceFromAvg > 0 ? '+' : ''}${varianceFromAvg.toFixed(1)}%`
                ];
            });

            // Preparar datos de KPIs actuales
            const currentKPIs = [
                ['Ventas', 'Unidades Vendidas Diarias', document.querySelector('[data-kpi="unidades-vendidas"] .kpi-value')?.textContent || 'N/A'],
                ['Ventas', 'Conversi√≥n Leads', document.querySelector('[data-kpi="conversion-leads"] .kpi-value')?.textContent || 'N/A'],
                ['Ventas', 'Precio Promedio', document.querySelector('[data-kpi="precio-promedio"] .kpi-value')?.textContent || 'N/A'],
                ['Seminuevos', 'Unidades Vendidas', document.querySelector('[data-kpi="unidades-seminuevos"] .kpi-value')?.textContent || 'N/A'],
                ['Seminuevos', 'Margen Bruto', document.querySelector('[data-kpi="margen-seminuevos"] .kpi-value')?.textContent || 'N/A'],
                ['Servicio', '√ìrdenes de Trabajo', document.querySelector('[data-kpi="ordenes-trabajo"] .kpi-value')?.textContent || 'N/A'],
                ['Servicio', 'Ticket Promedio', document.querySelector('[data-kpi="ticket-servicio"] .kpi-value')?.textContent || 'N/A'],
                ['Servicio', 'NPS Score', document.querySelector('[data-kpi="nps-score"] .kpi-value')?.textContent || 'N/A'],
                ['Financiero', 'Flujo de Caja', document.querySelector('[data-kpi="flujo-caja"] .kpi-value')?.textContent || 'N/A'],
                ['Financiero', 'ROI Mensual', document.querySelector('[data-kpi="roi-mensual"] .kpi-value')?.textContent || 'N/A'],
                ['Financiero', 'Cartera Vencida', document.querySelector('[data-kpi="cartera-vencida"] .kpi-value')?.textContent || 'N/A']
            ];

            return { tableData, currentKPIs };
        }

        // ============ CARGAR LIBRER√çAS PARA EXPORTACI√ìN ============
        async function loadExportLibraries() {
            // Cargar SheetJS para Excel
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                document.head.appendChild(script);
                
                return new Promise((resolve) => {
                    script.onload = resolve;
                });
            }
        }

        async function loadPDFLibraries() {
            // Cargar jsPDF
            if (typeof window.jspdf === 'undefined') {
                const jsPDFScript = document.createElement('script');
                jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(jsPDFScript);
                
                await new Promise((resolve) => {
                    jsPDFScript.onload = resolve;
                });
            }

            // Cargar autoTable para jsPDF
            if (typeof window.jspdf?.jsPDF?.API?.autoTable === 'undefined') {
                const autoTableScript = document.createElement('script');
                autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js';
                document.head.appendChild(autoTableScript);
                
                await new Promise((resolve) => {
                    autoTableScript.onload = resolve;
                });
            }
        }

        // ============ ACTUALIZACI√ìN MEJORADA DEL DASHBOARD ============
        async function updateDashboardFromPowerBI() {
            console.log('üîÑ Sincronizando con Power BI...');
            showConnectionStatus('Sincronizando con Power BI...', 'warning');
            
            try {
                // 1. DATOS DE VENTAS
                const ventasData = await executePowerBIQuery('ventasDiarias', POWERBI_CONFIG.datasets.ventasPrincipal);
                if (ventasData) {
                    updateKPI('unidades-vendidas', ventasData['[UnidadesVendidasHoy]'] || 0);
                    updateKPI('conversion-leads', `${(ventasData['[ConversionLeads]'] || 0).toFixed(1)}%`);
                    updateKPI('precio-promedio', `${((ventasData['[PrecioPromedio]'] || 0) / 1000).toFixed(0)}K`);
                }

                // 2. DATOS FINANCIEROS
                const financierosData = await executePowerBIQuery('financieros', POWERBI_CONFIG.datasets.financiero);
                if (financierosData) {
                    updateKPI('flujo-caja', `${((financierosData['[FlujoCajaOperativo]'] || 0) / 1000000).toFixed(1)}M`);
                    updateKPI('roi-mensual', `${(financierosData['[ROIMensual]'] || 0).toFixed(1)}%`);
                    updateKPI('cartera-vencida', `${(financierosData['[CarteraVencida]'] || 0).toFixed(1)}%`);
                    updateKPI('gastos-operativos', `${((financierosData['[GastosOperativos]'] || 0) / 1000).toFixed(0)}K`);
                }

                // 3. DATOS DE SERVICIO
                const servicioData = await executePowerBIQuery('servicio', POWERBI_CONFIG.datasets.servicio);
                if (servicioData) {
                    updateKPI('ordenes-trabajo', servicioData['[OrdenesTrabajoHoy]'] || 0);
                    updateKPI('ticket-servicio', `${(servicioData['[TicketPromedio]'] || 0).toLocaleString()}`);
                    updateKPI('nps-score', servicioData['[NPSScore]'] || 0);
                    updateKPI('eficiencia-taller', `${(servicioData['[EficienciaTaller]'] || 0).toFixed(0)}%`);
                }

                // 4. DATOS DE SEMINUEVOS
                const seminuevosData = await executePowerBIQuery('seminuevos', POWERBI_CONFIG.datasets.inventario);
                if (seminuevosData) {
                    updateKPI('unidades-seminuevos', seminuevosData['[UnidadesSeminuevos]'] || 0);
                    updateKPI('margen-seminuevos', `${(seminuevosData['[MargenBrutoSeminuevos]'] || 0).toFixed(1)}%`);
                    updateKPI('rotacion-inventario', `${(seminuevosData['[RotacionInventario]'] || 0).toFixed(0)}`);
                }

                // 5. ACTUALIZAR DATOS HIST√ìRICOS PARA TABLA COMPARATIVA
                await updateMonthlyDataFromPowerBI();

                console.log('‚úÖ Dashboard actualizado desde Power BI');
                showConnectionStatus('‚úÖ Conectado a Power BI - Datos actualizados', 'success');
                
            } catch (error) {
                console.error('‚ùå Error actualizando desde Power BI:', error);
                showConnectionStatus('‚ùå Error en conexi√≥n Power BI', 'error');
                
                // Usar datos de ejemplo si falla la conexi√≥n
                generateMonthlyComparisonTable();
            }
        }

        // ============ INICIALIZACI√ìN MEJORADA ============
        async function initializeDashboard() {
            console.log('üöÄ Inicializando Dashboard con Power BI...');
            
            // Actualizar fecha actual
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Cargar librer√≠as de exportaci√≥n
            await loadExportLibraries();
            await loadPDFLibraries();

            // Cargar configuraci√≥n guardada
            POWERBI_CONFIG.clientId = localStorage.getItem('powerbi_client_id') || '';
            POWERBI_CONFIG.tenantId = localStorage.getItem('powerbi_tenant_id') || '';
            POWERBI_CONFIG.workspaceId = localStorage.getItem('powerbi_workspace_id') || '';
            POWERBI_CONFIG.datasets.ventasPrincipal = localStorage.getItem('dataset_ventas') || '';
            POWERBI_CONFIG.datasets.financiero = localStorage.getItem('dataset_financiero') || '';
            POWERBI_CONFIG.datasets.servicio = localStorage.getItem('dataset_servicio') || '';
            POWERBI_CONFIG.datasets.inventario = localStorage.getItem('dataset_inventario') || '';

            // Generar tabla comparativa con datos de ejemplo inicialmente
            generateMonthlyComparisonTable();

            // Verificar si hay configuraci√≥n completa
            const hasCompleteConfig = POWERBI_CONFIG.clientId && 
                                     POWERBI_CONFIG.tenantId && 
                                     POWERBI_CONFIG.workspaceId && 
                                     POWERBI_CONFIG.datasets.ventasPrincipal;

            if (hasCompleteConfig) {
                showConnectionStatus('Verificando conexi√≥n a Power BI...', 'warning');
                const connectionValid = await testPowerBIConnection();
                
                if (connectionValid) {
                    // Primera carga de datos
                    await updateDashboardFromPowerBI();
                    
                    // Programar actualizaciones autom√°ticas cada 10 minutos
                    setInterval(updateDashboardFromPowerBI, 10 * 60 * 1000);
                } else {
                    showConnectionStatus('‚ö†Ô∏è Configuraci√≥n incompleta - Haz clic en "‚öôÔ∏è Configurar Power BI"', 'warning');
                }
            } else {
                showConnectionStatus('‚öôÔ∏è Configura la conexi√≥n a Power BI para datos en tiempo real', 'warning');
            }
        }        // ============ CONFIGURACI√ìN ESPEC√çFICA POWER BI ============
        const POWERBI_CONFIG = {
            clientId: '',
            clientSecret: '',
            tenantId: '',
            workspaceId: '',
            datasets: {
                ventasPrincipal: '',
                financiero: '',
                servicio: '',
                inventario: ''
            },
            scopes: ['https://analysis.windows.net/powerbi/api/.default']
        };

        // ============ AUTENTICACI√ìN POWER BI ============
        async function getPowerBIAccessToken() {
            const tokenUrl = `https://login.microsoftonline.com/${POWERBI_CONFIG.tenantId}/oauth2/v2.0/token`;
            
            const body = new URLSearchParams({
                'grant_type': 'client_credentials',
                'client_id': POWERBI_CONFIG.clientId,
                'client_secret': POWERBI_CONFIG.clientSecret,
                'scope': POWERBI_CONFIG.scopes.join(' ')
            });

            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Token Power BI obtenido exitosamente');
                return data.access_token;
            } catch (error) {
                console.error('‚ùå Error getting Power BI token:', error);
                return null;
            }
        }

        // ============ CONSULTAS DAX ESPEC√çFICAS PARA AGENCIA ============
        const DAX_QUERIES = {
            ventasDiarias: `
                EVALUATE
                SUMMARIZECOLUMNS(
                    "UnidadesVendidasHoy", CALCULATE(
                        SUM('Ventas'[Unidades]),
                        'Fecha'[Fecha] = TODAY()
                    ),
                    "ConversionLeads", CALCULATE(
                        DIVIDE(
                            COUNTROWS('Ventas'),
                            COUNTROWS('Leads'),
                            0
                        ) * 100,
                        'Fecha'[Fecha] = TODAY()
                    ),
                    "PrecioPromedio", CALCULATE(
                        AVERAGE('Ventas'[PrecioUnitario]),
                        'Fecha'[Fecha] >= TODAY() - 7
                    )
                )
            `,
            
            financieros: `
                EVALUATE
                SUMMARIZECOLUMNS(
                    "FlujoCajaOperativo", SUM('Financiero'[FlujoCaja]),
                    "ROIMensual", AVERAGE('Financiero'[ROI]),
                    "CarteraVencida", DIVIDE(
                        SUM('Cartera'[Vencida]),
                        SUM('Cartera'[Total]),
                        0
                    ) * 100,
                    "GastosOperativos", SUM('Gastos'[Operativos])
                )
            `,
            
            servicio: `
                EVALUATE
                SUMMARIZECOLUMNS(
                    "OrdenesTrabajoHoy", CALCULATE(
                        COUNTROWS('ServicioOrdenes'),
                        'Fecha'[Fecha] = TODAY()
                    ),
                    "TicketPromedio", AVERAGE('ServicioOrdenes'[Total]),
                    "NPSScore", AVERAGE('Satisfaccion'[NPS]),
                    "EficienciaTaller", DIVIDE(
                        SUM('Taller'[HorasFacturadas]),
                        SUM('Taller'[HorasDisponibles]),
                        0
                    ) * 100
                )
            `,
            
            seminuevos: `
                EVALUATE
                SUMMARIZECOLUMNS(
                    "UnidadesSeminuevos", CALCULATE(
                        SUM('Seminuevos'[Unidades]),
                        'Fecha'[Fecha] = TODAY()
                    ),
                    "MargenBrutoSeminuevos", AVERAGE('Seminuevos'[MargenBruto]),
                    "RotacionInventario", DIVIDE(
                        SUM('Seminuevos'[UnidadesVendidas]),
                        AVERAGE('Seminuevos'[Stock]),
                        0
                    ) * 365
                )
            `
        };

        // ============ EJECUTAR CONSULTAS DAX ============
        async function executePowerBIQuery(queryName, datasetId) {
            const token = await getPowerBIAccessToken();
            
            if (!token) {
                console.error('No se pudo obtener token de Power BI');
                return null;
            }

            const daxQuery = {
                queries: [{ query: DAX_QUERIES[queryName] }],
                serializerSettings: { includeNulls: false }
            };

            try {
                const response = await fetch(
                    `https://api.powerbi.com/v1.0/myorg/groups/${POWERBI_CONFIG.workspaceId}/datasets/${datasetId}/executeQueries`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(daxQuery)
                    }
                );

                if (!response.ok) {
                    throw new Error(`Power BI API error: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                return data.results[0].tables[0].rows[0];
            } catch (error) {
                console.error(`Error ejecutando query ${queryName}:`, error);
                return null;
            }
        }

        // ============ ACTUALIZAR DASHBOARD DESDE POWER BI ============
        async function updateDashboardFromPowerBI() {
            console.log('üîÑ Sincronizando con Power BI...');
            showConnectionStatus('Sincronizando con Power BI...', 'warning');
            
            try {
                // 1. DATOS DE VENTAS
                const ventasData = await executePowerBIQuery('ventasDiarias', POWERBI_CONFIG.datasets.ventasPrincipal);
                if (ventasData) {
                    updateKPI('unidades-vendidas', ventasData['[UnidadesVendidasHoy]'] || 0);
                    updateKPI('conversion-leads', `${(ventasData['[ConversionLeads]'] || 0).toFixed(1)}%`);
                    updateKPI('precio-promedio', `${((ventasData['[PrecioPromedio]'] || 0) / 1000).toFixed(0)}K`);
                }

                // 2. DATOS FINANCIEROS
                const financierosData = await executePowerBIQuery('financieros', POWERBI_CONFIG.datasets.financiero);
                if (financierosData) {
                    updateKPI('flujo-caja', `${((financierosData['[FlujoCajaOperativo]'] || 0) / 1000000).toFixed(1)}M`);
                    updateKPI('roi-mensual', `${(financierosData['[ROIMensual]'] || 0).toFixed(1)}%`);
                    updateKPI('cartera-vencida', `${(financierosData['[CarteraVencida]'] || 0).toFixed(1)}%`);
                    updateKPI('gastos-operativos', `${((financierosData['[GastosOperativos]'] || 0) / 1000).toFixed(0)}K`);
                }

                // 3. DATOS DE SERVICIO
                const servicioData = await executePowerBIQuery('servicio', POWERBI_CONFIG.datasets.servicio);
                if (servicioData) {
                    updateKPI('ordenes-trabajo', servicioData['[OrdenesTrabajoHoy]'] || 0);
                    updateKPI('ticket-servicio', `${(servicioData['[TicketPromedio]'] || 0).toLocaleString()}`);
                    updateKPI('nps-score', servicioData['[NPSScore]'] || 0);
                    updateKPI('eficiencia-taller', `${(servicioData['[EficienciaTaller]'] || 0).toFixed(0)}%`);
                }

                // 4. DATOS DE SEMINUEVOS
                const seminuevosData = await executePowerBIQuery('seminuevos', POWERBI_CONFIG.datasets.inventario);
                if (seminuevosData) {
                    updateKPI('unidades-seminuevos', seminuevosData['[UnidadesSeminuevos]'] || 0);
                    updateKPI('margen-seminuevos', `${(seminuevosData['[MargenBrutoSeminuevos]'] || 0).toFixed(1)}%`);
                    updateKPI('rotacion-inventario', `${(seminuevosData['[RotacionInventario]'] || 0).toFixed(0)}`);
                }

                console.log('‚úÖ Dashboard actualizado desde Power BI');
                showConnectionStatus('‚úÖ Conectado a Power BI - Datos actualizados', 'success');
                
            } catch (error) {
                console.error('‚ùå Error actualizando desde Power BI:', error);
                showConnectionStatus('‚ùå Error en conexi√≥n Power BI', 'error');
            }
        }

        // ============ CONFIGURACI√ìN POWER BI MODAL ============
        function showPowerBIConfigModal() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">üîó Configurar Power BI API</h3>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Application Client ID:</strong></label>
                            <input type="text" id="powerbi-client-id" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="12345678-1234-1234-1234-123456789abc">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Client Secret:</strong></label>
                            <input type="password" id="powerbi-client-secret" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Tu client secret de Azure AD">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Tenant ID:</strong></label>
                            <input type="text" id="powerbi-tenant-id" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="87654321-4321-4321-4321-210987654321">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Workspace ID:</strong></label>
                            <input type="text" id="powerbi-workspace-id" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ID de tu workspace en Power BI">
                        </div>
                        
                        <hr style="margin: 20px 0;">
                        <h4 style="color: #667eea;">Dataset IDs:</h4>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Dataset Ventas Principal:</strong></label>
                            <input type="text" id="dataset-ventas" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ID del dataset de ventas">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Dataset Financiero:</strong></label>
                            <input type="text" id="dataset-financiero" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ID del dataset financiero">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Dataset Servicio:</strong></label>
                            <input type="text" id="dataset-servicio" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ID del dataset de servicio">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label><strong>Dataset Inventario:</strong></label>
                            <input type="text" id="dataset-inventario" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;" placeholder="ID del dataset de inventario">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button onclick="savePowerBIConfig()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üîó Conectar Power BI</button>
                            <button onclick="testPowerBIConnection()" style="flex: 1; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üß™ Probar Conexi√≥n</button>
                            <button onclick="closePowerBIModal()" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">‚ùå Cancelar</button>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                            <h5 style="margin: 0 0 10px 0; color: #2c3e50;">üí° Informaci√≥n:</h5>
                            <ul style="margin: 0; padding-left: 20px; font-size: 0.9em; color: #7f8c8d;">
                                <li>Necesitas configurar una app en Azure AD primero</li>
                                <li>Los Dataset IDs los encuentras en la URL de Power BI</li>
                                <li>Aseg√∫rate de tener permisos de lectura en los datasets</li>
                                <li>La conexi√≥n se probar√° autom√°ticamente al guardar</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.id = 'powerbi-config-modal';
            
            // Cargar valores existentes si los hay
            document.getElementById('powerbi-client-id').value = localStorage.getItem('powerbi_client_id') || '';
            document.getElementById('powerbi-tenant-id').value = localStorage.getItem('powerbi_tenant_id') || '';
            document.getElementById('powerbi-workspace-id').value = localStorage.getItem('powerbi_workspace_id') || '';
            document.getElementById('dataset-ventas').value = localStorage.getItem('dataset_ventas') || '';
            document.getElementById('dataset-financiero').value = localStorage.getItem('dataset_financiero') || '';
            document.getElementById('dataset-servicio').value = localStorage.getItem('dataset_servicio') || '';
            document.getElementById('dataset-inventario').value = localStorage.getItem('dataset_inventario') || '';
        }

        async function savePowerBIConfig() {
            // Guardar configuraci√≥n
            POWERBI_CONFIG.clientId = document.getElementById('powerbi-client-id').value;
            POWERBI_CONFIG.clientSecret = document.getElementById('powerbi-client-secret').value;
            POWERBI_CONFIG.tenantId = document.getElementById('powerbi-tenant-id').value;
            POWERBI_CONFIG.workspaceId = document.getElementById('powerbi-workspace-id').value;
            POWERBI_CONFIG.datasets.ventasPrincipal = document.getElementById('dataset-ventas').value;
            POWERBI_CONFIG.datasets.financiero = document.getElementById('dataset-financiero').value;
            POWERBI_CONFIG.datasets.servicio = document.getElementById('dataset-servicio').value;
            POWERBI_CONFIG.datasets.inventario = document.getElementById('dataset-inventario').value;

            // Guardar en localStorage (excepto el secret por seguridad)
            localStorage.setItem('powerbi_client_id', POWERBI_CONFIG.clientId);
            localStorage.setItem('powerbi_tenant_id', POWERBI_CONFIG.tenantId);
            localStorage.setItem('powerbi_workspace_id', POWERBI_CONFIG.workspaceId);
            localStorage.setItem('dataset_ventas', POWERBI_CONFIG.datasets.ventasPrincipal);
            localStorage.setItem('dataset_financiero', POWERBI_CONFIG.datasets.financiero);
            localStorage.setItem('dataset_servicio', POWERBI_CONFIG.datasets.servicio);
            localStorage.setItem('dataset_inventario', POWERBI_CONFIG.datasets.inventario);
            
            // Probar conexi√≥n
            showConnectionStatus('Probando conexi√≥n a Power BI...', 'warning');
            const connectionSuccess = await testPowerBIConnection();
            
            if (connectionSuccess) {
                closePowerBIModal();
                await updateDashboardFromPowerBI();
                
                // Programar actualizaciones autom√°ticas cada 10 minutos
                setInterval(updateDashboardFromPowerBI, 10 * 60 * 1000);
            }
        }

        async function testPowerBIConnection() {
            try {
                const token = await getPowerBIAccessToken();
                if (token) {
                    // Probar obtener informaci√≥n del workspace
                    const response = await fetch(
                        `https://api.powerbi.com/v1.0/myorg/groups/${POWERBI_CONFIG.workspaceId}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );

                    if (response.ok) {
                        const workspaceData = await response.json();
                        showConnectionStatus(`‚úÖ Conexi√≥n exitosa al workspace: ${workspaceData.name}`, 'success');
                        return true;
                    } else {
                        showConnectionStatus(`‚ùå Error: No se puede acceder al workspace (${response.status})`, 'error');
                        return false;
                    }
                } else {
                    showConnectionStatus('‚ùå Error: No se pudo obtener token de autenticaci√≥n', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error testing Power BI connection:', error);
                showConnectionStatus('‚ùå Error de conexi√≥n: Revisa tu configuraci√≥n', 'error');
                return false;
            }
        }

        function closePowerBIModal() {
            const modal = document.getElementById('powerbi-config-modal');
            if (modal) modal.remove();
        }

        // ============ FUNCIONES AUXILIARES MEJORADAS ============
        function updateKPI(kpiId, value) {
            const kpiElement = document.querySelector(`[data-kpi="${kpiId}"] .kpi-value`);
            if (kpiElement) {
                // Efecto de actualizaci√≥n m√°s llamativo
                kpiElement.style.transition = 'all 0.3s ease';
                kpiElement.style.opacity = '0.5';
                kpiElement.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    kpiElement.textContent = value;
                    kpiElement.style.opacity = '1';
                    kpiElement.style.transform = 'scale(1)';
                    kpiElement.style.color = '#2ecc71'; // Verde para indicar actualizaci√≥n
                    
                    // Agregar indicador de "reci√©n actualizado"
                    const indicator = document.createElement('span');
                    indicator.innerHTML = ' üîÑ';
                    indicator.style.fontSize = '0.8em';
                    indicator.style.color = '#2ecc71';
                    kpiElement.appendChild(indicator);
                    
                    setTimeout(() => {
                        kpiElement.style.color = '#667eea'; // Volver al color original
                        if (indicator.parentNode) {
                            indicator.remove();
                        }
                    }, 3000);
                }, 300);
            }
        }

        function showConnectionStatus(message, type = 'success') {
            const statusDiv = document.getElementById('connection-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                // Auto-hide despu√©s de 5 segundos para mensajes de √©xito
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // ============ INICIALIZACI√ìN ============
        async function initializeDashboard() {
            console.log('üöÄ Inicializando Dashboard con Power BI...');
            
            // Actualizar fecha actual
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Cargar configuraci√≥n guardada
            POWERBI_CONFIG.clientId = localStorage.getItem('powerbi_client_id') || '';
            POWERBI_CONFIG.tenantId = localStorage.getItem('powerbi_tenant_id') || '';
            POWERBI_CONFIG.workspaceId = localStorage.getItem('powerbi_workspace_id') || '';
            POWERBI_CONFIG.datasets.ventasPrincipal = localStorage.getItem('dataset_ventas') || '';
            POWERBI_CONFIG.datasets.financiero = localStorage.getItem('dataset_financiero') || '';
            POWERBI_CONFIG.datasets.servicio = localStorage.getItem('dataset_servicio') || '';
            POWERBI_CONFIG.datasets.inventario = localStorage.getItem('dataset_inventario') || '';

            // Verificar si hay configuraci√≥n completa
            const hasCompleteConfig = POWERBI_CONFIG.clientId && 
                                     POWERBI_CONFIG.tenantId && 
                                     POWERBI_CONFIG.workspaceId && 
                                     POWERBI_CONFIG.datasets.ventasPrincipal;

            if (hasCompleteConfig) {
                showConnectionStatus('Verificando conexi√≥n a Power BI...', 'warning');
                const connectionValid = await testPowerBIConnection();
                
                if (connectionValid) {
                    // Primera carga de datos
                    await updateDashboardFromPowerBI();
                    
                    // Programar actualizaciones autom√°ticas cada 10 minutos
                    setInterval(updateDashboardFromPowerBI, 10 * 60 * 1000);
                } else {
                    showConnectionStatus('‚ö†Ô∏è Configuraci√≥n incompleta - Haz clic en "‚öôÔ∏è Configurar APIs"', 'warning');
                }
            } else {
                showConnectionStatus('‚öôÔ∏è Configura la conexi√≥n a Power BI para comenzar', 'warning');
            }
        }

        // Efectos visuales mejorados
        document.querySelectorAll('.kpi-section').forEach(section => {
            section.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px) scale(1.02)';
                this.style.boxShadow = '0 25px 50px rgba(0, 0, 0, 0.15)';
            });
            
            section.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.1)';
            });
        });

        // Agregar datos KPI para mapeo
        document.addEventListener('DOMContentLoaded', () => {
            // Agregar data-kpi attributes a elementos existentes
            const kpiMappings = [
                { selector: '.ventas .kpi-item:nth-child(1)', kpi: 'unidades-vendidas' },
                { selector: '.ventas .kpi-item:nth-child(2)', kpi: 'conversion-leads' },
                { selector: '.ventas .kpi-item:nth-child(3)', kpi: 'precio-promedio' },
                { selector: '.seminuevos .kpi-item:nth-child(1)', kpi: 'unidades-seminuevos' },
                { selector: '.seminuevos .kpi-item:nth-child(2)', kpi: 'margen-seminuevos' },
                { selector: '.seminuevos .kpi-item:nth-child(3)', kpi: 'rotacion-inventario' },
                { selector: '.servicio .kpi-item:nth-child(1)', kpi: 'ordenes-trabajo' },
                { selector: '.servicio .kpi-item:nth-child(2)', kpi: 'ticket-servicio' },
                { selector: '.servicio .kpi-item:nth-child(3)', kpi: 'nps-score' },
                { selector: '.servicio .kpi-item:nth-child(4)', kpi: 'eficiencia-taller' },
                { selector: '.financiero .kpi-item:nth-child(1)', kpi: 'flujo-caja' },
                { selector: '.financiero .kpi-item:nth-child(2)', kpi: 'roi-mensual' },
                { selector: '.financiero .kpi-item:nth-child(3)', kpi: 'cartera-vencida' },
                { selector: '.financiero .kpi-item:nth-child(4)', kpi: 'gastos-operativos' }
            ];

            kpiMappings.forEach(mapping => {
                const element = document.querySelector(mapping.selector);
                if (element) {
                    element.setAttribute('data-kpi', mapping.kpi);
                }
            });

            // Inicializar dashboard
            initializeDashboard();
        });

        // Cambiar la funci√≥n del bot√≥n de configuraci√≥n para usar Power BI espec√≠ficamente<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ejecutivo - Agencia Automotriz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .kpi-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ventas { border-bottom-color: #e74c3c; }
        .seminuevos { border-bottom-color: #f39c12; }
        .servicio { border-bottom-color: #3498db; }
        .refacciones { border-bottom-color: #9b59b6; }
        .fi { border-bottom-color: #1abc9c; }
        .financiero { border-bottom-color: #2ecc71; }
        .operacional { border-bottom-color: #34495e; }

        .kpi-item {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .kpi-item:hover {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            transform: translateX(5px);
        }

        .kpi-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .kpi-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .kpi-description {
            font-size: 0.85em;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .summary-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .summary-title {
            font-size: 1.6em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .summary-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .summary-item h3 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .status {
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Dashboard Ejecutivo Agencia Automotriz</h1>
            <p>Monitoreo en Tiempo Real - KPIs Estrat√©gicos M√©xico</p>
            <div style="margin-top: 15px; font-size: 0.9em; color: #95a5a6;">
                Actualizado: <span id="currentDate"></span>
            </div>
            <div id="connection-status" class="status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 5px; font-weight: bold;"></div>
            <button onclick="showPowerBIConfigModal()" style="margin-top: 10px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">‚öôÔ∏è Configurar Power BI</button>
        </div>

        <div class="kpi-grid">
            <!-- VENTAS NUEVAS -->
            <div class="kpi-section">
                <div class="section-title ventas">
                    üöó Ventas Nuevas
                </div>
                
                <div class="kpi-item" data-kpi="unidades-vendidas">
                    <div class="kpi-name">Unidades Vendidas Diarias</div>
                    <div class="kpi-value">12</div>
                    <div class="kpi-description">Meta diaria: 15 unidades | Cumplimiento: 80%</div>
                </div>

                <div class="kpi-item" data-kpi="conversion-leads">
                    <div class="kpi-name">Conversi√≥n Leads a Ventas</div>
                    <div class="kpi-value">18%</div>
                    <div class="kpi-description">Leads generados: 67 | Ventas cerradas: 12</div>
                </div>

                <div class="kpi-item" data-kpi="precio-promedio">
                    <div class="kpi-name">Precio Promedio Venta</div>
                    <div class="kpi-value">$485K</div>
                    <div class="kpi-description">Margen bruto promedio: 8.5%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Inventario D√≠as Venta</div>
                    <div class="kpi-value">45</div>
                    <div class="kpi-description">√ìptimo: 35-50 d√≠as | Status: Normal</div>
                </div>
            </div>

            <!-- SEMINUEVOS -->
            <div class="kpi-section">
                <div class="section-title seminuevos">
                    üîÑ Seminuevos
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-name">Unidades Vendidas</div>
                    <div class="kpi-value">8</div>
                    <div class="kpi-description">Meta diaria: 6 | Cumplimiento: 133%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Margen Bruto Promedio</div>
                    <div class="kpi-value">12.3%</div>
                    <div class="kpi-description">Margen objetivo: 10% | Performance: Excelente</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Rotaci√≥n Inventario</div>
                    <div class="kpi-value">32</div>
                    <div class="kpi-description">D√≠as promedio en lote | Meta: <35 d√≠as</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Unidades en Consignaci√≥n</div>
                    <div class="kpi-value">23</div>
                    <div class="kpi-description">Evaluaciones pendientes: 5</div>
                </div>
            </div>

            <!-- SERVICIO -->
            <div class="kpi-section">
                <div class="section-title servicio">
                    üîß Servicio Post-Venta
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-name">√ìrdenes de Trabajo Diarias</div>
                    <div class="kpi-value">45</div>
                    <div class="kpi-description">Capacidad: 55 | Utilizaci√≥n: 82%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Ticket Promedio Servicio</div>
                    <div class="kpi-value">$3,850</div>
                    <div class="kpi-description">Variaci√≥n vs mes anterior: +12%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Satisfacci√≥n Cliente (NPS)</div>
                    <div class="kpi-value">72</div>
                    <div class="kpi-description">Meta: >70 | Promotores: 78%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Eficiencia Taller</div>
                    <div class="kpi-value">95%</div>
                    <div class="kpi-description">Horas facturadas/disponibles</div>
                </div>
            </div>

            <!-- REFACCIONES -->
            <div class="kpi-section">
                <div class="section-title refacciones">
                    ‚öôÔ∏è Refacciones
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-name">Ventas Diarias</div>
                    <div class="kpi-value">$28,500</div>
                    <div class="kpi-description">Meta: $25,000 | Cumplimiento: 114%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Disponibilidad Inventario</div>
                    <div class="kpi-value">87%</div>
                    <div class="kpi-description">Fill Rate | Meta: >85%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Rotaci√≥n Inventario</div>
                    <div class="kpi-value">8.2x</div>
                    <div class="kpi-description">Veces por a√±o | √ìptimo: 6-10x</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Margen Bruto</div>
                    <div class="kpi-value">35%</div>
                    <div class="kpi-description">Margen objetivo: 30-40%</div>
                </div>
            </div>

            <!-- F&I -->
            <div class="kpi-section">
                <div class="section-title fi">
                    üí∞ F&I (Finance & Insurance)
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-name">Penetraci√≥n Financiamiento</div>
                    <div class="kpi-value">78%</div>
                    <div class="kpi-description">Ventas financiadas/Total ventas</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">PVR (Per Vehicle Revenue)</div>
                    <div class="kpi-value">$18,500</div>
                    <div class="kpi-description">Ingresos F&I por unidad vendida</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Penetraci√≥n Seguros</div>
                    <div class="kpi-value">65%</div>
                    <div class="kpi-description">Meta: 60% | Performance: Excelente</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Extensiones Garant√≠a</div>
                    <div class="kpi-value">42%</div>
                    <div class="kpi-description">Penetraci√≥n en ventas nuevas</div>
                </div>
            </div>

            <!-- FINANCIERO -->
            <div class="kpi-section">
                <div class="section-title financiero">
                    üìä Indicadores Financieros
                </div>
                
                <div class="kli-item">
                    <div class="kpi-name">Flujo de Caja Operativo</div>
                    <div class="kpi-value">$2.1M</div>
                    <div class="kpi-description">Mensual | Variaci√≥n: +8%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">ROI Mensual</div>
                    <div class="kpi-value">12.5%</div>
                    <div class="kpi-description">Retorno sobre inversi√≥n</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Cartera Vencida</div>
                    <div class="kpi-value">2.1%</div>
                    <div class="kpi-description">Meta: <3% | Status: Saludable</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Gastos Operativos</div>
                    <div class="kpi-value">$850K</div>
                    <div class="kpi-description">% de ventas: 18.5%</div>
                </div>
            </div>

            <!-- OPERACIONAL -->
            <div class="kpi-section">
                <div class="section-title operacional">
                    ‚ö° Indicadores Operacionales
                </div>
                
                <div class="kpi-item">
                    <div class="kpi-name">Productividad Vendedores</div>
                    <div class="kpi-value">8.5</div>
                    <div class="kpi-description">Unidades/vendedor/mes</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Tiempo Entrega Veh√≠culo</div>
                    <div class="kpi-value">2.8</div>
                    <div class="kpi-description">D√≠as promedio | Meta: <3 d√≠as</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">√çndice Rotaci√≥n Personal</div>
                    <div class="kpi-value">8%</div>
                    <div class="kpi-description">Anual | Meta: <12%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-name">Cumplimiento Est√°ndares</div>
                    <div class="kpi-value">94%</div>
                    <div class="kpi-description">Auditor√≠a marca | Meta: >90%</div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-title">Resumen Ejecutivo Diario</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>$4.2M</h3>
                    <p>Ingresos Totales Mes</p>
                </div>
                <div class="summary-item">
                    <h3>285</h3>
                    <p>Unidades Vendidas YTD</p>
                </div>
                <div class="summary-item">
                    <h3>89%</h3>
                    <p>Satisfacci√≥n Cliente</p>
                </div>
                <div class="summary-item">
                    <h3>15.2%</h3>
                    <p>Margen Neto Total</p>
                </div>
            </div>
        </div>

        <!-- NUEVA TABLA COMPARATIVA MENSUAL -->
        <div class="monthly-comparison-section">
            <div class="section-header">
                <h2 style="color: #2c3e50; margin: 0;">üìà Comparativo Mensual - An√°lisis de Tendencias</h2>
                <div class="export-controls">
                    <button onclick="exportToExcel()" class="export-btn excel">üìä Exportar Excel</button>
                    <button onclick="exportToPDF()" class="export-btn pdf">üìÑ Exportar PDF</button>
                    <button onclick="exportToCSV()" class="export-btn csv">üìã Exportar CSV</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="monthly-comparison-table" class="comparison-table">
                    <thead>
                        <tr>
                            <th rowspan="2">M√©trica</th>
                            <th colspan="6">√öltimos 6 Meses</th>
                            <th rowspan="2">Promedio</th>
                            <th rowspan="2">Tendencia</th>
                            <th rowspan="2">% vs Promedio</th>
                        </tr>
                        <tr>
                            <th>Ene 2025</th>
                            <th>Feb 2025</th>
                            <th>Mar 2025</th>
                            <th>Abr 2025</th>
                            <th>May 2025</th>
                            <th>Jun 2025</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body">
                        <!-- Los datos se llenar√°n autom√°ticamente -->
                    </tbody>
                </table>
            </div>
            
            <div class="trend-legend">
                <div class="legend-item"><span class="trend-up">‚ÜóÔ∏è</span> Tendencia Positiva</div>
                <div class="legend-item"><span class="trend-down">‚ÜòÔ∏è</span> Tendencia Negativa</div>
                <div class="legend-item"><span class="trend-stable">‚û°Ô∏è</span> Tendencia Estable</div>
            </div>
        </div>
    </div>

    <script>
        // ============ DATOS DE COMPARATIVO MENSUAL ============
        const MONTHLY_COMPARISON_DATA = {
            metrics: [
                {
                    name: 'Unidades Vendidas Nuevas',
                    data: [245, 267, 289, 234, 298, 312],
                    format: 'number',
                    target: 280
                },
                {
                    name: 'Unidades Seminuevos',
                    data: [156, 178, 165, 189, 198, 203],
                    format: 'number',
                    target: 180
                },
                {
                    name: 'Ingresos Totales (MXN)',
                    data: [12500000, 13800000, 14200000, 11900000, 15100000, 15800000],
                    format: 'currency',
                    target: 14000000
                },
                {
                    name: 'Margen Bruto (%)',
                    data: [12.5, 13.2, 11.8, 14.1, 13.7, 14.5],
                    format: 'percentage',
                    target: 13.0
                },
                {
                    name: 'Conversi√≥n Leads (%)',
                    data: [16.8, 18.2, 17.5, 19.1, 18.7, 19.8],
                    format: 'percentage',
                    target: 18.0
                },
                {
                    name: 'NPS Servicio',
                    data: [68, 72, 69, 75, 73, 78],
                    format: 'number',
                    target: 70
                },
                {
                    name: '√ìrdenes Servicio Mes',
                    data: [892, 945, 1023, 967, 1089, 1156],
                    format: 'number',
                    target: 1000
                },
                {
                    name: 'Ticket Promedio Servicio',
                    data: [3850, 3920, 3780, 4120, 4050, 4180],
                    format: 'currency',
                    target: 4000
                },
                {
                    name: 'ROI Mensual (%)',
                    data: [11.2, 12.8, 10.9, 13.5, 12.3, 14.1],
                    format: 'percentage',
                    target: 12.0
                },
                {
                    name: 'Rotaci√≥n Inventario (d√≠as)',
                    data: [52, 48, 55, 46, 43, 41],
                    format: 'number',
                    target: 45,
                    inverse: true // Menor es mejor
                }
            ]
        };

        // ============ QUERY DAX PARA DATOS HIST√ìRICOS ============
        const HISTORICAL_DAX_QUERY = `
            EVALUATE
            ADDCOLUMNS(
                SUMMARIZECOLUMNS(
                    'Fecha'[A√±o],
                    'Fecha'[Mes],
                    "UnidadesNuevas", SUM('Ventas'[UnidadesNuevas]),
                    "UnidadesSeminuevos", SUM('Ventas'[UnidadesSeminuevos]),
                    "IngresosTotal", SUM('Ventas'[IngresoTotal]),
                    "MargenBruto", AVERAGE('Ventas'[MargenBruto]),
                    "ConversionLeads", DIVIDE(SUM('Ventas'[Unidades]), SUM('Leads'[Total]), 0) * 100,
                    "NPSServicio", AVERAGE('Servicio'[NPS]),
                    "OrdenesServicio", COUNTROWS('Servicio'),
                    "TicketPromedio", AVERAGE('Servicio'[Total]),
                    "ROI", AVERAGE('Financiero'[ROI]),
                    "RotacionInventario", AVERAGE('Inventario'[DiasRotacion])
                ),
                "Periodo", 'Fecha'[A√±o] & "-" & FORMAT('Fecha'[Mes], "00")
            )
        `;

        // ============ GENERAR TABLA COMPARATIVA ============
        function generateMonthlyComparisonTable() {
            const tableBody = document.getElementById('comparison-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            MONTHLY_COMPARISON_DATA.metrics.forEach(metric => {
                const row = document.createElement('tr');
                
                // Calcular estad√≠sticas
                const average = metric.data.reduce((a, b) => a + b, 0) / metric.data.length;
                const trend = calculateTrend(metric.data);
                const currentValue = metric.data[metric.data.length - 1];
                const varianceFromAvg = ((currentValue - average) / average) * 100;

                // Nombre de m√©trica
                const nameCell = document.createElement('td');
                nameCell.className = 'metric-name';
                nameCell.textContent = metric.name;
                row.appendChild(nameCell);

                // Datos mensuales
                metric.data.forEach(value => {
                    const cell = document.createElement('td');
                    cell.textContent = formatValue(value, metric.format);
                    row.appendChild(cell);
                });

                // Promedio
                const avgCell = document.createElement('td');
                avgCell.textContent = formatValue(average, metric.format);
                avgCell.style.fontWeight = 'bold';
                avgCell.style.backgroundColor = '#f0f8ff';
                row.appendChild(avgCell);

                // Tendencia
                const trendCell = document.createElement('td');
                const trendIcon = getTrendIcon(trend, metric.inverse);
                trendCell.innerHTML = trendIcon;
                row.appendChild(trendCell);

                // Varianza vs promedio
                const varianceCell = document.createElement('td');
                varianceCell.textContent = `${varianceFromAvg > 0 ? '+' : ''}${varianceFromAvg.toFixed(1)}%`;
                varianceCell.className = varianceFromAvg > 5 ? 'positive-variance' : 
                                        varianceFromAvg < -5 ? 'negative-variance' : 'neutral-variance';
                row.appendChild(varianceCell);

                tableBody.appendChild(row);
            });
        }

        // ============ FUNCIONES AUXILIARES ============
        function formatValue(value, format) {
            switch (format) {
                case 'currency':
                    return new Intl.NumberFormat('es-MX', {
                        style: 'currency',
                        currency: 'MXN',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(value);
                case 'percentage':
                    return `${value.toFixed(1)}%`;
                case 'number':
                default:
                    return new Intl.NumberFormat('es-MX').format(Math.round(value));
            }
        }

        function calculateTrend(data) {
            if (data.length < 2) return 0;
            
            const firstHalf = data.slice(0, Math.floor(data.length / 2));
            const secondHalf = data.slice(Math.floor(data.length / 2));
            
            const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            
            return ((secondAvg - firstAvg) / firstAvg) * 100;
        }

        function getTrendIcon(trendValue, inverse = false) {
            const threshold = 5;
            
            if (Math.abs(trendValue) < threshold) {
                return '<span class="trend-stable">‚û°Ô∏è Estable</span>';
            }
            
            const isPositive = inverse ? trendValue < 0 : trendValue > 0;
            
            if (isPositive) {
                return `<span class="trend-up">‚ÜóÔ∏è +${Math.abs(trendValue).toFixed(1)}%</span>`;
            } else {
                return `<span class="trend-down">‚ÜòÔ∏è ${trendValue.toFixed(1)}%</span>`;
            }
        }

        // ============ ACTUALIZAR DATOS DESDE POWER BI ============
        async function updateMonthlyDataFromPowerBI() {
            try {
                const token = await getPowerBIAccessToken();
                if (!token) return;

                const historicalData = await fetch(
                    `https://api.powerbi.com/v1.0/myorg/groups/${POWERBI_CONFIG.workspaceId}/datasets/${POWERBI_CONFIG.datasets.ventasPrincipal}/executeQueries`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            queries: [{ query: HISTORICAL_DAX_QUERY }],
                            serializerSettings: { includeNulls: false }
                        })
                    }
                );

                if (historicalData.ok) {
                    const data = await historicalData.json();
                    const rows = data.results[0].tables[0].rows;
                    
                    // Actualizar MONTHLY_COMPARISON_DATA con datos reales
                    updateMonthlyDataWithPowerBIResults(rows);
                    generateMonthlyComparisonTable();
                    
                    console.log('‚úÖ Datos mensuales actualizados desde Power BI');
                }
            } catch (error) {
                console.error('Error actualizando datos mensuales:', error);
                // Usar datos de ejemplo si falla
                generateMonthlyComparisonTable();
            }
        }

        function updateMonthlyDataWithPowerBIResults(rows) {
            // Procesar los √∫ltimos 6 meses de datos
            const last6Months = rows.slice(-6);
            
            MONTHLY_COMPARISON_DATA.metrics.forEach((metric, index) => {
                switch (index) {
                    case 0: // Unidades Nuevas
                        metric.data = last6Months.map(row => row['[UnidadesNuevas]'] || 0);
                        break;
                    case 1: // Seminuevos
                        metric.data = last6Months.map(row => row['[UnidadesSeminuevos]'] || 0);
                        break;
                    case 2: // Ingresos
                        metric.data = last6Months.map(row => row['[IngresosTotal]'] || 0);
                        break;
                    case 3: // Margen Bruto
                        metric.data = last6Months.map(row => row['[MargenBruto]'] || 0);
                        break;
                    case 4: // Conversi√≥n
                        metric.data = last6Months.map(row => row['[ConversionLeads]'] || 0);
                        break;
                    case 5: // NPS
                        metric.data = last6Months.map(row => row['[NPSServicio]'] || 0);
                        break;
                    case 6: // √ìrdenes Servicio
                        metric.data = last6Months.map(row => row['[OrdenesServicio]'] || 0);
                        break;
                    case 7: // Ticket Promedio
                        metric.data = last6Months.map(row => row['[TicketPromedio]'] || 0);
                        break;
                    case 8: // ROI
                        metric.data = last6Months.map(row => row['[ROI]'] || 0);
                        break;
                    case 9: // Rotaci√≥n
                        metric.data = last6Months.map(row => row['[RotacionInventario]'] || 0);
                        break;
                }
            });
        }
        const API_CONFIG = {
            saleu: {
                baseUrl: 'https://api.sale-u.com/v2/',
                endpoints: {
                    leads: 'leads',
                    sales: 'sales',
                    inventory: 'inventory',
                    customers: 'customers'
                }
            },
            powerbi: {
                workspace: 'tu-workspace-id',
                reportId: 'tu-report-id',
                embedUrl: 'https://app.powerbi.com/reportEmbed'
            },
            googleSheets: {
                spreadsheetId: 'tu-spreadsheet-id',
                apiKey: 'tu-google-api-key',
                ranges: {
                    financial: 'Financiero!A1:Z100',
                    inventory: 'Inventario!A1:Z100',
                    service: 'Servicio!A1:Z100'
                }
            }
        };

        // ============ FUNCIONES DE CONEXI√ìN A APIS ============
        
        // Conexi√≥n a Sale-u CRM
        async function fetchSaleuData(endpoint, params = {}) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const response = await fetch(`${API_CONFIG.saleu.baseUrl}${endpoint}?${queryString}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('saleu_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error(`Sale-u API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching Sale-u data:', error);
                return null;
            }
        }

        // Conexi√≥n a Google Sheets
        async function fetchGoogleSheetsData(range) {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${API_CONFIG.googleSheets.spreadsheetId}/values/${range}?key=${API_CONFIG.googleSheets.apiKey}`
                );
                
                if (!response.ok) throw new Error(`Google Sheets API Error: ${response.status}`);
                const data = await response.json();
                return data.values;
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                return null;
            }
        }

        // Conexi√≥n a Power BI (usando Power BI REST API)
        async function fetchPowerBIData(reportId, datasetId) {
            try {
                const response = await fetch(
                    `https://api.powerbi.com/v1.0/myorg/datasets/${datasetId}/executeQueries`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('powerbi_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            queries: [{
                                query: "EVALUATE SUMMARIZECOLUMNS('Ventas'[Fecha], 'Ventas'[Total])"
                            }],
                            serializerSettings: {
                                includeNulls: true
                            }
                        })
                    }
                );
                
                if (!response.ok) throw new Error(`Power BI API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching Power BI data:', error);
                return null;
            }
        }

        // ============ MAPEO DE DATOS A KPI ============
        
        async function updateKPIsFromDataSources() {
            console.log('üîÑ Actualizando KPIs desde fuentes de datos...');
            
            try {
                // 1. DATOS DE SALE-U (CRM)
                const [leadsData, salesData, inventoryData] = await Promise.all([
                    fetchSaleuData('leads', { date: 'today' }),
                    fetchSaleuData('sales', { date: 'today' }),
                    fetchSaleuData('inventory', { status: 'available' })
                ]);

                // Actualizar KPIs de Ventas desde Sale-u
                if (salesData) {
                    updateKPI('unidades-vendidas', salesData.daily_sales?.count || 0);
                    updateKPI('conversion-leads', 
                        leadsData && salesData ? 
                        ((salesData.daily_sales?.count / leadsData.daily_leads?.count) * 100).toFixed(1) + '%' 
                        : '0%'
                    );
                    updateKPI('precio-promedio', 
                        salesData.daily_sales?.average_price ? 
                        '
</body>
</html> + (salesData.daily_sales.average_price / 1000).toFixed(0) + 'K' 
                        : '$0'
                    );
                }

                // 2. DATOS DE GOOGLE SHEETS
                const [financialData, serviceData] = await Promise.all([
                    fetchGoogleSheetsData(API_CONFIG.googleSheets.ranges.financial),
                    fetchGoogleSheetsData(API_CONFIG.googleSheets.ranges.service)
                ]);

                // Actualizar KPIs Financieros desde Google Sheets
                if (financialData && financialData.length > 1) {
                    const headers = financialData[0];
                    const latestRow = financialData[financialData.length - 1];
                    
                    // Mapear datos por nombre de columna
                    const dataMap = {};
                    headers.forEach((header, index) => {
                        dataMap[header] = latestRow[index];
                    });

                    updateKPI('flujo-caja', dataMap['Flujo_Caja'] ? '
</body>
</html> + (dataMap['Flujo_Caja'] / 1000000).toFixed(1) + 'M' : '$0');
                    updateKPI('roi-mensual', dataMap['ROI'] ? dataMap['ROI'] + '%' : '0%');
                    updateKPI('cartera-vencida', dataMap['Cartera_Vencida'] ? dataMap['Cartera_Vencida'] + '%' : '0%');
                }

                // Actualizar KPIs de Servicio desde Google Sheets
                if (serviceData && serviceData.length > 1) {
                    const serviceHeaders = serviceData[0];
                    const serviceLatestRow = serviceData[serviceData.length - 1];
                    
                    const serviceDataMap = {};
                    serviceHeaders.forEach((header, index) => {
                        serviceDataMap[header] = serviceLatestRow[index];
                    });

                    updateKPI('ordenes-trabajo', serviceDataMap['Ordenes_Diarias'] || '0');
                    updateKPI('ticket-servicio', serviceDataMap['Ticket_Promedio'] ? '
</body>
</html> + serviceDataMap['Ticket_Promedio'] : '$0');
                    updateKPI('nps-score', serviceDataMap['NPS'] || '0');
                }

                // 3. DATOS DE POWER BI (si tienes dataset configurado)
                // Esta secci√≥n requiere configuraci√≥n espec√≠fica de tu dataset de Power BI
                
                console.log('‚úÖ KPIs actualizados exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error actualizando KPIs:', error);
                showConnectionStatus('Error en conexi√≥n', 'error');
            }
        }

        // ============ FUNCIONES AUXILIARES ============
        
        function updateKPI(kpiId, value) {
            const kpiElement = document.querySelector(`[data-kpi="${kpiId}"] .kpi-value`);
            if (kpiElement) {
                // Efecto de actualizaci√≥n
                kpiElement.style.transition = 'all 0.3s ease';
                kpiElement.style.opacity = '0.5';
                kpiElement.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    kpiElement.textContent = value;
                    kpiElement.style.opacity = '1';
                    kpiElement.style.transform = 'scale(1)';
                }, 300);
            }
        }

        function showConnectionStatus(message, type = 'success') {
            const statusDiv = document.getElementById('connection-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // ============ AUTENTICACI√ìN ============
        
        async function authenticateAPIs() {
            // Verificar tokens de autenticaci√≥n
            const saleuToken = localStorage.getItem('saleu_token');
            const powerbiToken = localStorage.getItem('powerbi_token');
            const googleApiKey = localStorage.getItem('google_api_key');

            if (!saleuToken || !powerbiToken || !googleApiKey) {
                console.warn('‚ö†Ô∏è Faltan tokens de autenticaci√≥n. Configure las credenciales.');
                showConnectionStatus('Configure las credenciales de API', 'warning');
                return false;
            }

            return true;
        }

        // ============ INICIALIZACI√ìN ============
        
        async function initializeDashboard() {
            console.log('üöÄ Inicializando Dashboard con conexiones API...');
            
            // Actualizar fecha actual
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Verificar autenticaci√≥n
            const isAuthenticated = await authenticateAPIs();
            
            if (isAuthenticated) {
                // Primera carga de datos
                await updateKPIsFromDataSources();
                
                // Programar actualizaciones autom√°ticas cada 5 minutos
                setInterval(updateKPIsFromDataSources, 5 * 60 * 1000);
                
                showConnectionStatus('Conectado a todas las fuentes de datos', 'success');
            }
        }

        // ============ CONFIGURACI√ìN MANUAL DE CREDENCIALES ============
        
        function showConfigModal() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3>Configurar Conexiones API</h3>
                        <div style="margin: 15px 0;">
                            <label>Sale-u Token:</label>
                            <input type="password" id="saleu-token" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label>Power BI Token:</label>
                            <input type="password" id="powerbi-token" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label>Google API Key:</label>
                            <input type="password" id="google-api-key" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="margin: 15px 0;">
                            <label>Google Sheets ID:</label>
                            <input type="text" id="sheets-id" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="saveConfig()" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px;">Guardar</button>
                            <button onclick="closeModal()" style="flex: 1; padding: 10px; background: #ccc; border: none; border-radius: 5px;">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.id = 'config-modal';
        }

        function saveConfig() {
            localStorage.setItem('saleu_token', document.getElementById('saleu-token').value);
            localStorage.setItem('powerbi_token', document.getElementById('powerbi-token').value);
            localStorage.setItem('google_api_key', document.getElementById('google-api-key').value);
            API_CONFIG.googleSheets.spreadsheetId = document.getElementById('sheets-id').value;
            
            closeModal();
            initializeDashboard();
        }

        function closeModal() {
            const modal = document.getElementById('config-modal');
            if (modal) modal.remove();
        }

        // Efectos visuales
        document.querySelectorAll('.kpi-section').forEach(section => {
            section.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px) scale(1.02)';
            });
            
            section.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Inicializar cuando cargue la p√°gina
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
