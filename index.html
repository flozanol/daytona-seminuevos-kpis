<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Seminuevos - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-2xl shadow-2xl border border-gray-200 p-8 mb-8">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    ğŸ“Š KPIs Seminuevos - Grupo Daytona
                </h1>
                <p class="text-gray-700 text-lg">Dashboard de anÃ¡lisis de KPIs para agencias automotrices</p>
            </div>

            <!-- Test Button -->
            <div class="text-center mb-8">
                <button 
                    onclick="showTestMessage()"
                    class="px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 shadow-lg font-semibold"
                >
                    ğŸ¯ Probar Dashboard
                </button>
            </div>

            <!-- Google Sheets API Connection -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-800">ğŸš€ Google Sheets API - Tiempo Real (RECOMENDADO)</h3>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">ğŸ“‹ Pasos para configurar la API:</h4>
                    <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                        <li>Ve a <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                        <li>Crea un proyecto nuevo: "Daytona-KPIs"</li>
                        <li>Habilita "Google Sheets API"</li>
                        <li>Crea credenciales â†’ "Clave de API"</li>
                        <li>Pega la clave aquÃ­ abajo:</li>
                    </ol>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            ğŸ”‘ Clave API (Pre-configurada):
                        </label>
                        <input 
                            type="text" 
                            id="apiKey"
                            value="AIzaSyDvTKqyK8n9XYxKW2rA9sF3vB1mC4dE5fG"
                            placeholder="Clave API pre-configurada"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm font-mono bg-green-50"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            ğŸ†” ID del Google Sheets:
                        </label>
                        <input 
                            type="text" 
                            id="spreadsheetId"
                            value="1r3_CS8eu9MQz6Zwx0x95xwrHb-xSw1-R7m1aqsEAcQQ"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm font-mono"
                        >
                    </div>
                    
                    <button 
                        onclick="connectWithAPI()"
                        class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
                    >
                        ğŸš€ CONECTAR AHORA (TIEMPO REAL)
                    </button>
                    <p class="text-xs text-green-700 text-center mt-2">âœ… API pre-configurada - Solo presiona conectar</p>
                </div>

                <div id="apiConnectionStatus" class="mt-4 hidden"></div>
            </div>

            <!-- Alternative CSV Connection -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    <h3 class="font-semibold text-gray-800">ğŸ“ MÃ©todo Alternativo - URL Directa</h3>
                </div>
                <div class="text-sm text-gray-700 space-y-2 mb-4">
                    <p><strong>ğŸ“ Si la API no funciona:</strong> Usa la URL directa de tu Google Sheets</p>
                </div>
                
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="googleSheetsUrl"
                        placeholder="https://docs.google.com/spreadsheets/d/TU_ID/edit"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    >
                    <button 
                        onclick="connectSheets()"
                        class="px-6 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 font-semibold"
                    >
                        ğŸ”— Conectar
                    </button>
                </div>

                <div id="connectionResult" class="mt-3 hidden"></div>
            </div>

            <!-- Upload CSV -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    ğŸ“‚ Subir Archivos CSV (Ãšltimo Recurso)
                </h3>
                <input 
                    type="file" 
                    id="csvFiles"
                    accept=".csv"
                    multiple
                    onchange="handleFiles()"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                >
                <p class="text-sm text-gray-600 mt-2">Selecciona uno o varios archivos CSV de tus agencias</p>
                <div id="fileResult" class="mt-4 hidden"></div>
            </div>

            <!-- Status -->
            <div id="status" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-blue-800">Estado:</h4>
                <p id="statusText" class="text-blue-700"></p>
            </div>

            <!-- Results -->
            <div id="results" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ Datos Cargados</h3>
                    <div id="agenciesLoaded" class="space-y-2 mb-6"></div>
                    
                    <!-- ConfiguraciÃ³n de AnÃ¡lisis -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 border border-gray-200 mb-6">
                        <h4 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            âš™ï¸ ConfiguraciÃ³n de AnÃ¡lisis
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- SelecciÃ³n de Agencias -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ¢ <span id="agenciesSelectedCount">Agencias Seleccionadas (0/9)</span>
                                </label>
                                <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white shadow-inner">
                                    <div class="mb-2 pb-2 border-b border-gray-200">
                                        <button onclick="selectAllAgencies()" class="text-xs text-red-600 hover:text-red-800 mr-2 font-medium">
                                            Seleccionar todas
                                        </button>
                                        <button onclick="deselectAllAgencies()" class="text-xs text-gray-600 hover:text-gray-800 font-medium">
                                            Deseleccionar todas
                                        </button>
                                    </div>
                                    <div id="agenciesCheckboxes"></div>
                                </div>
                            </div>

                            <!-- SelecciÃ³n de Meses -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ“… <span id="monthsSelectedCount">Meses Seleccionados (0)</span>
                                </label>
                                <div class="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white">
                                    <div id="monthsCheckboxes"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center">
                            <button onclick="updateAnalysis()" class="px-6 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 font-semibold mr-2">
                                ğŸ”„ Actualizar AnÃ¡lisis
                            </button>
                            <button onclick="refreshData()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 font-semibold">
                                ğŸ“¡ Refrescar Datos
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">ğŸ“Š Vista Previa de KPIs:</h4>
                        <div id="kpiPreview" class="overflow-auto max-h-96 border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">ğŸ“Œ Los nombres de las agencias permanecen fijos arriba mientras haces scroll</p>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border border-red-200">
                            <h5 class="font-medium text-red-800 mb-2">ğŸ¯ Total KPIs</h5>
                            <p class="text-2xl font-bold text-red-600" id="totalKPIs">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-medium text-amber-800 mb-2">ğŸ¢ Agencias</h5>
                            <p class="text-2xl font-bold text-amber-600" id="totalAgencies">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200">
                            <h5 class="font-medium text-orange-800 mb-2">ğŸ“… PerÃ­odos</h5>
                            <p class="text-2xl font-bold text-orange-600" id="totalPeriods">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-gray-50 rounded-lg p-6 mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“‹ Instrucciones:</h3>
                <div class="text-sm text-gray-700 space-y-2">
                    <p><strong>ğŸš€ MÃ‰TODO RECOMENDADO - Google Sheets API:</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>ConexiÃ³n directa en tiempo real</li>
                        <li>Se actualiza automÃ¡ticamente cuando cambies datos</li>
                        <li>Acceso para todo el equipo sin re-cargar archivos</li>
                        <li>Requiere configuraciÃ³n Ãºnica de API (5 minutos)</li>
                    </ul>
                    
                    <p class="mt-4"><strong>ğŸ“ MÃ©todo Alternativo - URL Directa:</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Haz tu documento pÃºblico (Compartir â†’ Cualquier persona con enlace â†’ Visor)</li>
                        <li>Cada hoja debe tener el nombre exacto de la agencia</li>
                        <li>Primera fila: encabezados (KPI, Enero, Febrero, etc.)</li>
                    </ul>

                    <p class="mt-4"><strong>ğŸ“‹ Agencias esperadas:</strong></p>
                    <p class="text-xs bg-gray-100 p-2 rounded font-mono">
                        GWM Iztapalapa, GWM Morelos, Honda Cuajimalpa, Honda Interlomas, 
                        KIA Interlomas, KIA Iztapalapa, MG Cuajimalpa, MG Interlomas, MG Iztapalapa
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Dashboard cargado correctamente');
        
        let loadedData = [];
        let selectedAgencies = [];
        let selectedMonths = [];
        let allKPIs = [];
        let allMonths = [];
        
        function showTestMessage() {
            alert('ğŸ‰ Â¡El dashboard estÃ¡ funcionando correctamente!\n\nAhora puedes:\nâ€¢ Conectar con Google Sheets API (recomendado)\nâ€¢ Conectar tu Google Sheets\nâ€¢ Subir archivos CSV\nâ€¢ Ver los datos procesados');
            loadDemoData();
        }
        
        function loadDemoData() {
            const demoData = [
                {
                    agency: 'Honda Cuajimalpa (DEMO)',
                    kpis: [
                        { 
                            name: 'Ventas Totales', 
                            Enero: 150, Febrero: 180, Marzo: 200, Abril: 175, Mayo: 220, Junio: 195,
                            Julio: 210, Agosto: 185, Septiembre: 205, Octubre: 190, Noviembre: 225, Diciembre: 240
                        },
                        { 
                            name: 'Leads Generados', 
                            Enero: 45, Febrero: 52, Marzo: 48, Abril: 55, Mayo: 62, Junio: 58,
                            Julio: 60, Agosto: 54, Septiembre: 59, Octubre: 56, Noviembre: 65, Diciembre: 70
                        },
                        { 
                            name: 'ConversiÃ³n %', 
                            Enero: 12.5, Febrero: 15.2, Marzo: 14.8, Abril: 16.1, Mayo: 18.3, Junio: 17.2,
                            Julio: 19.0, Agosto: 16.8, Septiembre: 17.9, Octubre: 18.1, Noviembre: 19.8, Diciembre: 21.2
                        }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                },
                {
                    agency: 'KIA Interlomas (DEMO)',
                    kpis: [
                        { 
                            name: 'Ventas Totales', 
                            Enero: 120, Febrero: 160, Marzo: 190, Abril: 145, Mayo: 200, Junio: 175,
                            Julio: 195, Agosto: 170, Septiembre: 185, Octubre: 180, Noviembre: 210, Diciembre: 220
                        },
                        { 
                            name: 'Leads Generados', 
                            Enero: 40, Febrero: 48, Marzo: 55, Abril: 52, Mayo: 58, Junio: 54,
                            Julio: 56, Agosto: 50, Septiembre: 53, Octubre: 51, Noviembre: 60, Diciembre: 65
                        },
                        { 
                            name: 'ConversiÃ³n %', 
                            Enero: 10.8, Febrero: 13.7, Marzo: 16.2, Abril: 14.5, Mayo: 17.1, Junio: 15.8,
                            Julio: 16.9, Agosto: 15.2, Septiembre: 16.5, Octubre: 15.9, Noviembre: 18.3, Diciembre: 19.1
                        }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                }
            ];
            
            displayResults(demoData);
            showStatus('success', 'âœ… Datos de demostraciÃ³n cargados correctamente - Estructura: KPI,Enero,Febrero,Marzo...');
        }
        
        // Google Sheets API Functions
        function connectWithAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            // Check if data is already loaded from session
            const savedData = sessionStorage.getItem('daytonaDashboardData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    displayResults(parsedData);
                    showAPIConnectionResult('success', `âœ… Datos cargados desde sesiÃ³n: ${parsedData.length} agencias`);
                    showStatus('success', `âœ… Datos disponibles desde sesiÃ³n anterior`);
                    return;
                } catch (error) {
                    console.log('No se pudieron cargar datos de sesiÃ³n:', error);
                }
            }
            
            if (!apiKey) {
                alert('âŒ Clave API requerida. Contacta al administrador para obtenerla.');
                return;
            }
            
            if (!spreadsheetId) {
                alert('âŒ Por favor ingresa el ID del Google Sheets');
                return;
            }
            
            showStatus('loading', 'ğŸ”„ Conectando con Google Sheets API...');
            showAPIConnectionResult('loading', 'ğŸ”„ Conectando con API...');
            
            performAPIConnection(apiKey, spreadsheetId);
        }
        
        async function performAPIConnection(apiKey, spreadsheetId) {
            try {
                console.log('ğŸ”‘ Usando API Key:', apiKey.substring(0, 20) + '...');
                console.log('ğŸ†” Spreadsheet ID:', spreadsheetId);
                
                // Get spreadsheet metadata to find all sheets
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
                console.log('ğŸ“¡ Obteniendo metadata:', metadataUrl);
                
                const metadataResponse = await fetch(metadataUrl);
                if (!metadataResponse.ok) {
                    const errorText = await metadataResponse.text();
                    console.error('âŒ Error metadata:', errorText);
                    throw new Error(`Error de API (${metadataResponse.status}): Verifica que la clave API sea correcta y que el Google Sheets sea pÃºblico.`);
                }
                
                const metadata = await metadataResponse.json();
                console.log('ğŸ“Š Metadata recibida:', metadata);
                
                const sheets = metadata.sheets || [];
                const sheetNames = sheets.map(sheet => sheet.properties.title);
                console.log('ğŸ“‹ Hojas encontradas:', sheetNames);
                
                // Filter to expected agency names
                const expectedAgencies = [
                    'GWM Iztapalapa', 'GWM Morelos', 'Honda Cuajimalpa', 'Honda Interlomas', 
                    'KIA Interlomas', 'KIA Iztapalapa', 'MG Cuajimalpa', 'MG Interlomas', 'MG Iztapalapa'
                ];
                
                const availableSheets = sheetNames.filter(name => 
                    expectedAgencies.includes(name) || 
                    expectedAgencies.some(agency => name.includes(agency.split(' ')[0]))
                );
                
                console.log('ğŸ¯ Hojas vÃ¡lidas encontradas:', availableSheets);
                
                if (availableSheets.length === 0) {
                    throw new Error(`No se encontraron hojas con nombres esperados.\n\nHojas disponibles: ${sheetNames.join(', ')}\n\nHojas esperadas: ${expectedAgencies.join(', ')}`);
                }
                
                // Fetch data from each sheet
                const loadedAgencies = [];
                const errors = [];
                const successes = [];
                
                for (const sheetName of availableSheets) {
                    try {
                        console.log(`ğŸ“Š Cargando datos de: ${sheetName}`);
                        
                        // Get data from sheet (A:Z to cover all columns)
                        const range = `${sheetName}!A:Z`;
                        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
                        
                        console.log(`ğŸ”— URL datos: ${dataUrl}`);
                        
                        const dataResponse = await fetch(dataUrl);
                        if (!dataResponse.ok) {
                            const errorText = await dataResponse.text();
                            console.error(`âŒ Error ${sheetName}:`, errorText);
                            errors.push(`${sheetName}: Error ${dataResponse.status}`);
                            continue;
                        }
                        
                        const sheetData = await dataResponse.json();
                        console.log(`ğŸ“ˆ Datos de ${sheetName}:`, sheetData);
                        
                        if (!sheetData.values || sheetData.values.length < 2) {
                            errors.push(`${sheetName}: Sin datos suficientes`);
                            continue;
                        }
                        
                        // Convert array format to object format
                        const headers = sheetData.values[0];
                        const rows = sheetData.values.slice(1);
                        
                        const objectData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        console.log(`ğŸ“‹ Headers de ${sheetName}:`, headers);
                        console.log(`ğŸ“Š Filas procesadas de ${sheetName}:`, objectData.length);
                        
                        // Process the data
                        const processedData = processCSVData(objectData, sheetName);
                        if (processedData && processedData.kpis.length > 0) {
                            loadedAgencies.push(processedData);
                            successes.push(`âœ… ${sheetName}: ${processedData.kpis.length} KPIs, ${processedData.months.length} meses`);
                        } else {
                            errors.push(`${sheetName}: No se pudieron procesar los KPIs`);
                        }
                        
                    } catch (error) {
                        console.error(`âŒ
