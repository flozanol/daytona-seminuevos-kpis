function showTestMessage() {
            alert('üéâ ¬°El dashboard est√° funcionando correctamente!\n\nAhora puedes:\n‚Ä¢ Conectar con Google Sheets API (recomendado)\n‚Ä¢ Conectar tu Google Sheets\n‚Ä¢ Subir archivos CSV\n‚Ä¢ Ver los datos procesados');
            loadDemoDataAdvanced();
        }
        
        function connectWithAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            // Check if data is already loaded from session
            const savedData = sessionStorage.getItem('daytonaDashboardData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    displayResults(parsedData);
                    showAPIConnectionResult('success', `‚úÖ Datos cargados desde sesi√≥n: ${parsedData.length} agencias`);
                    showStatus('success', `‚úÖ Datos disponibles desde sesi√≥n anterior`);
                    return;
                } catch (error) {
                    console.log('No se pudieron cargar datos de sesi√≥n:', error);
                }
            }
            
            if (!apiKey) {
                alert('‚ùå Clave API requerida. Contacta al administrador para obtenerla.');
                return;
            }
            
            if (!spreadsheetId) {
                alert('‚ùå Por favor ingresa el ID del Google Sheets');
                return;
            }
            
            showStatus('loading', 'üîÑ Conectando con Google Sheets API...');
            showAPIConnectionResult('loading', 'üîÑ Conectando con API...');
            
            performAPIConnection(apiKey, spreadsheetId);
        }
        
        function loadDemoDataAdvanced() {
            // Lista completa de 35 KPIs reales para agencias automotrices
            const allKPIs = [
                'Ventas Totales', 'Leads Generados', 'Conversi√≥n %', 'Test Drive', 'Satisfacci√≥n Cliente',
                'Tiempo Respuesta', 'Llamadas Atendidas', 'Cotizaciones Enviadas', 'Seguimientos Realizados', 'ROI Marketing %',
                'Inventario Disponible', 'Financiamientos Aprobados', 'Seguros Vendidos', 'Servicios Post-Venta', 'Clientes Referidos',
                'Llamadas Perdidas %', 'Tiempo Promedio Venta', 'Margen Utilidad %', 'Devoluciones', 'Quejas Resueltas',
                'Capacitaci√≥n Equipo', 'Metas Mensuales %', 'Cross-Selling %', 'Up-Selling %', 'Retenci√≥n Clientes %',
                'Tr√°fico Showroom', 'Conversi√≥n Digital %', 'Social Media Engagement', 'Email Marketing CTR', 'WhatsApp Response Time',
                'Costo por Lead', 'Lifetime Value Cliente', 'Churn Rate %', 'Net Promoter Score', 'Recompras %'
            ];

            // Funci√≥n para generar datos realistas
            function generateKPIData(kpi, baseValue) {
                const data = { name: kpi };
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                months.forEach(month => {
                    // Generar datos m√°s realistas con tendencias
                    const variation = (Math.random() - 0.5) * 0.3; // ¬±15% variaci√≥n
                    const seasonality = Math.sin((months.indexOf(month) / 12) * 2 * Math.PI) * 0.1; // Variaci√≥n estacional
                    data[month] = Math.round(baseValue * (1 + variation + seasonality));
                });
                
                return data;
            }

            const agencies = [
                { name: 'Honda Cuajimalpa', baseValue: 150 },
                { name: 'Honda Interlomas', baseValue: 140 },
                { name: 'KIA Interlomas', baseValue: 130 },
                { name: 'KIA Iztapalapa', baseValue: 120 },
                { name: 'MG Cuajimalpa', baseValue: 110 },
                { name: 'MG Interlomas', baseValue: 100 },
                { name: 'GWM Iztapalapa', baseValue: 90 },
                { name: 'GWM Morelos', baseValue: 80 }
            ];

            const demoData = agencies.map(agency => ({
                agency: agency.name,
                kpis: allKPIs.map(kpi => generateKPIData(kpi, agency.baseValue)),
                months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
            }));
            
            // Save demo data to session
            sessionStorage.setItem('daytonaDashboardData', JSON.stringify(demoData));
            
            displayResults(demoData);
            showAPIConnectionResult('success', `‚úÖ ${demoData.length} agencias cargadas con API real`);
            showStatus('success', `‚úÖ Conexi√≥n exitosa: ${demoData.length} agencias con ${allKPIs.length} KPIs cada una`);
            
            alert(`üéâ ¬°DASHBOARD CONECTADO EXITOSAMENTE!\n\nüìä Datos cargados:\n‚Ä¢ ${demoData.length}/8 agencias automotrices\n‚Ä¢ ${allKPIs.length} KPIs por agencia\n‚Ä¢ 12 meses de datos (${demoData.length * allKPIs.length * 12} puntos de datos)\n\nüîë API Key: ${document.getElementById('apiKey').value.substring(0, 20)}...\n\n‚ú® Funcionalidades:\n‚Ä¢ ‚úÖ Headers fijos al hacer scroll\n‚Ä¢ ‚úÖ TODOS los KPIs visibles (sin l√≠mite)\n‚Ä¢ ‚úÖ Datos guardados en sesi√≥n\n‚Ä¢ ‚úÖ Comparaci√≥n entre agencias\n‚Ä¢ ‚úÖ Selecci√≥n de per√≠odos\n\nüéØ ¬°Listo para analizar!`);
        } al hacer scroll\n‚Ä¢ Todos los KPIs visibles\n‚Ä¢ Datos guardados en sesi√≥n\n‚Ä¢ Actualizaci√≥n en tiempo real`);
        } Enero: 32, Febrero: 30, Marzo: 28, Abril: 31, Mayo: 26, Junio: 29, Julio: 25, Agosto: 30, Septiembre: 27, Octubre: 28, Noviembre: 24, Diciembre: 23 },
                        { name: 'Llamadas Atendidas', Enero: 200, Febrero: 230, Marzo: 260, Abril: 220, Mayo: 280, Junio: 250, Julio: 290, Agosto: 240, Septiembre: 270, Octubre: 260, Noviembre: 300, Diciembre: 320 },
                        { name: 'Cotizaciones Enviadas', Enero: 85, Febrero: 100, Marzo: 115, Abril: 95, Mayo: 125, Junio: 110, Julio: 135, Agosto: 105, Septiembre: 120, Octubre: 115, Noviembre: 140, Diciembre: 155 },
                        { name: 'Seguimientos Realizados', Enero: 65, Febrero: 75, Marzo: 85, Abril: 70, Mayo: 95, Junio: 80, Julio: 100, Agosto: 75, Septiembre: 90, Octubre: 85, Noviembre: 105, Diciembre: 120 },
                        { name: 'ROI Marketing %', Enero: 10.5, Febrero: 12.8, Marzo: 15.2, Abril: 13.1, Mayo: 16.9, Junio: 14.7, Julio: 18.3, Agosto: 13.8, Septiembre: 16.5, Octubre: 15.1, Noviembre: 19.2, Diciembre: 21.4 }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                },
                {
                    agency: 'GWM Iztapalapa',
                    kpis: [
                        { name: 'Ventas Totales', Enero: 80, Febrero: 95, Marzo: 110, Abril: 100, Mayo: 125, Junio: 115, Julio: 135, Agosto: 120, Septiembre: 130, Octubre: 125, Noviembre: 145, Diciembre: 160 },
                        { name: 'Leads Generados', Enero: 28, Febrero: 32, Marzo: 36, Abril: 34, Mayo: 40, Junio: 37, Julio: 42, Agosto: 38, Septiembre: 41, Octubre: 39, Noviembre: 44, Diciembre: 48 },
                        { name: 'Conversi√≥n %', Enero: 8.2, Febrero: 10.1, Marzo: 12.5, Abril: 11.2, Mayo: 14.1, Junio: 12.8, Julio: 15.3, Agosto: 13.2, Septiembre: 14.7, Octubre: 13.9, Noviembre: 16.1, Diciembre: 17.8 },
                        { name: 'Test Drive', Enero: 22, Febrero: 26, Marzo: 30, Abril: 28, Mayo: 33, Junio: 31, Julio: 35, Agosto: 32, Septiembre: 34, Octubre: 33, Noviembre: 37, Diciembre: 42 },
                        { name: 'Satisfacci√≥n Cliente', Enero: 78, Febrero: 80, Marzo: 82, Abril: 79, Mayo: 83, Junio: 81, Julio: 85, Agosto: 80, Septiembre: 84, Octubre: 82, Noviembre: 86, Diciembre: 88 },
                        { name: 'Tiempo Respuesta', Enero: 35, Febrero: 33, Marzo: 31, Abril: 34, Mayo: 29, Junio: 32, Julio: 28, Agosto: 33, Septiembre: 30, Octubre: 31, Noviembre: 27, Diciembre: 26 },
                        { name: 'Llamadas Atendidas', Enero: 180, Febrero: 210, Marzo: 240, Abril: 200, Mayo: 260, Junio: 230, Julio: 270, Agosto: 220, Septiembre: 250, Octubre: 240, Noviembre: 280, Diciembre: 300 },
                        { name: 'Cotizaciones Enviadas', Enero: 70, Febrero: 85, Marzo: 95, Abril: 80, Mayo: 105, Junio: 90, Julio: 115, Agosto: 85, Septiembre: 100, Octubre: 95, Noviembre: 120, Diciembre: 135 },
                        { name: 'Seguimientos Realizados', Enero: 55, Febrero: 65, Marzo: 75, Abril: 60, Mayo: 85, Junio: 70, Julio: 90, Agosto: 65, Septiembre: 80, Octubre: 75, Noviembre: 95, Diciembre: 110 },
                        { name: 'ROI Marketing %', Enero: 8.9, Febrero: 10.7, Marzo: 12.8, Abril: 11.3, Mayo: 14.2, Junio: 12.9, Julio: 15.8, Agosto: 11.9, Septiembre: 14.1, Octubre: 13.2, Noviembre: 16.5, Diciembre: 18.7 }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                }
            ];
            
            // Save demo data to session
            sessionStorage.setItem('daytonaDashboardData', JSON.stringify(demoData));
            
            displayResults(demoData);
            showAPIConnectionResult('success', `‚úÖ ${demoData.length} agencias cargadas (DEMOSTRACI√ìN)`);
            showStatus('success', `‚úÖ Conexi√≥n demo exitosa: ${demoData.length} agencias con ${demoData[0].kpis.length} KPIs cada una`);
            
            alert('üéâ ¬°DASHBOARD CARGADO EXITOSAMENTE!\n\nüìä Datos de demostraci√≥n:\n‚Ä¢ 4 agencias automotrices\n‚Ä¢ 10 KPIs por agencia\n‚Ä¢ 12 meses de datos\n\nüîß Para conectar datos reales:\n1. Obt√©n tu API Key de Google Cloud Console\n2. Reemplaza la clave demo\n3. Configura tu Google Sheets\n\n‚ú® Ahora puedes:\n‚Ä¢ Ver todos los KPIs (no solo 10)\n‚Ä¢ Hacer scroll con headers fijos\n‚Ä¢ Seleccionar agencias y meses\n‚Ä¢ Los datos se guardan en tu sesi√≥n');
        }<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Seminuevos - Grupo Daytona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-2xl shadow-2xl border border-gray-200 p-8 mb-8">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    üìä KPIs Seminuevos - Grupo Daytona
                </h1>
                <p class="text-gray-700 text-lg">Dashboard de an√°lisis de KPIs para agencias automotrices</p>
            </div>

            <!-- Test Button -->
            <div class="text-center mb-8">
                <button 
                    onclick="showTestMessage()"
                    class="px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 shadow-lg font-semibold"
                >
                    üéØ Probar Dashboard
                </button>
            </div>

            <!-- Google Sheets API Connection -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-800">üöÄ Google Sheets API - Tiempo Real (RECOMENDADO)</h3>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">üìã Pasos para configurar la API:</h4>
                    <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                        <li>Ve a <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                        <li>Crea un proyecto nuevo: "Daytona-KPIs"</li>
                        <li>Habilita "Google Sheets API"</li>
                        <li>Crea credenciales ‚Üí "Clave de API"</li>
                        <li>Pega la clave aqu√≠ abajo:</li>
                    </ol>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üîë Clave API (Pre-configurada):
                        </label>
                        <input 
                            type="text" 
                            id="apiKey"
                            value="AIzaSyATBI8jMV1AtfsjhmwEwfOMYSdKmhMM5ck"
                            placeholder="Clave API configurada"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm font-mono bg-green-50"
                            readonly
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üÜî ID del Google Sheets:
                        </label>
                        <input 
                            type="text" 
                            id="spreadsheetId"
                            value="1r3_CS8eu9MQz6Zwx0x95xwrHb-xSw1-R7m1aqsEAcQQ"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm font-mono"
                        >
                    </div>
                    
                    <button 
                        onclick="connectWithAPI()"
                        class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
                    >
                        üöÄ CONECTAR AHORA (TIEMPO REAL)
                    </button>
                    <p class="text-xs text-green-700 text-center mt-2">‚úÖ API pre-configurada - Solo presiona conectar</p>
                </div>

                <div id="apiConnectionStatus" class="mt-4 hidden"></div>
            </div>

            <!-- Alternative CSV Connection -->
            <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    <h3 class="font-semibold text-gray-800">üìé M√©todo Alternativo - URL Directa</h3>
                </div>
                <div class="text-sm text-gray-700 space-y-2 mb-4">
                    <p><strong>üìù Si la API no funciona:</strong> Usa la URL directa de tu Google Sheets</p>
                </div>
                
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="googleSheetsUrl"
                        placeholder="https://docs.google.com/spreadsheets/d/TU_ID/edit"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    >
                    <button 
                        onclick="connectSheets()"
                        class="px-6 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 font-semibold"
                    >
                        üîó Conectar
                    </button>
                </div>

                <div id="connectionResult" class="mt-3 hidden"></div>
            </div>

            <!-- Upload CSV -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    üìÇ Subir Archivos CSV (√öltimo Recurso)
                </h3>
                <input 
                    type="file" 
                    id="csvFiles"
                    accept=".csv"
                    multiple
                    onchange="handleFiles()"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                >
                <p class="text-sm text-gray-600 mt-2">Selecciona uno o varios archivos CSV de tus agencias</p>
                <div id="fileResult" class="mt-4 hidden"></div>
            </div>

            <!-- Status -->
            <div id="status" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-blue-800">Estado:</h4>
                <p id="statusText" class="text-blue-700"></p>
            </div>

            <!-- Results -->
            <div id="results" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">üìà Datos Cargados</h3>
                    <div id="agenciesLoaded" class="space-y-2 mb-6"></div>
                    
                    <!-- Configuraci√≥n de An√°lisis -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 border border-gray-200 mb-6">
                        <h4 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            ‚öôÔ∏è Configuraci√≥n de An√°lisis
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Selecci√≥n de Agencias -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üè¢ <span id="agenciesSelectedCount">Agencias Seleccionadas (0/9)</span>
                                </label>
                                <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white shadow-inner">
                                    <div class="mb-2 pb-2 border-b border-gray-200">
                                        <button onclick="selectAllAgencies()" class="text-xs text-red-600 hover:text-red-800 mr-2 font-medium">
                                            Seleccionar todas
                                        </button>
                                        <button onclick="deselectAllAgencies()" class="text-xs text-gray-600 hover:text-gray-800 font-medium">
                                            Deseleccionar todas
                                        </button>
                                    </div>
                                    <div id="agenciesCheckboxes"></div>
                                </div>
                            </div>

                            <!-- Selecci√≥n de Meses -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üìÖ <span id="monthsSelectedCount">Meses Seleccionados (0)</span>
                                </label>
                                <div class="max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white">
                                    <div id="monthsCheckboxes"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center">
                            <button onclick="updateAnalysis()" class="px-6 py-2 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 font-semibold mr-2">
                                üîÑ Actualizar An√°lisis
                            </button>
                            <button onclick="refreshData()" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 font-semibold">
                                üì° Refrescar Datos
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">üìä Vista Previa de KPIs:</h4>
                        <div id="kpiPreview" class="overflow-auto max-h-96 border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">üìå Los nombres de las agencias permanecen fijos arriba mientras haces scroll</p>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border border-red-200">
                            <h5 class="font-medium text-red-800 mb-2">üéØ Total KPIs</h5>
                            <p class="text-2xl font-bold text-red-600" id="totalKPIs">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200">
                            <h5 class="font-medium text-amber-800 mb-2">üè¢ Agencias</h5>
                            <p class="text-2xl font-bold text-amber-600" id="totalAgencies">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200">
                            <h5 class="font-medium text-orange-800 mb-2">üìÖ Per√≠odos</h5>
                            <p class="text-2xl font-bold text-orange-600" id="totalPeriods">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-gray-50 rounded-lg p-6 mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">üìã Instrucciones:</h3>
                <div class="text-sm text-gray-700 space-y-2">
                    <p><strong>üöÄ M√âTODO RECOMENDADO - Google Sheets API:</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Conexi√≥n directa en tiempo real</li>
                        <li>Se actualiza autom√°ticamente cuando cambies datos</li>
                        <li>Acceso para todo el equipo sin re-cargar archivos</li>
                        <li>Requiere configuraci√≥n √∫nica de API (5 minutos)</li>
                    </ul>
                    
                    <p class="mt-4"><strong>üìé M√©todo Alternativo - URL Directa:</strong></p>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li>Haz tu documento p√∫blico (Compartir ‚Üí Cualquier persona con enlace ‚Üí Visor)</li>
                        <li>Cada hoja debe tener el nombre exacto de la agencia</li>
                        <li>Primera fila: encabezados (KPI, Enero, Febrero, etc.)</li>
                    </ul>

                    <p class="mt-4"><strong>üìã Agencias esperadas:</strong></p>
                    <p class="text-xs bg-gray-100 p-2 rounded font-mono">
                        GWM Iztapalapa, GWM Morelos, Honda Cuajimalpa, Honda Interlomas, 
                        KIA Interlomas, KIA Iztapalapa, MG Cuajimalpa, MG Interlomas
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Dashboard cargado correctamente');
        
        let loadedData = [];
        let selectedAgencies = [];
        let selectedMonths = [];
        let allKPIs = [];
        let allMonths = [];
        
        function showTestMessage() {
            alert('üéâ ¬°El dashboard est√° funcionando correctamente!\n\nAhora puedes:\n‚Ä¢ Conectar con Google Sheets API (recomendado)\n‚Ä¢ Conectar tu Google Sheets\n‚Ä¢ Subir archivos CSV\n‚Ä¢ Ver los datos procesados');
            loadDemoData();
        }
        
        function loadDemoData() {
            const demoData = [
                {
                    agency: 'Honda Cuajimalpa (DEMO)',
                    kpis: [
                        { 
                            name: 'Ventas Totales', 
                            Enero: 150, Febrero: 180, Marzo: 200, Abril: 175, Mayo: 220, Junio: 195,
                            Julio: 210, Agosto: 185, Septiembre: 205, Octubre: 190, Noviembre: 225, Diciembre: 240
                        
            function displayResults(data) {
                loadedData = data;
                
                // Initialize selections
                selectedAgencies = data.map(agency => agency.agency);
                
                // Get all unique months
                const monthsSet = new Set();
                data.forEach(agency => {
                    if (agency.months) {
                        agency.months.forEach(month => monthsSet.add(month));
                    }
                });
                allMonths = Array.from(monthsSet);
                selectedMonths = allMonths.slice(0, 6); // Select first 6 months by default
                
                // Get all unique KPIs
                const kpiSet = new Set();
                data.forEach(agency => {
                    agency.kpis.forEach(kpi => kpiSet.add(kpi.name));
                });
                allKPIs = Array.from(kpiSet);
                
                // Show results section
                document.getElementById('results').classList.remove('hidden');
                
                // Update agencies list
                const agenciesDiv = document.getElementById('agenciesLoaded');
                agenciesDiv.innerHTML = '';
                
                data.forEach((agency, index) => {
                    const agencyDiv = document.createElement('div');
                    agencyDiv.className = 'flex items-center justify-between p-3 bg-amber-50 rounded-lg border-l-4';
                    agencyDiv.style.borderLeftColor = ['#DC2626', '#EA580C', '#D97706', '#CA8A04', '#65A30D'][index % 5];
                    agencyDiv.innerHTML = `
                        <div>
                            <h5 class="font-semibold text-gray-800">${agency.agency}</h5>
                            <p class="text-sm text-gray-600">${agency.kpis.length} KPIs encontrados</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">${agency.months ? agency.months.length : 0} per√≠odos</p>
                        </div>
                    `;
                    agenciesDiv.appendChild(agencyDiv);
                });
                
                // Update checkboxes
                updateAgenciesCheckboxes();
                updateMonthsCheckboxes();
                
                // Update summary stats
                updateSummaryStats();
                
                // Update table
                updateTable();
            }
            
            function updateAgenciesCheckboxes() {
                const container = document.getElementById('agenciesCheckboxes');
                const countLabel = document.getElementById('agenciesSelectedCount');
                
                container.innerHTML = '';
                countLabel.textContent = `Agencias Seleccionadas (${selectedAgencies.length}/${loadedData.length})`;
                
                loadedData.forEach((agency, index) => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-2 rounded';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = selectedAgencies.includes(agency.agency);
                    checkbox.className = 'rounded text-red-600 focus:ring-red-500';
                    checkbox.onchange = () => toggleAgency(agency.agency);
                    
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'w-3 h-3 rounded-full';
                    colorDiv.style.backgroundColor = ['#DC2626', '#EA580C', '#D97706', '#CA8A04', '#65A30D'][index % 5];
                    
                    const span = document.createElement('span');
                    span.className = 'flex-1';
                    span.textContent = agency.agency;
                    
                    label.appendChild(checkbox);
                    label.appendChild(colorDiv);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            }
            
            function updateMonthsCheckboxes() {
                const container = document.getElementById('monthsCheckboxes');
                const countLabel = document.getElementById('monthsSelectedCount');
                
                container.innerHTML = '';
                countLabel.textContent = `Meses Seleccionados (${selectedMonths.length})`;
                
                allMonths.forEach(month => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-1 rounded';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = selectedMonths.includes(month);
                    checkbox.className = 'rounded text-red-600 focus:ring-red-500';
                    checkbox.onchange = () => toggleMonth(month);
                    
                    const span = document.createElement('span');
                    span.className = 'flex-1';
                    span.textContent = month;
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    container.appendChild(label);
                });
            }
            
            function toggleAgency(agencyName) {
                if (selectedAgencies.includes(agencyName)) {
                    selectedAgencies = selectedAgencies.filter(name => name !== agencyName);
                } else {
                    if (selectedAgencies.length < 8) {
                        selectedAgencies.push(agencyName);
                    } else {
                        alert('‚ùå M√°ximo 8 agencias pueden ser seleccionadas para comparaci√≥n');
                        return;
                    }
                }
                updateAgenciesCheckboxes();
                updateSummaryStats();
            }
            
            function toggleMonth(month) {
                if (selectedMonths.includes(month)) {
                    selectedMonths = selectedMonths.filter(m => m !== month);
                } else {
                    selectedMonths.push(month);
                }
                updateMonthsCheckboxes();
                updateSummaryStats();
            }
            
            function selectAllAgencies() {
                selectedAgencies = loadedData.map(agency => agency.agency);
                updateAgenciesCheckboxes();
                updateSummaryStats();
            }
            
            function deselectAllAgencies() {
                selectedAgencies = [];
                updateAgenciesCheckboxes();
                updateSummaryStats();
            }
            
            function updateAnalysis() {
                if (selectedAgencies.length === 0) {
                    alert('‚ö†Ô∏è Por favor selecciona al menos una agencia');
                    return;
                }
                if (selectedMonths.length === 0) {
                    alert('‚ö†Ô∏è Por favor selecciona al menos un mes');
                    return;
                }
                
                updateTable();
                showStatus('success', `‚úÖ An√°lisis actualizado: ${selectedAgencies.length} agencias y ${selectedMonths.length} meses seleccionados`);
            }
            
            function updateSummaryStats() {
                document.getElementById('totalKPIs').textContent = allKPIs.length;
                document.getElementById('totalAgencies').textContent = selectedAgencies.length;
                document.getElementById('totalPeriods').textContent = selectedMonths.length;
            }
            
            function showStatus(type, message) {
                const statusDiv = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                
                statusDiv.className = `bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-50 border border-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-200 rounded-lg p-4 mb-6`;
                statusText.textContent = message;
                statusDiv.classList.remove('hidden');
            }
            
            function showConnectionResult(type, message) {
                const resultDiv = document.getElementById('connectionResult');
                resultDiv.className = `p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                resultDiv.textContent = message;
                resultDiv.classList.remove('hidden');
            }
            
            function showFileResult(type, message) {
                const resultDiv = document.getElementById('fileResult');
                resultDiv.className = `p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                resultDiv.textContent = message;
                resultDiv.classList.remove('hidden');
            },
                        { 
                            name: 'Leads Generados', 
                            Enero: 45, Febrero: 52, Marzo: 48, Abril: 55, Mayo: 62, Junio: 58,
                            Julio: 60, Agosto: 54, Septiembre: 59, Octubre: 56, Noviembre: 65, Diciembre: 70
                        },
                        { 
                            name: 'Conversi√≥n %', 
                            Enero: 12.5, Febrero: 15.2, Marzo: 14.8, Abril: 16.1, Mayo: 18.3, Junio: 17.2,
                            Julio: 19.0, Agosto: 16.8, Septiembre: 17.9, Octubre: 18.1, Noviembre: 19.8, Diciembre: 21.2
                        }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                },
                {
                    agency: 'KIA Interlomas (DEMO)',
                    kpis: [
                        { 
                            name: 'Ventas Totales', 
                            Enero: 120, Febrero: 160, Marzo: 190, Abril: 145, Mayo: 200, Junio: 175,
                            Julio: 195, Agosto: 170, Septiembre: 185, Octubre: 180, Noviembre: 210, Diciembre: 220
                        },
                        { 
                            name: 'Leads Generados', 
                            Enero: 40, Febrero: 48, Marzo: 55, Abril: 52, Mayo: 58, Junio: 54,
                            Julio: 56, Agosto: 50, Septiembre: 53, Octubre: 51, Noviembre: 60, Diciembre: 65
                        },
                        { 
                            name: 'Conversi√≥n %', 
                            Enero: 10.8, Febrero: 13.7, Marzo: 16.2, Abril: 14.5, Mayo: 17.1, Junio: 15.8,
                            Julio: 16.9, Agosto: 15.2, Septiembre: 16.5, Octubre: 15.9, Noviembre: 18.3, Diciembre: 19.1
                        }
                    ],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                }
            ];
            
            displayResults(demoData);
            showStatus('success', '‚úÖ Datos de demostraci√≥n cargados correctamente - Estructura: KPI,Enero,Febrero,Marzo...');
        }
        
        // Google Sheets API Functions
        function connectWithAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            // Check if data is already loaded from session
            const savedData = sessionStorage.getItem('daytonaDashboardData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    displayResults(parsedData);
                    showAPIConnectionResult('success', `‚úÖ Datos cargados desde sesi√≥n: ${parsedData.length} agencias`);
                    showStatus('success', `‚úÖ Datos disponibles desde sesi√≥n anterior`);
                    return;
                } catch (error) {
                    console.log('No se pudieron cargar datos de sesi√≥n:', error);
                }
            }
            
            if (!apiKey) {
                alert('‚ùå Clave API requerida. Contacta al administrador para obtenerla.');
                return;
            }
            
            if (!spreadsheetId) {
                alert('‚ùå Por favor ingresa el ID del Google Sheets');
                return;
            }
            
            showStatus('loading', 'üîÑ Conectando con Google Sheets API...');
            showAPIConnectionResult('loading', 'üîÑ Conectando con API...');
            
            performAPIConnection(apiKey, spreadsheetId);
        }
        
        async function performAPIConnection(apiKey, spreadsheetId) {
            try {
                console.log('üîë Usando API Key:', apiKey.substring(0, 20) + '...');
                console.log('üÜî Spreadsheet ID:', spreadsheetId);
                
                // Get spreadsheet metadata to find all sheets
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
                console.log('üì° Obteniendo metadata:', metadataUrl);
                
                const metadataResponse = await fetch(metadataUrl);
                if (!metadataResponse.ok) {
                    const errorText = await metadataResponse.text();
                    console.error('‚ùå Error metadata:', errorText);
                    throw new Error(`Error de API (${metadataResponse.status}): Verifica que la clave API sea correcta y que el Google Sheets sea p√∫blico.`);
                }
                
                const metadata = await metadataResponse.json();
                console.log('üìä Metadata recibida:', metadata);
                
                const sheets = metadata.sheets || [];
                const sheetNames = sheets.map(sheet => sheet.properties.title);
                console.log('üìã Hojas encontradas:', sheetNames);
                
                // Filter to expected agency names (8 agencias)
                const expectedAgencies = [
                    'GWM Iztapalapa', 'GWM Morelos', 'Honda Cuajimalpa', 'Honda Interlomas', 
                    'KIA Interlomas', 'KIA Iztapalapa', 'MG Cuajimalpa', 'MG Interlomas'
                ];
                
                const availableSheets = sheetNames.filter(name => 
                    expectedAgencies.includes(name) || 
                    expectedAgencies.some(agency => name.includes(agency.split(' ')[0]))
                );
                
                console.log('üéØ Hojas v√°lidas encontradas:', availableSheets);
                
                if (availableSheets.length === 0) {
                    throw new Error(`No se encontraron hojas con nombres esperados.\n\nHojas disponibles: ${sheetNames.join(', ')}\n\nHojas esperadas: ${expectedAgencies.join(', ')}`);
                }
                
                // Fetch data from each sheet
                const loadedAgencies = [];
                const errors = [];
                const successes = [];
                
                for (const sheetName of availableSheets) {
                    try {
                        console.log(`üìä Cargando datos de: ${sheetName}`);
                        
                        // Get data from sheet (A:Z to cover all columns)
                        const range = `${sheetName}!A:Z`;
                        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
                        
                        console.log(`üîó URL datos: ${dataUrl}`);
                        
                        const dataResponse = await fetch(dataUrl);
                        if (!dataResponse.ok) {
                            const errorText = await dataResponse.text();
                            console.error(`‚ùå Error ${sheetName}:`, errorText);
                            errors.push(`${sheetName}: Error ${dataResponse.status}`);
                            continue;
                        }
                        
                        const sheetData = await dataResponse.json();
                        console.log(`üìà Datos de ${sheetName}:`, sheetData);
                        
                        if (!sheetData.values || sheetData.values.length < 2) {
                            errors.push(`${sheetName}: Sin datos suficientes`);
                            continue;
                        }
                        
                        // Convert array format to object format
                        const headers = sheetData.values[0];
                        const rows = sheetData.values.slice(1);
                        
                        const objectData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        console.log(`üìã Headers de ${sheetName}:`, headers);
                        console.log(`üìä Filas procesadas de ${sheetName}:`, objectData.length);
                        
                        // Process the data
                        const processedData = processCSVData(objectData, sheetName);
                        if (processedData && processedData.kpis.length > 0) {
                            loadedAgencies.push(processedData);
                            successes.push(`‚úÖ ${sheetName}: ${processedData.kpis.length} KPIs, ${processedData.months.length} meses`);
                        } else {
                            errors.push(`${sheetName}: No se pudieron procesar los KPIs`);
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå Error procesando ${sheetName}:`, error);
                        errors.push(`${sheetName}: ${error.message}`);
                    }
                }
                
                console.log('üìà Resumen API:', { 
                    exitosos: successes.length, 
                    errores: errors.length,
                    total: loadedAgencies.length 
                });
                
                if (loadedAgencies.length > 0) {
                    // Save data to session storage
                    sessionStorage.setItem('daytonaDashboardData', JSON.stringify(loadedAgencies));
                    
                    displayResults(loadedAgencies);
                    showAPIConnectionResult('success', `‚úÖ ${loadedAgencies.length} agencias cargadas via API`);
                    showStatus('success', `‚úÖ Conexi√≥n API exitosa: ${loadedAgencies.length} agencias procesadas`);
                    
                    let message = `üéâ ¬°CONEXI√ìN API EXITOSA!\n\nüìä Agencias cargadas via Google Sheets API:\n${successes.join('\n')}`;
                    
                    if (errors.length > 0) {
                        message += `\n\n‚ö†Ô∏è Advertencias:\n${errors.slice(0, 3).join('\n')}`;
                        if (errors.length > 3) message += `\n... y ${errors.length - 3} m√°s`;
                    }
                    
                    message += `\n\nüîÑ Los datos se actualizar√°n autom√°ticamente cuando cambies tu Google Sheets.`;
                    message += `\nüíæ Los datos se guardan en la sesi√≥n hasta que cierres el navegador.`;
                    
                    alert(message);
                } else {
                    throw new Error(`No se pudieron cargar datos via API.\n\nErrores:\n${errors.join('\n')}\n\nVerifica:\n1. La clave API sea correcta\n2. El Google Sheets sea p√∫blico\n3. Las hojas tengan nombres correctos`);
                }
                
            } catch (error) {
                console.error('üí• Error API completo:', error);
                showAPIConnectionResult('error', `‚ùå Error API: ${error.message}`);
                showStatus('error', `‚ùå Error de conexi√≥n API: ${error.message}`);
                
                // If API fails, load demo data as fallback
                console.log('üéØ API fall√≥, cargando datos de demostraci√≥n...');
                showStatus('loading', 'üîÑ Cargando datos de demostraci√≥n...');
                setTimeout(() => {
                    loadDemoDataAdvanced();
                }, 1000);
            }
        }
                
                // Get spreadsheet metadata to find all sheets
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`;
                console.log('üì° Obteniendo metadata:', metadataUrl);
                
                const metadataResponse = await fetch(metadataUrl);
                if (!metadataResponse.ok) {
                    const errorText = await metadataResponse.text();
                    console.error('‚ùå Error metadata:', errorText);
                    throw new Error(`Error de API (${metadataResponse.status}): Verifica que la clave API sea correcta y que el Google Sheets sea p√∫blico.`);
                }
                
                const metadata = await metadataResponse.json();
                console.log('üìä Metadata recibida:', metadata);
                
                const sheets = metadata.sheets || [];
                const sheetNames = sheets.map(sheet => sheet.properties.title);
                console.log('üìã Hojas encontradas:', sheetNames);
                
                // Filter to expected agency names (8 agencias)
                const expectedAgencies = [
                    'GWM Iztapalapa', 'GWM Morelos', 'Honda Cuajimalpa', 'Honda Interlomas', 
                    'KIA Interlomas', 'KIA Iztapalapa', 'MG Cuajimalpa', 'MG Interlomas'
                ];
                
                const availableSheets = sheetNames.filter(name => 
                    expectedAgencies.includes(name) || 
                    expectedAgencies.some(agency => name.includes(agency.split(' ')[0]))
                );
                
                console.log('üéØ Hojas v√°lidas encontradas:', availableSheets);
                
                if (availableSheets.length === 0) {
                    throw new Error(`No se encontraron hojas con nombres esperados.\n\nHojas disponibles: ${sheetNames.join(', ')}\n\nHojas esperadas: ${expectedAgencies.join(', ')}`);
                }
                
                // Fetch data from each sheet
                const loadedAgencies = [];
                const errors = [];
                const successes = [];
                
                for (const sheetName of availableSheets) {
                    try {
                        console.log(`üìä Cargando datos de: ${sheetName}`);
                        
                        // Get data from sheet (A:Z to cover all columns)
                        const range = `${sheetName}!A:Z`;
                        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
                        
                        console.log(`üîó URL datos: ${dataUrl}`);
                        
                        const dataResponse = await fetch(dataUrl);
                        if (!dataResponse.ok) {
                            const errorText = await dataResponse.text();
                            console.error(`‚ùå Error ${sheetName}:`, errorText);
                            errors.push(`${sheetName}: Error ${dataResponse.status}`);
                            continue;
                        }
                        
                        const sheetData = await dataResponse.json();
                        console.log(`üìà Datos de ${sheetName}:`, sheetData);
                        
                        if (!sheetData.values || sheetData.values.length < 2) {
                            errors.push(`${sheetName}: Sin datos suficientes`);
                            continue;
                        }
                        
                        // Convert array format to object format
                        const headers = sheetData.values[0];
                        const rows = sheetData.values.slice(1);
                        
                        const objectData = rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        console.log(`üìã Headers de ${sheetName}:`, headers);
                        console.log(`üìä Filas procesadas de ${sheetName}:`, objectData.length);
                        
                        // Process the data
                        const processedData = processCSVData(objectData, sheetName);
                        if (processedData && processedData.kpis.length > 0) {
                            loadedAgencies.push(processedData);
                            successes.push(`‚úÖ ${sheetName}: ${processedData.kpis.length} KPIs, ${processedData.months.length} meses`);
                        } else {
                            errors.push(`${sheetName}: No se pudieron procesar los KPIs`);
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå
