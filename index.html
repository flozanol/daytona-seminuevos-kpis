<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIs Seminuevos - Grupo Daytona</title>
    
    <!-- React y librerÃ­as -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos -->
    <script>
        // Iconos simplificados inline
        window.Icons = {
            BarChart3: () => React.createElement('svg', { 
                width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M3 3v18h18' }),
                React.createElement('path', { d: 'M18 17V9' }),
                React.createElement('path', { d: 'M13 17V5' }),
                React.createElement('path', { d: 'M8 17v-3' })
            ),
            Upload: () => React.createElement('svg', { 
                width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                React.createElement('polyline', { points: '17,8 12,3 7,8' }),
                React.createElement('line', { x1: 12, y1: 3, x2: 12, y2: 15 })
            ),
            Link: () => React.createElement('svg', { 
                width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71' }),
                React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71' })
            ),
            Building2: () => React.createElement('svg', { 
                width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z' }),
                React.createElement('path', { d: 'M6 12H4a2 2 0 0 0-2 2v8h4' }),
                React.createElement('path', { d: 'M18 9h2a2 2 0 0 1 2 2v11h-4' }),
                React.createElement('path', { d: 'M10 6h4' }),
                React.createElement('path', { d: 'M10 10h4' }),
                React.createElement('path', { d: 'M10 14h4' }),
                React.createElement('path', { d: 'M10 18h4' })
            ),
            Calendar: () => React.createElement('svg', { 
                width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('rect', { x: 3, y: 4, width: 18, height: 18, rx: 2, ry: 2 }),
                React.createElement('line', { x1: 16, y1: 2, x2: 16, y2: 6 }),
                React.createElement('line', { x1: 8, y1: 2, x2: 8, y2: 6 }),
                React.createElement('line', { x1: 3, y1: 10, x2: 21, y2: 10 })
            ),
            FileSpreadsheet: () => React.createElement('svg', { 
                width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
                React.createElement('polyline', { points: '14,2 14,8 20,8' }),
                React.createElement('path', { d: 'M8 13h2' }),
                React.createElement('path', { d: 'M14 13h2' }),
                React.createElement('path', { d: 'M8 17h2' }),
                React.createElement('path', { d: 'M14 17h2' })
            ),
            TrendingUp: () => React.createElement('svg', { 
                width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('polyline', { points: '22,7 13.5,15.5 8.5,10.5 2,17' }),
                React.createElement('polyline', { points: '16,7 22,7 22,13' })
            ),
            X: () => React.createElement('svg', { 
                width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('line', { x1: 18, y1: 6, x2: 6, y2: 18 }),
                React.createElement('line', { x1: 6, y1: 6, x2: 18, y2: 18 })
            ),
            RefreshCw: () => React.createElement('svg', { 
                width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('path', { d: 'M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8' }),
                React.createElement('path', { d: 'M21 3v5h-5' }),
                React.createElement('path', { d: 'M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16' }),
                React.createElement('path', { d: 'M8 16l-5-5 5-5' })
            ),
            AlertCircle: () => React.createElement('svg', { 
                width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 
            }, 
                React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
                React.createElement('line', { x1: 12, y1: 8, x2: 12, y2: 12 }),
                React.createElement('line', { x1: 12, y1: 16, x2: 12.01, y2: 16 })
            )
        };
    </script>
    
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzFGMjkzNyIvPgo8cGF0aCBkPSJNOCAxNkgyNE04IDE2QzggMTMuNzkwOSA5Ljc5MDg2IDEyIDEyIDEySDIwQzIyLjIwOTEgMTIgMjQgMTMuNzkwOSAyNCAxNlMyMi4yMDkxIDIwIDIwIDIwSDEyQzkuNzkwODYgMjAgOCAxOC4yMDkxIDggMTZaIiBzdHJva2U9IiNGRjY1MDAiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4K">
    <meta name="description" content="Dashboard interactivo de KPIs para agencias de seminuevos de Grupo Daytona">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, LineChart, Line, ResponsiveContainer } = Recharts;

        const KPIAnalyzer = () => {
          const [agencies, setAgencies] = useState([]);
          const [selectedAgencies, setSelectedAgencies] = useState([]);
          const [selectedMonths, setSelectedMonths] = useState([]);
          const [loading, setLoading] = useState(false);
          const [allKPIs, setAllKPIs] = useState([]);
          const [allMonths, setAllMonths] = useState([]);
          const [googleSheetsUrl, setGoogleSheetsUrl] = useState('');
          const [connectionStatus, setConnectionStatus] = useState('');

          const extractSpreadsheetId = (url) => {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
          };

          const fetchGoogleSheet = async (spreadsheetId, sheetName) => {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&sheet=${encodeURIComponent(sheetName)}`;
            
            try {
              const response = await fetch(csvUrl);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const csvText = await response.text();
              if (csvText.includes('<!DOCTYPE html>') || csvText.includes('<html')) {
                throw new Error(`La hoja "${sheetName}" no existe o no es accesible`);
              }
              
              return csvText;
            } catch (error) {
              throw new Error(`No se pudo cargar la hoja "${sheetName}": ${error.message}`);
            }
          };

          const processParsedData = (data, agencyName) => {
            if (!data || data.length === 0) {
              throw new Error(`La hoja "${agencyName}" estÃ¡ vacÃ­a`);
            }

            const headers = Object.keys(data[0]);
            const kpiColumn = headers.find(h => 
              h.toLowerCase().includes('kpi') || 
              h.toLowerCase().includes('indicador') ||
              h.toLowerCase().includes('metrica') ||
              h.toLowerCase().includes('metric')
            );
            
            if (!kpiColumn) {
              throw new Error(`No se encontrÃ³ una columna de KPIs en "${agencyName}"`);
            }

            const monthColumns = headers.filter(header => {
              const monthRegex = /(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|\d{1,2}\/\d{4}|\d{4}-\d{2})/i;
              return monthRegex.test(header) || /^(Q[1-4]|T[1-4])/.test(header);
            });

            if (monthColumns.length === 0) {
              throw new Error(`No se encontraron columnas de meses en "${agencyName}"`);
            }

            const monthlyData = {};
            const kpis = [];

            data.forEach(row => {
              const kpiName = row[kpiColumn];
              if (kpiName && kpiName.toString().trim() !== '' && kpiName.toString().trim() !== 'undefined') {
                kpis.push(kpiName.toString().trim());
                monthlyData[kpiName] = {};
                
                monthColumns.forEach(month => {
                  const value = row[month];
                  monthlyData[kpiName][month] = value ? parseFloat(value.toString().replace(/[,%$]/g, '')) || 0 : 0;
                });
              }
            });

            return {
              name: agencyName,
              kpis,
              months: monthColumns,
              monthlyData,
              fileName: agencyName
            };
          };

          const connectToGoogleSheets = async () => {
            if (!googleSheetsUrl.trim()) {
              alert('Por favor ingresa la URL del Google Sheets');
              return;
            }

            const spreadsheetId = extractSpreadsheetId(googleSheetsUrl);
            if (!spreadsheetId) {
              alert('âŒ URL invÃ¡lida. AsegÃºrate de usar una URL vÃ¡lida de Google Sheets');
              return;
            }

            setLoading(true);
            setConnectionStatus('loading');
            
            try {
              const expectedAgencies = [
                'GWM Iztapalapa', 'GWM Morelos', 'Honda Cuajimalpa', 'Honda Interlomas', 
                'KIA Interlomas', 'KIA Iztapalapa', 'MG Cuajimalpa', 'MG Interlomas', 'MG Iztapalapa'
              ];

              const loadedAgencies = [];
              const allKPIsSet = new Set();
              const allMonthsSet = new Set();
              const errors = [];
              const successes = [];

              for (const agencyName of expectedAgencies) {
                try {
                  const csvData = await fetchGoogleSheet(spreadsheetId, agencyName);
                  
                  if (csvData && csvData.trim().length > 0) {
                    const parsedData = Papa.parse(csvData, {
                      header: true,
                      skipEmptyLines: true,
                      transformHeader: (header) => header.trim(),
                      delimiter: ','
                    });

                    if (parsedData.data && parsedData.data.length > 0) {
                      const processedData = processParsedData(parsedData.data, agencyName);
                      loadedAgencies.push(processedData);
                      
                      processedData.kpis.forEach(kpi => allKPIsSet.add(kpi));
                      processedData.months.forEach(month => allMonthsSet.add(month));
                      
                      successes.push(`âœ… ${agencyName}: ${processedData.kpis.length} KPIs, ${processedData.months.length} meses`);
                    } else {
                      errors.push(`âŒ ${agencyName}: Hoja vacÃ­a`);
                    }
                  } else {
                    errors.push(`âŒ ${agencyName}: Sin datos`);
                  }
                } catch (error) {
                  errors.push(`âŒ ${agencyName}: ${error.message}`);
                }
              }

              if (loadedAgencies.length === 0) {
                throw new Error(`âŒ No se pudo cargar ninguna hoja.\n\n${errors.join('\n')}\n\nVerifica que el documento sea pÃºblico y las hojas tengan nombres correctos.`);
              }

              setAgencies(loadedAgencies);
              setAllKPIs(Array.from(allKPIsSet));
              setAllMonths(Array.from(allMonthsSet));
              setSelectedAgencies(loadedAgencies.map(a => a.name));
              setSelectedMonths(Array.from(allMonthsSet).slice(0, 6));
              setConnectionStatus('success');
              
              alert(`ðŸŽ‰ Â¡CONEXIÃ“N EXITOSA!\n\n${successes.join('\n')}\n\n${errors.length > 0 ? '\nâš ï¸ Advertencias:\n' + errors.join('\n') : ''}`);

            } catch (error) {
              setConnectionStatus('error');
              alert(`âŒ Error: ${error.message}`);
            }
            
            setLoading(false);
          };

          const handleFileUpload = useCallback(async (files) => {
            if (!files || files.length === 0) return;

            setLoading(true);
            const newAgencies = [];

            try {
              for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const agencyName = file.name.split('.')[0];
                
                try {
                  const csvData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsText(file);
                  });
                  
                  const parsedData = Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.trim()
                  });

                  if (parsedData.data && parsedData.data.length > 0) {
                    const processedData = processParsedData(parsedData.data, agencyName);
                    newAgencies.push(processedData);
                  }
                } catch (error) {
                  alert(`Error procesando ${file.name}: ${error.message}`);
                }
              }

              if (newAgencies.length > 0) {
                setAgencies(newAgencies);
                const allKPIsSet = new Set();
                const allMonthsSet = new Set();
                newAgencies.forEach(agency => {
                  agency.kpis.forEach(kpi => allKPIsSet.add(kpi));
                  agency.months.forEach(month => allMonthsSet.add(month));
                });
                setAllKPIs(Array.from(allKPIsSet));
                setAllMonths(Array.from(allMonthsSet));
                setSelectedAgencies(newAgencies.map(a => a.name));
                setSelectedMonths(Array.from(allMonthsSet).slice(0, 6));
              }
            } catch (error) {
              alert('Error procesando archivos');
            }
            setLoading(false);
          }, []);

          const removeAgency = (agencyName) => {
            const updatedAgencies = agencies.filter(a => a.name !== agencyName);
            setAgencies(updatedAgencies);
            setSelectedAgencies(selectedAgencies.filter(name => name !== agencyName));
          };

          const colors = ['#DC2626', '#EA580C', '#D97706', '#CA8A04', '#65A30D', '#059669', '#0891B2', '#2563EB', '#7C3AED'];

          return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black p-6" },
            React.createElement('div', { className: "max-w-7xl mx-auto" },
              React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-2xl shadow-2xl border border-gray-200 p-8 mb-8" },
                React.createElement('div', { className: "text-center mb-8" },
                  React.createElement('h1', { className: "text-4xl font-bold text-gray-900 mb-4 flex items-center justify-center gap-3" },
                    React.createElement(Icons.BarChart3, { className: "text-red-500" }),
                    "KPIs Seminuevos - Grupo Daytona"
                  ),
                  React.createElement('p', { className: "text-gray-700 text-lg" }, "Conecta tu Google Sheets y genera comparativas automÃ¡ticas de tus agencias automotrices")
                ),

                React.createElement('div', { className: "mb-8" },
                  React.createElement('div', { className: "bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 mb-4" },
                    React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                      React.createElement(Icons.Link, { className: "text-green-600" }),
                      React.createElement('h3', { className: "font-semibold text-gray-800" }, "Conectar Google Sheets (RECOMENDADO)")
                    ),
                    React.createElement('div', { className: "text-sm text-gray-700 space-y-2 mb-4" },
                      React.createElement('p', null, React.createElement('strong', null, "ðŸ“‹ Paso 1:"), " Haz tu Google Sheets PÃšBLICO para lectura"),
                      React.createElement('p', null, React.createElement('strong', null, "ðŸ”— Paso 2:"), " Compartir â†’ Cualquier persona con el enlace â†’ Visor"),
                      React.createElement('p', null, React.createElement('strong', null, "ðŸ“ Paso 3:"), " Copia la URL de tu Google Sheets y pÃ©gala aquÃ­:")
                    ),
                    
                    React.createElement('div', { className: "flex gap-2" },
                      React.createElement('input', {
                        type: "text",
                        placeholder: "https://docs.google.com/spreadsheets/d/TU_SPREADSHEET_ID/edit",
                        value: googleSheetsUrl,
                        onChange: (e) => setGoogleSheetsUrl(e.target.value),
                        className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                      }),
                      React.createElement('button', {
                        onClick: connectToGoogleSheets,
                        disabled: loading,
                        className: "px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-lg"
                      },
                        loading ? 
                          React.createElement(React.Fragment, null,
                            React.createElement(Icons.RefreshCw, { className: "animate-spin" }),
                            "Conectando..."
                          ) :
                          React.createElement(React.Fragment, null,
                            React.createElement(Icons.Link),
                            "Conectar"
                          )
                      )
                    ),

                    connectionStatus === 'success' && React.createElement('div', { className: "mt-3 p-2 bg-green-100 border border-green-300 rounded text-green-800 text-sm flex items-center gap-2" },
                      React.createElement('div', { className: "w-2 h-2 bg-green-500 rounded-full" }),
                      `Conectado exitosamente - ${agencies.length} agencias cargadas`
                    ),

                    connectionStatus === 'error' && React.createElement('div', { className: "mt-3 p-2 bg-red-100 border border-red-300 rounded text-red-800 text-sm flex items-center gap-2" },
                      React.createElement(Icons.AlertCircle),
                      "Error de conexiÃ³n - Verifica que el documento sea pÃºblico"
                    )
                  ),

                  React.createElement('div', { className: "mb-8" },
                    React.createElement('label', { className: "flex flex-col items-center justify-center w-full h-32 border-2 border-red-300 border-dashed rounded-xl cursor-pointer bg-gradient-to-r from-orange-50 to-red-50 hover:from-orange-100 hover:to-red-100 transition-colors" },
                      React.createElement('div', { className: "flex flex-col items-center justify-center pt-5 pb-6" },
                        React.createElement(Icons.Upload, { className: "w-10 h-10 mb-3 text-red-500" }),
                        React.createElement('p', { className: "mb-2 text-sm text-red-600" },
                          React.createElement('span', { className: "font-semibold" }, "Clic para subir"), " archivos CSV de agencias"
                        ),
                        React.createElement('p', { className: "text-xs text-red-500" }, "CSV - MÃºltiples archivos permitidos")
                      ),
                      React.createElement('input', {
                        type: "file",
                        className: "hidden",
                        accept: ".csv",
                        multiple: true,
                        onChange: (e) => handleFileUpload(e.target.files)
                      })
                    )
                  )
                ),

                agencies.length > 0 && React.createElement('div', { className: "space-y-8" },
                  React.createElement('div', { className: "mb-8" },
                    React.createElement('h3', { className: "text-lg font-semibold mb-4 flex items-center gap-2" },
                      React.createElement(Icons.Building2, { className: "text-red-500" }),
                      `Agencias Cargadas (${agencies.length}/9)`
                    ),
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                      agencies.map((agency, index) => 
                        React.createElement('div', { 
                          key: agency.name, 
                          className: "bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-4 relative border-l-4 shadow-md",
                          style: { borderLeftColor: colors[index % colors.length] }
                        },
                          React.createElement('button', {
                            onClick: () => removeAgency(agency.name),
                            className: "absolute top-2 right-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full p-1"
                          },
                            React.createElement(Icons.X)
                          ),
                          React.createElement('div', { className: "flex items-center mb-2" },
                            React.createElement('div', { 
                              className: "w-3 h-3 rounded-full mr-2",
                              style: { backgroundColor: colors[index % colors.length] }
                            }),
                            React.createElement('h4', { className: "font-semibold text-gray-800 pr-6" }, agency.name)
                          ),
                          React.createElement('p', { className: "text-sm text-gray-600" }, `${agency.kpis.length} KPIs`),
                          React.createElement('p', { className: "text-sm text-gray-600" }, `${agency.months.length} meses`)
                        )
                      )
                    )
                  ),

                  loading && React.createElement('div', { className: "text-center py-8" },
                    React.createElement('div', { className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-600" }),
                    React.createElement('p', { className: "mt-2 text-gray-600" }, "Procesando datos...")
                  ),

                  // ConfiguraciÃ³n
                  React.createElement('div', { className: "bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 border border-gray-200" },
                    React.createElement('h3', { className: "text-xl font-semibold mb-4 flex items-center gap-2" },
                      React.createElement(Icons.FileSpreadsheet, { className: "text-red-500" }),
                      "ConfiguraciÃ³n de AnÃ¡lisis"
                    ),
                    
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                      React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                          React.createElement(Icons.Building2, { className: "inline mr-1" }),
                          `Agencias (${selectedAgencies.length}/9)`
                        ),
                        React.createElement('div', { className: "max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white shadow-inner" },
                          React.createElement('div', { className: "mb-2 pb-2 border-b border-gray-200" },
                            React.createElement('button', {
                              onClick: () => setSelectedAgencies(agencies.map(a => a.name)),
                              className: "text-xs text-red-600 hover:text-red-800 mr-2 font-medium"
                            }, "Seleccionar todas"),
                            React.createElement('button', {
                              onClick: () => setSelectedAgencies([]),
                              className: "text-xs text-gray-600 hover:text-gray-800 font-medium"
                            }, "Deseleccionar todas")
                          ),
                          agencies.map((agency, index) => 
                            React.createElement('label', { 
                              key: agency.name, 
                              className: "flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-2 rounded" 
                            },
                              React.createElement('input', {
                                type: "checkbox",
                                checked: selectedAgencies.includes(agency.name),
                                onChange: (e) => {
                                  if (e.target.checked) {
                                    if (selectedAgencies.length < 9) {
                                      setSelectedAgencies([...selectedAgencies, agency.name]);
                                    } else {
                                      alert('MÃ¡ximo 9 agencias pueden ser seleccionadas para comparaciÃ³n');
                                    }
                                  } else {
                                    setSelectedAgencies(selectedAgencies.filter(a => a !== agency.name));
                                  }
                                },
                                className: "rounded text-red-600 focus:ring-red-500"
                              }),
                              React.createElement('div', { 
                                className: "w-3 h-3 rounded-full",
                                style: { backgroundColor: colors[index % colors.length] }
                              }),
                              React.createElement('span', { className: "flex-1" }, agency.name)
                            )
                          )
                        )
                      ),

                      React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" },
                          React.createElement(Icons.Calendar, { className: "inline mr-1" }),
                          `Meses (${selectedMonths.length})`
                        ),
                        React.createElement('div', { className: "max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-white" },
                          allMonths.map(month => 
                            React.createElement('label', { 
                              key: month, 
                              className: "flex items-center space-x-2 text-sm mb-2 cursor-pointer hover:bg-orange-50 p-1 rounded" 
                            },
                              React.createElement('input', {
                                type: "checkbox",
                                checked: selectedMonths.includes(month),
                                onChange: (e) => {
                                  if (e.target.checked) {
                                    setSelectedMonths([...selectedMonths, month]);
                                  } else {
                                    setSelectedMonths(selectedMonths.filter(m => m !== month));
                                  }
                                },
                                className: "rounded text-red-600 focus:ring-red-500"
                              }),
                              React.createElement('span', { className: "flex-1" }, month)
                            )
                          )
                        )
                      )
                    )
                  ),

                  // Tabla de KPIs
                  allKPIs.length > 0 && selectedAgencies.length > 0 && React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                    React.createElement('div', { className: "flex items-center justify-between mb-4" },
                      React.createElement('h3', { className: "text-xl font-semibold flex items-center gap-2" },
                        React.createElement(Icons.FileSpreadsheet, { className: "text-red-500" }),
                        "Comparativa de KPIs por Agencia"
                      ),
                      React.createElement('div', { className: "text-sm text-gray-600" },
                        `${selectedAgencies.length} de ${agencies.length} agencias | ${selectedMonths.length} meses | ${allKPIs.length} KPIs`
                      )
                    ),
                    React.createElement('div', { className: "overflow-auto max-h-96" },
                      React.createElement('table', { className: "min-w-full divide-y divide-gray-200" },
                        React.createElement('thead', { className: "bg-gray-50" },
                          React.createElement('tr', null,
                            React.createElement('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "KPI"),
                            React.createElement('th', { className: "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" }, "Mes"),
                            selectedAgencies.map((agency, index) => 
                              React.createElement('th', { 
                                key: agency, 
                                className: "px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",
                                style: { backgroundColor: colors[index % colors.length] + '20' }
                              }, agency)
                            )
                          )
                        ),
                        React.createElement('tbody', { className: "bg-white divide-y divide-gray-200" },
                          allKPIs.map(kpi => 
                            selectedMonths.map((month, monthIndex) => 
                              React.createElement('tr', { 
                                key: `${kpi}-${month}`, 
                                className: monthIndex % 2 === 0 ? 'bg-white' : 'bg-amber-50' 
                              },
                                React.createElement('td', { className: "px-4 py-4 text-sm font-medium text-gray-800" }, kpi),
                                React.createElement('td', { className: "px-4 py-4 text-sm text-gray-800 font-medium" }, month),
                                selectedAgencies.map((agencyName) => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const value = agency?.monthlyData[kpi]?.[month] || 0;
                                  const isHighest = selectedAgencies.length > 1 && value > 0 && 
                                    value === Math.max(...selectedAgencies.map(an => {
                                      const ag = agencies.find(a => a.name === an);
                                      return ag?.monthlyData[kpi]?.[month] || 0;
                                    }));
                                  
                                  return React.createElement('td', { 
                                    key: agencyName, 
                                    className: `px-4 py-4 text-center text-sm font-semibold ${isHighest ? 'bg-green-100 text-green-800' : 'text-gray-900'}` 
                                  }, value.toLocaleString());
                                })
                              )
                            )
                          )
                        )
                      )
                    ),
                    
                    React.createElement('div', { className: "mt-6 grid grid-cols-1 md:grid-cols-3 gap-4" },
                      React.createElement('div', { className: "bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border border-red-200" },
                        React.createElement('h4', { className: "font-medium text-red-800 mb-2" }, "Total de KPIs"),
                        React.createElement('p', { className: "text-2xl font-bold text-red-600" }, allKPIs.length)
                      ),
                      React.createElement('div', { className: "bg-gradient-to-r from-amber-50 to-yellow-50 p-4 rounded-lg border border-amber-200" },
                        React.createElement('h4', { className: "font-medium text-amber-800 mb-2" }, "Agencias Analizadas"),
                        React.createElement('p', { className: "text-2xl font-bold text-amber-600" }, selectedAgencies.length)
                      ),
                      React.createElement('div', { className: "bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200" },
                        React.createElement('h4', { className: "font-medium text-orange-800 mb-2" }, "PerÃ­odos Analizados"),
                        React.createElement('p', { className: "text-2xl font-bold text-orange-600" }, selectedMonths.length)
                      )
                    )
                  ),

                  // GrÃ¡ficos
                  allKPIs.length > 0 && selectedAgencies.length > 0 && React.createElement('div', { className: "space-y-8" },
                    React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                      React.createElement('h3', { className: "text-xl font-semibold mb-6 flex items-center gap-2" },
                        React.createElement(Icons.TrendingUp, { className: "text-red-500" }),
                        "Comparativa de KPIs por Agencia"
                      ),
                      React.createElement('div', { className: "h-96" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(BarChart, { 
                            data: (() => {
                              const chartData = [];
                              allKPIs.slice(0, 6).forEach(kpi => {
                                const kpiData = { kpi: kpi.substring(0, 25) + (kpi.length > 25 ? '...' : '') };
                                selectedAgencies.forEach(agencyName => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const totalValue = selectedMonths.reduce((sum, month) => {
                                    return sum + (agency?.monthlyData[kpi]?.[month] || 0);
                                  }, 0);
                                  kpiData[agencyName] = totalValue;
                                });
                                chartData.push(kpiData);
                              });
                              return chartData;
                            })(),
                            margin: { top: 20, right: 30, left: 20, bottom: 80 }
                          },
                            React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                            React.createElement(XAxis, { dataKey: "kpi", angle: -45, textAnchor: "end", height: 100 }),
                            React.createElement(YAxis),
                            React.createElement(Tooltip),
                            React.createElement(Legend),
                            selectedAgencies.map((agency, index) => 
                              React.createElement(Bar, { 
                                key: agency, 
                                dataKey: agency,
                                name: agency,
                                fill: colors[index % colors.length]
                              })
                            )
                          )
                        )
                      )
                    ),

                    React.createElement('div', { className: "bg-gradient-to-r from-gray-50 via-amber-50 to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200" },
                      React.createElement('h3', { className: "text-xl font-semibold mb-6 flex items-center gap-2" },
                        React.createElement(Icons.TrendingUp, { className: "text-red-500" }),
                        "Tendencias Mensuales por Agencia"
                      ),
                      React.createElement('div', { className: "h-96" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(LineChart, { 
                            data: (() => {
                              const chartData = [];
                              selectedMonths.forEach(month => {
                                const monthData = { month };
                                selectedAgencies.forEach(agencyName => {
                                  const agency = agencies.find(a => a.name === agencyName);
                                  const monthTotal = allKPIs.reduce((sum, kpi) => {
                                    return sum + (agency?.monthlyData[kpi]?.[month] || 0);
                                  }, 0);
                                  monthData[agencyName] = monthTotal;
                                });
                                chartData.push(monthData);
                              });
                              return chartData;
                            })()
                          },
                            React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                            React.createElement(XAxis, { dataKey: "month" }),
                            React.createElement(YAxis),
                            React.createElement(Tooltip),
                            React.createElement(Legend),
                            selectedAgencies.map((agency, index) => 
                              React.createElement(Line, { 
                                key: agency,
                                type: "monotone", 
                                dataKey: agency, 
                                stroke: colors[index % colors.length],
                                strokeWidth: 3,
                                dot: { r: 6 }
                              })
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(KPIAnalyzer));
    </script>
</body>
</html>
